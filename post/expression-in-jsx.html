<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="description" content="Kelvin&#x27;s blog"/><link rel="icon" href="/images/favicon.ico"/><title>JSX 与 { 表达式 }</title><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/da306c35ecdc5418.css" as="style"/><link rel="stylesheet" href="/_next/static/css/da306c35ecdc5418.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-81f4fb35f4507347.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7b4daab53c85f4a6.js" defer=""></script><script src="/_next/static/chunks/39-1e17aeb5671a7eb7.js" defer=""></script><script src="/_next/static/chunks/pages/post/expression-in-jsx-b3ca189649d4343c.js" defer=""></script><script src="/_next/static/c2GhiWY6kwghUvrBPufbI/_buildManifest.js" defer=""></script><script src="/_next/static/c2GhiWY6kwghUvrBPufbI/_ssgManifest.js" defer=""></script><script src="/_next/static/c2GhiWY6kwghUvrBPufbI/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="container"><nav class="navbar"><div class="navbar-content"><div class="navbar-menu-container"><ul class="navbar-menu"><li><a class="active" href="/">首页</a></li><li><a href="/posts/horse-sense">秘籍</a></li><li><a href="/posts/gibberish">八股</a></li><li><a href="/posts/xray">庖丁</a></li><li><a href="/posts/copycat">画瓢</a></li></ul></div></div></nav><main class="main"><main><article class="post-container"><div class="post-title-container"><h1 class="post-title">JSX 与 { 表达式 }</h1><p class="post-date">MAY 17, 2022</p></div><p>偶然间在一个技术群里看到有人问，为什么在 React 里，处理点击事件的函数还没点击就执行了，而且只执行一次；另外，如果在这个函数外面再套一层箭头函数的话，它又正常了；还有就是在没有参数的情况下，也是正常的。大概就是下面的几种情况：</p><pre class="prism-code language-jsx"><code class="prism-code language-jsx"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// 只执行一次，并且还没点击就执行了</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Button</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript function">doSomething</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript">args</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 包一层箭头函数就正常了</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Button</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript arrow operator">=&gt;</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript function">doSomething</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript">args</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 没有参数的情况下，也是正常的</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Button</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript">doSomething</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span></div></div></code></pre><p>这个问题我也曾经遇到过，尤其是对于刚从 Vue 或者习惯写原生转过来写 React 的人来说，的确很容易搞混：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// 在 Vue 中是正常的</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token maybe-class-name">Button</span><span class="token plain"> @click</span><span class="token operator">=</span><span class="token string">&quot;doSomething(args)&quot;</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 在原生中是正常的</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token operator">&lt;</span><span class="token plain">button onclick</span><span class="token operator">=</span><span class="token string">&quot;doSomething(args)&quot;</span><span class="token operator">&gt;</span><span class="token plain">按钮</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">button</span><span class="token operator">&gt;</span></div></div></code></pre><p>那么为什么在 React 里（实际上只是 JSX，与框架无关），第一种写法只执行一次呢？其实这个问题产生的原因很简单，与框架一点关系都没有，只是一个很基础的 JS 问题。</p><p>在 React 官方<a href="https://reactjs.org/docs/introducing-jsx.html">介绍 JSX 的文档</a>中有如下一段：</p><blockquote><p>You can put any valid JavaScript expression inside the curly braces in JSX. For example, <code>2 + 2</code>, <code>user.firstName</code>, or <code>formatName(user)</code> are all valid JavaScript expressions.</p></blockquote><p>也就是说，JSX 的大括号里需要的是一个“表达式”，即<code>propA={表达式}</code>。而“表达式”和“语句”，是 JS 中两个比较容易混淆的概念。MDN 中对表达式是这样定义的：</p><blockquote><p>An expression is any valid unit of code that resolves to a value.</p></blockquote><p>因此，表达式和语句最大的区别，就是能不能计算出一个“值”来。其实 JSX 中<code>onClick={doSomething}</code>的部分，可以看作是一个赋值语句，即把大括号直接去掉：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// onClick={doSomething} 相当于：</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">onClick </span><span class="token operator">=</span><span class="token plain"> doSomething</span><span class="token punctuation">;</span></div></div></code></pre><p>也就是说在 JSX 中给 props 传值，其实就只是将等号右边，即大括号内的表达式的值，赋给左边的 props 这么简单而已。在上面的例子中就是把<code>onClick</code>指向<code>doSomething</code>这个函数。而当用户点击该组件时，框架会调用<code>onClick()</code>，也就相当于调用<code>doSomething()</code>。</p><p>而造成 bug 的原因，往往就是忽略了这是一个赋值的过程，错误地认为点击事件发生后，框架会去执行大括号内的“语句”。尤其对于习惯了 Vue 的人来说，因为在 Vue 的模板语法中，的确是按这个逻辑去执行的。</p><p>回到最上面的第一个例子：</p><pre class="prism-code language-jsx"><code class="prism-code language-jsx"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// 只执行一次，并且还没点击就执行了</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Button</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript function">doSomething</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript">args</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span></div></div></code></pre><p>这里之所以会执行一次，是因为在渲染的过程中，直接调用了<code>doSomething(args)</code>，并将其返回值赋值给了<code>onClick</code>。因此，在用户点击之前，事件处理的方法就已经被调用了。假设该方法并没有返回值，则<code>onClick</code>的值为<code>undefined</code>。</p><p>后续当用户点击该组件时，框架调用<code>onClick()</code>，并不会再次执行<code>doSomething()</code>方法。这是因为<code>onClick</code>的值为<code>undefined</code>，React 对其进行了防呆的处理，直接忽略而并不会在实际的 DOM 上添加事件监听。</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">/*</span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token comment">  packages/react-dom/src/events/getListener.js</span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token comment">  getListener() 方法中</span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token comment">*/</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">listener </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token keyword">typeof</span><span class="token plain"> listener </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">    </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Expected \`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">registrationName</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">\` listener to be a function, instead got a value of \`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation keyword">typeof</span><span class="token template-string interpolation"> listener</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">\` type.</span><span class="token template-string template-punctuation string">`</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">/*</span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token comment">  packages/react-dom/src/events/DOMPluginEventSystem.js</span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token comment">  accumulateSinglePhaseListeners() 方法中</span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token comment">*/</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// Standard React on* listeners, i.e. onClick or onClickCapture</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reactEventName </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> listener </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getListener</span><span class="token punctuation">(</span><span class="token plain">instance</span><span class="token punctuation">,</span><span class="token plain"> reactEventName</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">listener </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">    listeners</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">      </span><span class="token function">createDispatchListener</span><span class="token punctuation">(</span><span class="token plain">instance</span><span class="token punctuation">,</span><span class="token plain"> listener</span><span class="token punctuation">,</span><span class="token plain"> lastHostComponent</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>当我们传给 React 自带的合成事件（SyntheticEvent）的值不是一个函数时，框架将会报错。而如果传的值为 falsy，则该事件并不会被监听，直接忽略。</p><h2>小结</h2><p>JSX 的大括号里面要写“表达式”，对于事件来说，要的值是函数。<code>() =&gt; doSomething(args)</code>和<code>doSomething</code>都是函数，在事件触发的时候，调用的是事件（如<code>onClick()</code>)，而不是写在大括号里的“语句”。</p></article></main></main><footer><div>Build with ♥ @GZ</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/post/expression-in-jsx","query":{},"buildId":"c2GhiWY6kwghUvrBPufbI","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>