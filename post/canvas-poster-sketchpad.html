<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="description" content="Kelvin&#x27;s blog"/><link rel="icon" href="/images/favicon.ico"/><title>项目小结：基于 Canvas 的海报编辑小程序</title><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/da306c35ecdc5418.css" as="style"/><link rel="stylesheet" href="/_next/static/css/da306c35ecdc5418.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-81f4fb35f4507347.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7b4daab53c85f4a6.js" defer=""></script><script src="/_next/static/chunks/39-1e17aeb5671a7eb7.js" defer=""></script><script src="/_next/static/chunks/pages/post/canvas-poster-sketchpad-73fe20dcbdd48d89.js" defer=""></script><script src="/_next/static/c2GhiWY6kwghUvrBPufbI/_buildManifest.js" defer=""></script><script src="/_next/static/c2GhiWY6kwghUvrBPufbI/_ssgManifest.js" defer=""></script><script src="/_next/static/c2GhiWY6kwghUvrBPufbI/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="container"><nav class="navbar"><div class="navbar-content"><div class="navbar-menu-container"><ul class="navbar-menu"><li><a class="active" href="/">首页</a></li><li><a href="/posts/horse-sense">秘籍</a></li><li><a href="/posts/gibberish">八股</a></li><li><a href="/posts/xray">庖丁</a></li><li><a href="/posts/copycat">画瓢</a></li></ul></div></div></nav><main class="main"><main><article class="post-container"><div class="post-title-container"><h1 class="post-title">项目小结：基于 Canvas 的海报编辑小程序</h1><p class="post-date">May 6, 2022</p></div><p>之前接了个项目，一个学生的毕业设计，需要做一个简单的海报编辑小程序。海报编辑那部分，需求是要支持添加背景、图片素材、文字等，可以拖动、缩放。其实 GitHub 上有找到类似的，但为了学习，还是自己从零开始写起。项目是基于 Canvas 实现的，中间也踩了不少坑，记录在这里。</p><h2>Canvas 的尺寸问题</h2><h3>宽高</h3><p><code>&lt;canvas&gt;</code> 自身有 <code>width</code> 与 <code>height</code> 属性，表示其宽度，默认情况下为 <code>300px * 150px</code>。此外，通过 CSS 也可以设置 <code>&lt;canvas&gt;</code> 的宽高，但这两者的意义是不一样的。</p><p>CSS 控制的是 <code>&lt;canvas&gt;</code> 在页面中显示的实际大小，而 <code>&lt;canvas&gt;</code> 自身的宽高则是用来控制“画布”的大小。可以用一张放在桌面上的可伸缩的纸来表示这个关系：<code>&lt;canvas&gt;</code> 自身的宽高表示这张纸在未伸缩状态下的大小，而 CSS 的宽高则表示桌面的大小，<code>&lt;canvas&gt;</code> 会伸缩至填满整个桌面大小。</p><p>因此，我们需要保证通过 CSS 设置的大小与 <code>&lt;canvas&gt;</code> 自身的大小保持相同的比例，否则画出来的图像会被拉伸变形。</p><h3>缩放</h3><p>现在手机屏幕的分辨率越来越高，<code>1px</code> 实际上是由不只 1 个物理像素来进行显示，这个比例叫 DPR（Device Pixel Ratio）。比如 iPhone 12，屏幕的 CSS 宽度为 375px，其 DPR 为 3，即一个 CSS 像素由 3 个物理像素来表示。</p><p>如果我们把 <code>&lt;canvas&gt;</code> 的宽高均设置为 <code>375px</code>，那么实际上每个像素点所对应的将是 9 个物理像素，相当于被拉伸了 9 倍，显示上会很“模糊”。</p><p>所以，对于高分辨率手机来说，最好是将 <code>&lt;canvas&gt;</code> “放大”，使之大小与屏幕的实际分辨率对应，才能显示出“高清”的效果。</p><p>在小程序中，可以通过以下方法来设置：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">const</span><span class="token plain"> sysInfo </span><span class="token operator">=</span><span class="token plain"> wx</span><span class="token punctuation">.</span><span class="token method function property-access">getSystemInfoSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 缩放 canvas，保持与物理像素一致，保证图片的高清</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> dpr </span><span class="token operator">=</span><span class="token plain"> sysInfo</span><span class="token punctuation">.</span><span class="token property-access">pixelRatio</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">canvas</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> width </span><span class="token operator">*</span><span class="token plain"> dpr</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">canvas</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> height </span><span class="token operator">*</span><span class="token plain"> dpr</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 设置缩放因子，屏幕像素转为物理像素</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">.</span><span class="token method function property-access">scale</span><span class="token punctuation">(</span><span class="token plain">dpr</span><span class="token punctuation">,</span><span class="token plain"> dpr</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><h2>画布上的“元素”</h2><p>我们用一个类，<code>Graph</code>，来表示将要添加到画布上的元素，可以是图片或文字，它有以下属性：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// 坐标属性</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> x</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> y</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 元素的类型，&#x27;text&#x27;，&#x27;image&#x27;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> type</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 文本内容</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">text</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> text</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 字体大小</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fontSize</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fontSize</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 图片</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">image</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> image</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// canvas context</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> ctx</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 标记是否选中</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 元素的操作</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span></div></div></code></pre><p>另外，元素的宽高，则根据类型的不同，动态计算得到。对于图片类型的元素，在添加时需要进行缩放，以保证新添加的图片初始的大小统一。因为图片的比例不定，我们统一限制图片长边的长度，将图片按比例进行缩放，计算其宽高：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// 初始化图片，按比例缩放</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">type </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;image&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> width</span><span class="token punctuation">,</span><span class="token plain"> height </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> image</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> ratio </span><span class="token operator">=</span><span class="token plain"> width </span><span class="token operator">/</span><span class="token plain"> height</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 长边按比例缩放默认大小，且不能小于最小宽度</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">width </span><span class="token operator">&gt;=</span><span class="token plain"> height</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newHeight </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">DEFAULT_IMAGE_SIZE</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> ratio</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">newHeight </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> ratio</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">DEFAULT_IMAGE_SIZE</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newHeight</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newWidth </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">DEFAULT_IMAGE_SIZE</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> ratio</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">newWidth </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> ratio</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">DEFAULT_IMAGE_SIZE</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">DEFAULT_IMAGE_SIZE</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> ratio</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">centerX</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">26</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">centerY</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">27</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>对于文字类型的元素，则在每次绘制的时候，根据当前的字号大小，重新计算其宽高：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// 文本元素需要根据当前字号，重新计算各项属性值</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">.</span><span class="token property-access">font</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation keyword">this</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation property-access">fontSize</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">px sans-serif</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">.</span><span class="token property-access">textAlign</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;center&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">.</span><span class="token property-access">textBaseline</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;middle&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> textWidth </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">.</span><span class="token method function property-access">measureText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">text</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> textHeight </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fontSize</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> textWidth</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> textHeight</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">centerX</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">centerY</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span></div></div></code></pre><h2>让元素“动”起来</h2><p>上面说了，Canvas 就像一张纸，而纸上画的东西是固定的，怎样才能令到画布上的元素能够实现移动、缩放、选中等操作呢？</p><p><img src="/images/canvas-poster-sketchpad/frame.jpg" alt="帧"/></p><p>其实，电影的画面也是“静态”的，只是通过快速的切换不同的静态画面，从而产生“动”起来的错觉。比方说一只豹子，如果我们按每秒 30 帧的速率，在每一帧中，稍微改变豹的位置，使其往右移动 1 个像素，那么当这些静态的帧连续进行切换的时候，这只豹子看上去就是在往右移动了。</p><p>让 Canvas 上的元素动起来，原理也是一样。我们利用一个数组来记录所有添加到画布中的元素，当有新元素被添加进来时，或者这些元素的某些属性产生变化时（比如坐标移动大小改变等），就遍历一遍数组，把每个元素重新按顺序绘制出来。这样一来，Canvas 看上去，就是“动”的了。</p><h3>添加元素</h3><p>监听元素的改变，将新元素推入用于记录所有元素的数组中，并触发重绘，代码如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token literal-property property">observers</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 监听是否有新的元素添加进来</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">graph</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 添加新元素前，先重置所有已存在元素的选中状态</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">graphData</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 新增元素</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;image&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> image </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">canvas</span><span class="token punctuation">.</span><span class="token method function property-access">createImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">      image</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onload</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> graph </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Graph</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token plain">config</span><span class="token punctuation">,</span><span class="token plain"> image</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">graphData</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">graph</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">      image</span><span class="token punctuation">.</span><span class="token property-access">src</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> config</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> graph </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Graph</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">graphData</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">graph</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 监听背景是否有改变</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">background</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">url</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> image </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">canvas</span><span class="token punctuation">.</span><span class="token method function property-access">createImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">26</span><div class="token-line-content"><span class="token plain">    image</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onload</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">27</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">backgroundImage</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> image</span></div></div><div class="token-line"><span class="line-number">28</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">29</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">30</span><div class="token-line-content"><span class="token plain">    image</span><span class="token punctuation">.</span><span class="token property-access">src</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> url</span></div></div><div class="token-line"><span class="line-number">31</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">32</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>当监听到有变化时，调用的绘制函数代码如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 清空画布</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">.</span><span class="token method function property-access">clearRect</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">    </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">    </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">canvasSize</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">canvasSize</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 绘制背景</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">backgroundImage</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">scaleToFill</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">backgroundImage</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 绘制每个元素</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">graphData</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> graph</span><span class="token punctuation">.</span><span class="token method function property-access">draw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">icons</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><h3>选中元素</h3><p>要判断是否点击在了某个元素上，实际上是要判断点击位置的坐标，是否落在由元素四个角围成的矩形内。假设左上角为原点 <code>(x, y)</code>，宽高分别为 <code>width</code>、<code>height</code>，那么四个角的坐标分别可以表示为：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>左上：<code>(x, y)</code></div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>右上：<code>(x + width, y)</code></div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>右下：<code>(x + width, y + height)</code></div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>左下：<code>(x, y + height)</code></div></li></ul><p>封装成方法为：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token function">calculateCorners</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token parameter punctuation">,</span><span class="token parameter"> y</span><span class="token parameter punctuation">,</span><span class="token parameter"> width</span><span class="token parameter punctuation">,</span><span class="token parameter"> height</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">x</span><span class="token operator">:</span><span class="token plain"> x</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">y</span><span class="token operator">:</span><span class="token plain"> y </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">x</span><span class="token operator">:</span><span class="token plain"> x </span><span class="token operator">+</span><span class="token plain"> width</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">y</span><span class="token operator">:</span><span class="token plain"> y </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">x</span><span class="token operator">:</span><span class="token plain"> x </span><span class="token operator">+</span><span class="token plain"> width</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">y</span><span class="token operator">:</span><span class="token plain"> y </span><span class="token operator">+</span><span class="token plain"> height </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">x</span><span class="token operator">:</span><span class="token plain"> x </span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">y</span><span class="token operator">:</span><span class="token plain"> y </span><span class="token operator">+</span><span class="token plain"> height </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>我们把这四个角的坐标放到一个数组中保存，那么判断是否在区域内和选中状态的方法分别为：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token function">isInside</span><span class="token punctuation">(</span><span class="token parameter">points</span><span class="token parameter punctuation">,</span><span class="token parameter"> target</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> x</span><span class="token punctuation">,</span><span class="token plain"> y </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> target</span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> points</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token plain"> </span><span class="token operator">&lt;=</span><span class="token plain"> x </span><span class="token operator">&amp;&amp;</span><span class="token plain"> x </span><span class="token operator">&lt;=</span><span class="token plain"> points</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> points</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token plain"> </span><span class="token operator">&lt;=</span><span class="token plain"> y </span><span class="token operator">&amp;&amp;</span><span class="token plain"> y </span><span class="token operator">&lt;=</span><span class="token plain"> points</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain"></span><span class="token function">isSelected</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token parameter punctuation">,</span><span class="token parameter"> y</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">corners</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">calculateCorners</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">isInside</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">corners</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> x</span><span class="token punctuation">,</span><span class="token plain"> y </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>然而，元素是可以叠加的，同一个位置，有可能存在多个元素。我们想要的效果是，点击时选中最上层的那个元素。因此，在判断是否选中时，通过遍历所有已添加的元素，并找到最后添加的那个即可。</p><h3>元素的操作</h3><p>对一个元素的操作有选中、移动、缩放、删除等。除选中外，这些操作的前提是，元素必须为选中状态。因此可以归纳元素的操作定义为：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>选中：从未选中到选中</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>移动：选中状态下，点击位置在元素内，且不在操作按钮上</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>缩放：选中状态下，点击位置在缩放按钮上</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>删除：选中状态下，点击位置在删除按钮上</div></li></ul><p>点击时，需要对上述状态进行判断，以确定元素当前的操作：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token function">touchStart</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">x</span><span class="token punctuation">,</span><span class="token plain"> y</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> e</span><span class="token punctuation">.</span><span class="token property-access">touches</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 记录选中的元素，同一位置可能选中多个</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 记录点击开始位置的坐标，用于计算实际的位移量</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">touchStartPoint</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">x</span><span class="token punctuation">,</span><span class="token plain"> y</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> lastDeleteIndex</span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">graphData</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token parameter punctuation">,</span><span class="token parameter"> index</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 遍历所有已存在元素，判断点击位置是否在元素内，并更新选中状态</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> isSelected </span><span class="token operator">=</span><span class="token plain"> graph</span><span class="token punctuation">.</span><span class="token method function property-access">isSelected</span><span class="token punctuation">(</span><span class="token plain">x</span><span class="token punctuation">,</span><span class="token plain"> y</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> action </span><span class="token operator">=</span><span class="token plain"> graph</span><span class="token punctuation">.</span><span class="token method function property-access">getSelectedAction</span><span class="token punctuation">(</span><span class="token plain">x</span><span class="token punctuation">,</span><span class="token plain"> y</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">    graph</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> action</span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 未选中 =&gt; 选中</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isSelected </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">      graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">      graph</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">graph</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 已选中</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">      </span><span class="token comment">// 已选中，移动</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isSelected </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">action</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain">        graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">graph</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">26</span><div class="token-line-content"><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">27</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">28</span><div class="token-line-content"><span class="token plain">      </span><span class="token comment">// 已选中，有操作（删除或缩放）</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">29</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">action</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">30</span><div class="token-line-content"><span class="token plain">        graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">31</span><div class="token-line-content"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">graph</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">32</span><div class="token-line-content"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">action </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;delete&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">33</span><div class="token-line-content"><span class="token plain">          lastDeleteIndex </span><span class="token operator">=</span><span class="token plain"> index</span></div></div><div class="token-line"><span class="line-number">34</span><div class="token-line-content"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">35</span><div class="token-line-content"><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">36</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">37</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">38</span><div class="token-line-content"><span class="token plain">    graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">39</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">40</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> lastIndex </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">41</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">lastIndex </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">42</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 循环，重置非最顶元素状态</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">43</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">44</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">&lt;</span><span class="token plain"> lastIndex</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">45</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">46</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">47</span><div class="token-line-content"><span class="token plain">      index</span><span class="token operator">++</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">48</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">49</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 删除元素</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">50</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> selected </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">[</span><span class="token plain">lastIndex</span><span class="token punctuation">]</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">51</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">selected</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;delete&#x27;</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> lastDeleteIndex </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">52</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">graphData</span><span class="token punctuation">.</span><span class="token method function property-access">splice</span><span class="token punctuation">(</span><span class="token plain">lastDeleteIndex</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">53</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">54</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 记录点击开始时被选中元素的位置，用于计算实际的位移量</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">55</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">activeGraphOrigin</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> selected</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">56</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">57</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">58</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>其中，删除和移动的操作都比较简单。删除某个元素，只需要将该元素从元素列表中删除，并重新绘制即可。而移动某个元素，则需要将当前手指移动的位置坐标，对比原始坐标，计算出位移量，更新元素的坐标属性，并重新绘制即可。</p><h3>元素的缩放</h3><p>稍微复杂点的，是元素的缩放操作。这里的缩放效果并不是自由拉伸，而是保持元素的原始比例下进行拉伸。由于比例始终保持，元素相当于只能在其对角线上进行缩放。当我们手指点击右下角的缩放按钮并移动到新的位置时，实际的拉伸的距离为移动终点在元素对角线上的位移。可以画一条垂直于对角线并经过移动终点的直线，其与元素对角线的交点即为元素最终缩放的位置。通过对比最终点位置与原始位置的比例，得到实际缩放的比例。如图：</p><p><img src="/images/canvas-poster-sketchpad/scale.png" alt="坐标图"/></p><p>假设对角线的斜率为 <code>k</code>，元素的原始位置为 <code>origin</code>，移动终点坐标为 <code>(x, y)</code>。通过换算可以得到，交点的 x 坐标为 <code>(k * (x + origin.x) + y - origin.y) / (2 * k)</code>，通过下面的方法，可以更新元素的坐标：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">/**</span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token comment"> * 按比例缩放</span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token comment"> * @param {手指所在位置 x 坐标} x</span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token comment"> * @param {手指所在位置 y 坐标} y</span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token comment"> * @param {元素的原始位置} origin</span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token comment"> */</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token parameter punctuation">,</span><span class="token parameter"> y</span><span class="token parameter punctuation">,</span><span class="token parameter"> origin</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 原始元素对角线的斜率</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> k </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 经过当前位置与元素对角线垂直线交点的 x 坐标</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> ix </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">k </span><span class="token operator">*</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">x </span><span class="token operator">+</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> y </span><span class="token operator">-</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">2</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> k</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 通过交点坐标算出缩放比例</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> scaleRatio </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">ix </span><span class="token operator">-</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 根据缩放比例与元素类型，计算出新的元素属性</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;text&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newFontsize </span><span class="token operator">=</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">fontSize</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> scaleRatio</span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">newFontsize </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token constant">MIN_FONTSIZE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fontSize</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newFontsize</span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newWidth </span><span class="token operator">=</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> scaleRatio</span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newHeight </span><span class="token operator">=</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> scaleRatio</span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">min</span><span class="token punctuation">(</span><span class="token plain">newWidth</span><span class="token punctuation">,</span><span class="token plain"> newHeight</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newWidth</span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newHeight</span></div></div><div class="token-line"><span class="line-number">26</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">27</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>其实还差“元素的旋转”功能，不过由于客户没有要求，项目时间也比较赶，就没有实现这一块。等之后有时间，再把这一部分完善了。</p></article></main></main><footer><div>Build with ♥ @GZ</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/post/canvas-poster-sketchpad","query":{},"buildId":"c2GhiWY6kwghUvrBPufbI","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>