<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="description" content="Kelvin&#x27;s blog"/><link rel="icon" href="/images/favicon.ico"/><title>项目小结：基于 Canvas 的海报编辑小程序</title><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/90fcd0f4d638a169.css" as="style"/><link rel="stylesheet" href="/_next/static/css/90fcd0f4d638a169.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e9e30af88e81fae5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e9e30af88e81fae5.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-cf80afe0fcf9a721.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d6e5713b8459b479.js" defer=""></script><script src="/_next/static/chunks/259-40724c9c857ae4fb.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bid%5D-95d4c0924337a51d.js" defer=""></script><script src="/_next/static/5gWJ-3w7KsPABD87B5u4P/_buildManifest.js" defer=""></script><script src="/_next/static/5gWJ-3w7KsPABD87B5u4P/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="max-w-[800px] min-h-screen pt-16 m-auto flex flex-col"><nav class="fixed inset-x-0 top-0 z-50 bg-white shadow-sm"><div class="max-w-[800px] px-6 py-2 m-auto flex justify-between items-center"><a class="navbar__menu-item text-neutral-800 font-bold" href="/">&lt;般若阁 /&gt;</a><button class="navbar__menu-item sm:hidden">机关</button></div></nav><main class="p-6 flex flex-col grow"><main><article><div class="mt-8 mb-16"><h1 class="my-4 text-2xl text-neutral-800 font-bold">项目小结：基于 Canvas 的海报编辑小程序</h1><p class="text-sm text-neutral-400">May 6, 2022</p></div><div class="post-content leading-loose text-neutral-600"><p>之前接了个项目，一个学生的毕业设计，需要做一个简单的海报编辑小程序。海报编辑那部分，需求是要支持添加背景、图片素材、文字等，可以拖动、缩放。其实 GitHub 上有找到类似的，但为了学习，还是自己从零开始写起。项目是基于 Canvas 实现的，中间也踩了不少坑，记录在这里。</p>
<h2>Canvas 的尺寸问题</h2>
<h3>宽高</h3>
<p><code>&lt;canvas&gt;</code> 自身有 <code>width</code> 与 <code>height</code> 属性，表示其宽度，默认情况下为 <code>300px * 150px</code>。此外，通过 CSS 也可以设置 <code>&lt;canvas&gt;</code> 的宽高，但这两者的意义是不一样的。</p>
<p>CSS 控制的是 <code>&lt;canvas&gt;</code> 在页面中显示的实际大小，而 <code>&lt;canvas&gt;</code> 自身的宽高则是用来控制“画布”的大小。可以用一张放在桌面上的可伸缩的纸来表示这个关系：<code>&lt;canvas&gt;</code> 自身的宽高表示这张纸在未伸缩状态下的大小，而 CSS 的宽高则表示桌面的大小，<code>&lt;canvas&gt;</code> 会伸缩至填满整个桌面大小。</p>
<p>因此，我们需要保证通过 CSS 设置的大小与 <code>&lt;canvas&gt;</code> 自身的大小保持相同的比例，否则画出来的图像会被拉伸变形。</p>
<h3>缩放</h3>
<p>现在手机屏幕的分辨率越来越高，<code>1px</code> 实际上是由不只 1 个物理像素来进行显示，这个比例叫 DPR（Device Pixel Ratio）。比如 iPhone 12，屏幕的 CSS 宽度为 375px，其 DPR 为 3，即一个 CSS 像素由 3 个物理像素来表示。</p>
<p>如果我们把 <code>&lt;canvas&gt;</code> 的宽高均设置为 <code>375px</code>，那么实际上每个像素点所对应的将是 9 个物理像素，相当于被拉伸了 9 倍，显示上会很“模糊”。</p>
<p>所以，对于高分辨率手机来说，最好是将 <code>&lt;canvas&gt;</code> “放大”，使之大小与屏幕的实际分辨率对应，才能显示出“高清”的效果。</p>
<p>在小程序中，可以通过以下方法来设置：</p>
<div class="my-8 rounded-2xl overflow-hidden bg-[#282c34]"><div class="relative px-4 py-2 text-sm font-bold text-white text-center"><ul class="absolute inset-y-0 left-0 flex items-center gap-2 px-4 m-0 list-none"><li class="code-block-button bg-[#fc605d]"></li><li class="code-block-button bg-[#fcbb40]"></li><li class="code-block-button bg-[#33c648]"></li></ul>code</div><pre class="prism-code language-js"><div class="inline-block min-w-full"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">const</span><span class="token plain"> sysInfo </span><span class="token operator">=</span><span class="token plain"> wx</span><span class="token punctuation">.</span><span class="token method function property-access">getSystemInfoSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain"></span><span class="token comment">// 缩放 canvas，保持与物理像素一致，保证图片的高清</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> dpr </span><span class="token operator">=</span><span class="token plain"> sysInfo</span><span class="token punctuation">.</span><span class="token property-access">pixelRatio</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">canvas</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> width </span><span class="token operator">*</span><span class="token plain"> dpr</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">canvas</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> height </span><span class="token operator">*</span><span class="token plain"> dpr</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain"></span><span class="token comment">// 设置缩放因子，屏幕像素转为物理像素</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">.</span><span class="token method function property-access">scale</span><span class="token punctuation">(</span><span class="token plain">dpr</span><span class="token punctuation">,</span><span class="token plain"> dpr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<h2>画布上的“元素”</h2>
<p>我们用一个类，<code>Graph</code>，来表示将要添加到画布上的元素，可以是图片或文字，它有以下属性：</p>
<div class="my-8 rounded-2xl overflow-hidden bg-[#282c34]"><div class="relative px-4 py-2 text-sm font-bold text-white text-center"><ul class="absolute inset-y-0 left-0 flex items-center gap-2 px-4 m-0 list-none"><li class="code-block-button bg-[#fc605d]"></li><li class="code-block-button bg-[#fcbb40]"></li><li class="code-block-button bg-[#33c648]"></li></ul>code</div><pre class="prism-code language-js"><div class="inline-block min-w-full"><span class="token-line"><span class="code-block-line-number">1</span><span class="token comment">// 坐标属性</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> x</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> y</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain"></span><span class="token comment">// 元素的类型，&#x27;text&#x27;，&#x27;image&#x27;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> type</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain"></span><span class="token comment">// 文本内容</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">text</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> text</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain"></span><span class="token comment">// 字体大小</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fontSize</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fontSize</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain"></span><span class="token comment">// 图片</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">image</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> image</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain"></span><span class="token comment">// canvas context</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> ctx</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain"></span><span class="token comment">// 标记是否选中</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain"></span><span class="token comment">// 元素的操作</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p>另外，元素的宽高，则根据类型的不同，动态计算得到。对于图片类型的元素，在添加时需要进行缩放，以保证新添加的图片初始的大小统一。因为图片的比例不定，我们统一限制图片长边的长度，将图片按比例进行缩放，计算其宽高：</p>
<div class="my-8 rounded-2xl overflow-hidden bg-[#282c34]"><div class="relative px-4 py-2 text-sm font-bold text-white text-center"><ul class="absolute inset-y-0 left-0 flex items-center gap-2 px-4 m-0 list-none"><li class="code-block-button bg-[#fc605d]"></li><li class="code-block-button bg-[#fcbb40]"></li><li class="code-block-button bg-[#33c648]"></li></ul>code</div><pre class="prism-code language-js"><div class="inline-block min-w-full"><span class="token-line"><span class="code-block-line-number">1</span><span class="token comment">// 初始化图片，按比例缩放</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain"></span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">type </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;image&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> width</span><span class="token punctuation">,</span><span class="token plain"> height </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> image</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> ratio </span><span class="token operator">=</span><span class="token plain"> width </span><span class="token operator">/</span><span class="token plain"> height</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">  </span><span class="token comment">// 长边按比例缩放默认大小，且不能小于最小宽度</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">width </span><span class="token operator">&gt;=</span><span class="token plain"> height</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newHeight </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">DEFAULT_IMAGE_SIZE</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> ratio</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">newHeight </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> ratio</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">DEFAULT_IMAGE_SIZE</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newHeight</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newWidth </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">DEFAULT_IMAGE_SIZE</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> ratio</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">newWidth </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> ratio</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">DEFAULT_IMAGE_SIZE</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token constant">DEFAULT_IMAGE_SIZE</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> ratio</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">centerX</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">26</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">centerY</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">27</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span></div></pre></div>
<p>对于文字类型的元素，则在每次绘制的时候，根据当前的字号大小，重新计算其宽高：</p>
<div class="my-8 rounded-2xl overflow-hidden bg-[#282c34]"><div class="relative px-4 py-2 text-sm font-bold text-white text-center"><ul class="absolute inset-y-0 left-0 flex items-center gap-2 px-4 m-0 list-none"><li class="code-block-button bg-[#fc605d]"></li><li class="code-block-button bg-[#fcbb40]"></li><li class="code-block-button bg-[#33c648]"></li></ul>code</div><pre class="prism-code language-js"><div class="inline-block min-w-full"><span class="token-line"><span class="code-block-line-number">1</span><span class="token comment">// 文本元素需要根据当前字号，重新计算各项属性值</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">.</span><span class="token property-access">font</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation keyword">this</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation property-access">fontSize</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">px sans-serif</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">.</span><span class="token property-access">textAlign</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;center&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">.</span><span class="token property-access">textBaseline</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;middle&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> textWidth </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">.</span><span class="token method function property-access">measureText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">text</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> textHeight </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fontSize</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> textWidth</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> textHeight</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">centerX</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">centerY</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<h2>让元素“动”起来</h2>
<p>上面说了，Canvas 就像一张纸，而纸上画的东西是固定的，怎样才能令到画布上的元素能够实现移动、缩放、选中等操作呢？</p>
<p><img src="/images/canvas-poster-sketchpad/frame.jpg" alt="帧"/></p>
<p>其实，电影的画面也是“静态”的，只是通过快速的切换不同的静态画面，从而产生“动”起来的错觉。比方说一只豹子，如果我们按每秒 30 帧的速率，在每一帧中，稍微改变豹的位置，使其往右移动 1 个像素，那么当这些静态的帧连续进行切换的时候，这只豹子看上去就是在往右移动了。</p>
<p>让 Canvas 上的元素动起来，原理也是一样。我们利用一个数组来记录所有添加到画布中的元素，当有新元素被添加进来时，或者这些元素的某些属性产生变化时（比如坐标移动大小改变等），就遍历一遍数组，把每个元素重新按顺序绘制出来。这样一来，Canvas 看上去，就是“动”的了。</p>
<h3>添加元素</h3>
<p>监听元素的改变，将新元素推入用于记录所有元素的数组中，并触发重绘，代码如下：</p>
<div class="my-8 rounded-2xl overflow-hidden bg-[#282c34]"><div class="relative px-4 py-2 text-sm font-bold text-white text-center"><ul class="absolute inset-y-0 left-0 flex items-center gap-2 px-4 m-0 list-none"><li class="code-block-button bg-[#fc605d]"></li><li class="code-block-button bg-[#fcbb40]"></li><li class="code-block-button bg-[#33c648]"></li></ul>code</div><pre class="prism-code language-js"><div class="inline-block min-w-full"><span class="token-line"><span class="code-block-line-number">1</span><span class="token literal-property property">observers</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token comment">// 监听是否有新的元素添加进来</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">  </span><span class="token function">graph</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword control-flow">return</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">    </span><span class="token comment">// 添加新元素前，先重置所有已存在元素的选中状态</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">graphData</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">    </span><span class="token comment">// 新增元素</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;image&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> image </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">canvas</span><span class="token punctuation">.</span><span class="token method function property-access">createImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">      image</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onload</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> graph </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Graph</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token plain">config</span><span class="token punctuation">,</span><span class="token plain"> image</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">graphData</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">graph</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">      image</span><span class="token punctuation">.</span><span class="token property-access">src</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> config</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> graph </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Graph</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">graphData</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">graph</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain">  </span><span class="token comment">// 监听背景是否有改变</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain">  </span><span class="token function">background</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">url</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword control-flow">return</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> image </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">canvas</span><span class="token punctuation">.</span><span class="token method function property-access">createImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">26</span><span class="token plain">    image</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onload</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">27</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">backgroundImage</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> image</span></span><span class="token-line"><span class="code-block-line-number">28</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">29</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">30</span><span class="token plain">    image</span><span class="token punctuation">.</span><span class="token property-access">src</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> url</span></span><span class="token-line"><span class="code-block-line-number">31</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">32</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span></div></pre></div>
<p>当监听到有变化时，调用的绘制函数代码如下：</p>
<div class="my-8 rounded-2xl overflow-hidden bg-[#282c34]"><div class="relative px-4 py-2 text-sm font-bold text-white text-center"><ul class="absolute inset-y-0 left-0 flex items-center gap-2 px-4 m-0 list-none"><li class="code-block-button bg-[#fc605d]"></li><li class="code-block-button bg-[#fcbb40]"></li><li class="code-block-button bg-[#33c648]"></li></ul>code</div><pre class="prism-code language-js"><div class="inline-block min-w-full"><span class="token-line"><span class="code-block-line-number">1</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token comment">// 清空画布</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ctx</span><span class="token punctuation">.</span><span class="token method function property-access">clearRect</span><span class="token punctuation">(</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">    </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">    </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">canvasSize</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">canvasSize</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">  </span><span class="token comment">// 绘制背景</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">backgroundImage</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">scaleToFill</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">backgroundImage</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">  </span><span class="token comment">// 绘制每个元素</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">graphData</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> graph</span><span class="token punctuation">.</span><span class="token method function property-access">draw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">icons</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span></div></pre></div>
<h3>选中元素</h3>
<p>要判断是否点击在了某个元素上，实际上是要判断点击位置的坐标，是否落在由元素四个角围成的矩形内。假设左上角为原点 <code>(x, y)</code>，宽高分别为 <code>width</code>、<code>height</code>，那么四个角的坐标分别可以表示为：</p>
<ul>
<li>左上：<code>(x, y)</code></li>
<li>右上：<code>(x + width, y)</code></li>
<li>右下：<code>(x + width, y + height)</code></li>
<li>左下：<code>(x, y + height)</code></li>
</ul>
<p>封装成方法为：</p>
<div class="my-8 rounded-2xl overflow-hidden bg-[#282c34]"><div class="relative px-4 py-2 text-sm font-bold text-white text-center"><ul class="absolute inset-y-0 left-0 flex items-center gap-2 px-4 m-0 list-none"><li class="code-block-button bg-[#fc605d]"></li><li class="code-block-button bg-[#fcbb40]"></li><li class="code-block-button bg-[#33c648]"></li></ul>code</div><pre class="prism-code language-js"><div class="inline-block min-w-full"><span class="token-line"><span class="code-block-line-number">1</span><span class="token function">calculateCorners</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token parameter punctuation">,</span><span class="token parameter"> y</span><span class="token parameter punctuation">,</span><span class="token parameter"> width</span><span class="token parameter punctuation">,</span><span class="token parameter"> height</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">x</span><span class="token operator">:</span><span class="token plain"> x</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">y</span><span class="token operator">:</span><span class="token plain"> y </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">x</span><span class="token operator">:</span><span class="token plain"> x </span><span class="token operator">+</span><span class="token plain"> width</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">y</span><span class="token operator">:</span><span class="token plain"> y </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">x</span><span class="token operator">:</span><span class="token plain"> x </span><span class="token operator">+</span><span class="token plain"> width</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">y</span><span class="token operator">:</span><span class="token plain"> y </span><span class="token operator">+</span><span class="token plain"> height </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">x</span><span class="token operator">:</span><span class="token plain"> x </span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">y</span><span class="token operator">:</span><span class="token plain"> y </span><span class="token operator">+</span><span class="token plain"> height </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">  </span><span class="token punctuation">]</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span></div></pre></div>
<p>我们把这四个角的坐标放到一个数组中保存，那么判断是否在区域内和选中状态的方法分别为：</p>
<div class="my-8 rounded-2xl overflow-hidden bg-[#282c34]"><div class="relative px-4 py-2 text-sm font-bold text-white text-center"><ul class="absolute inset-y-0 left-0 flex items-center gap-2 px-4 m-0 list-none"><li class="code-block-button bg-[#fc605d]"></li><li class="code-block-button bg-[#fcbb40]"></li><li class="code-block-button bg-[#33c648]"></li></ul>code</div><pre class="prism-code language-js"><div class="inline-block min-w-full"><span class="token-line"><span class="code-block-line-number">1</span><span class="token function">isInside</span><span class="token punctuation">(</span><span class="token parameter">points</span><span class="token parameter punctuation">,</span><span class="token parameter"> target</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> x</span><span class="token punctuation">,</span><span class="token plain"> y </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> target</span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> points</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token plain"> </span><span class="token operator">&lt;=</span><span class="token plain"> x </span><span class="token operator">&amp;&amp;</span><span class="token plain"> x </span><span class="token operator">&lt;=</span><span class="token plain"> points</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> points</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token plain"> </span><span class="token operator">&lt;=</span><span class="token plain"> y </span><span class="token operator">&amp;&amp;</span><span class="token plain"> y </span><span class="token operator">&lt;=</span><span class="token plain"> points</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain"></span><span class="token function">isSelected</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token parameter punctuation">,</span><span class="token parameter"> y</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">corners</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">calculateCorners</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">isInside</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">corners</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> x</span><span class="token punctuation">,</span><span class="token plain"> y </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span></div></pre></div>
<p>然而，元素是可以叠加的，同一个位置，有可能存在多个元素。我们想要的效果是，点击时选中最上层的那个元素。因此，在判断是否选中时，通过遍历所有已添加的元素，并找到最后添加的那个即可。</p>
<h3>元素的操作</h3>
<p>对一个元素的操作有选中、移动、缩放、删除等。除选中外，这些操作的前提是，元素必须为选中状态。因此可以归纳元素的操作定义为：</p>
<ul>
<li>选中：从未选中到选中</li>
<li>移动：选中状态下，点击位置在元素内，且不在操作按钮上</li>
<li>缩放：选中状态下，点击位置在缩放按钮上</li>
<li>删除：选中状态下，点击位置在删除按钮上</li>
</ul>
<p>点击时，需要对上述状态进行判断，以确定元素当前的操作：</p>
<div class="my-8 rounded-2xl overflow-hidden bg-[#282c34]"><div class="relative px-4 py-2 text-sm font-bold text-white text-center"><ul class="absolute inset-y-0 left-0 flex items-center gap-2 px-4 m-0 list-none"><li class="code-block-button bg-[#fc605d]"></li><li class="code-block-button bg-[#fcbb40]"></li><li class="code-block-button bg-[#33c648]"></li></ul>code</div><pre class="prism-code language-js"><div class="inline-block min-w-full"><span class="token-line"><span class="code-block-line-number">1</span><span class="token function">touchStart</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">x</span><span class="token punctuation">,</span><span class="token plain"> y</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> e</span><span class="token punctuation">.</span><span class="token property-access">touches</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">  </span><span class="token comment">// 记录选中的元素，同一位置可能选中多个</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">  </span><span class="token comment">// 记录点击开始位置的坐标，用于计算实际的位移量</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">touchStartPoint</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">x</span><span class="token punctuation">,</span><span class="token plain"> y</span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> lastDeleteIndex</span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">graphData</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token parameter punctuation">,</span><span class="token parameter"> index</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">    </span><span class="token comment">// 遍历所有已存在元素，判断点击位置是否在元素内，并更新选中状态</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> isSelected </span><span class="token operator">=</span><span class="token plain"> graph</span><span class="token punctuation">.</span><span class="token method function property-access">isSelected</span><span class="token punctuation">(</span><span class="token plain">x</span><span class="token punctuation">,</span><span class="token plain"> y</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> action </span><span class="token operator">=</span><span class="token plain"> graph</span><span class="token punctuation">.</span><span class="token method function property-access">getSelectedAction</span><span class="token punctuation">(</span><span class="token plain">x</span><span class="token punctuation">,</span><span class="token plain"> y</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">    graph</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> action</span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">    </span><span class="token comment">// 未选中 =&gt; 选中</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isSelected </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">      graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">      graph</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">graph</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">    </span><span class="token comment">// 已选中</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain">      </span><span class="token comment">// 已选中，移动</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isSelected </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">action</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain">        graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">graph</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">26</span><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">27</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">28</span><span class="token plain">      </span><span class="token comment">// 已选中，有操作（删除或缩放）</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">29</span><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">action</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">30</span><span class="token plain">        graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">31</span><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">graph</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">32</span><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">action </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;delete&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">33</span><span class="token plain">          lastDeleteIndex </span><span class="token operator">=</span><span class="token plain"> index</span></span><span class="token-line"><span class="code-block-line-number">34</span><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">35</span><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">36</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">37</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">38</span><span class="token plain">    graph</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">39</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">40</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> lastIndex </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">41</span><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">lastIndex </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">42</span><span class="token plain">    </span><span class="token comment">// 循环，重置非最顶元素状态</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">43</span><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">44</span><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">&lt;</span><span class="token plain"> lastIndex</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">45</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">selected</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">46</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">47</span><span class="token plain">      index</span><span class="token operator">++</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">48</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">49</span><span class="token plain">    </span><span class="token comment">// 删除元素</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">50</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> selected </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selectedGraphs</span><span class="token punctuation">[</span><span class="token plain">lastIndex</span><span class="token punctuation">]</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">51</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">selected</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;delete&#x27;</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> lastDeleteIndex </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">52</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">graphData</span><span class="token punctuation">.</span><span class="token method function property-access">splice</span><span class="token punctuation">(</span><span class="token plain">lastDeleteIndex</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">53</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">54</span><span class="token plain">    </span><span class="token comment">// 记录点击开始时被选中元素的位置，用于计算实际的位移量</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">55</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">activeGraphOrigin</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> selected</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">56</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">57</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">58</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span></div></pre></div>
<p>其中，删除和移动的操作都比较简单。删除某个元素，只需要将该元素从元素列表中删除，并重新绘制即可。而移动某个元素，则需要将当前手指移动的位置坐标，对比原始坐标，计算出位移量，更新元素的坐标属性，并重新绘制即可。</p>
<h3>元素的缩放</h3>
<p>稍微复杂点的，是元素的缩放操作。这里的缩放效果并不是自由拉伸，而是保持元素的原始比例下进行拉伸。由于比例始终保持，元素相当于只能在其对角线上进行缩放。当我们手指点击右下角的缩放按钮并移动到新的位置时，实际的拉伸的距离为移动终点在元素对角线上的位移。可以画一条垂直于对角线并经过移动终点的直线，其与元素对角线的交点即为元素最终缩放的位置。通过对比最终点位置与原始位置的比例，得到实际缩放的比例。如图：</p>
<p><img src="/images/canvas-poster-sketchpad/scale.png" alt="坐标图"/></p>
<p>假设对角线的斜率为 <code>k</code>，元素的原始位置为 <code>origin</code>，移动终点坐标为 <code>(x, y)</code>。通过换算可以得到，交点的 x 坐标为 <code>(k * (x + origin.x) + y - origin.y) / (2 * k)</code>，通过下面的方法，可以更新元素的坐标：</p>
<div class="my-8 rounded-2xl overflow-hidden bg-[#282c34]"><div class="relative px-4 py-2 text-sm font-bold text-white text-center"><ul class="absolute inset-y-0 left-0 flex items-center gap-2 px-4 m-0 list-none"><li class="code-block-button bg-[#fc605d]"></li><li class="code-block-button bg-[#fcbb40]"></li><li class="code-block-button bg-[#33c648]"></li></ul>code</div><pre class="prism-code language-js"><div class="inline-block min-w-full"><span class="token-line"><span class="code-block-line-number">1</span><span class="token comment">/**</span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token comment"> * 按比例缩放</span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token comment"> * @param {手指所在位置 x 坐标} x</span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token comment"> * @param {手指所在位置 y 坐标} y</span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token comment"> * @param {元素的原始位置} origin</span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token comment"> */</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain"></span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token parameter punctuation">,</span><span class="token parameter"> y</span><span class="token parameter punctuation">,</span><span class="token parameter"> origin</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">  </span><span class="token comment">// 原始元素对角线的斜率</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> k </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">  </span><span class="token comment">// 经过当前位置与元素对角线垂直线交点的 x 坐标</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> ix </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">k </span><span class="token operator">*</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">x </span><span class="token operator">+</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> y </span><span class="token operator">-</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">y</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token number">2</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> k</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">  </span><span class="token comment">// 通过交点坐标算出缩放比例</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> scaleRatio </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">ix </span><span class="token operator">-</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">  </span><span class="token comment">// 根据缩放比例与元素类型，计算出新的元素属性</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;text&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newFontsize </span><span class="token operator">=</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">fontSize</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> scaleRatio</span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">newFontsize </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token constant">MIN_FONTSIZE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword control-flow">return</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fontSize</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newFontsize</span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newWidth </span><span class="token operator">=</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> scaleRatio</span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newHeight </span><span class="token operator">=</span><span class="token plain"> origin</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> scaleRatio</span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">min</span><span class="token punctuation">(</span><span class="token plain">newWidth</span><span class="token punctuation">,</span><span class="token plain"> newHeight</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token constant">MIN_IMAGE_SIZE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword control-flow">return</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newWidth</span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newHeight</span></span><span class="token-line"><span class="code-block-line-number">26</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">27</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span></div></pre></div>
<p>其实还差“元素的旋转”功能，不过由于客户没有要求，项目时间也比较赶，就没有实现这一块。等之后有时间，再把这一部分完善了。</p></div></article></main></main><footer class="h-20 flex items-center justify-center text-sm text-neutral-400"><div>Build with ♥ @GZ</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"meta":{"title":"项目小结：基于 Canvas 的海报编辑小程序","date":"May 6, 2022","desc":"之前接了个项目，一个学生的毕业设计，需要做一个简单的海报编辑小程序。海报编辑那部分，需求是要支持添加背景、图片素材、文字等，可以拖动、缩放。其实 GitHub 上有找到类似的，但为了学习，还是自己从零开始写起。项目是基于 Canvas 实现的，中间也踩了不少坑，记录在这里。","type":"horse-sense"},"code":"var Component=(()=\u003e{var o=Object.create;var c=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var x=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty;var m=(i,n)=\u003e()=\u003e(n||i((n={exports:{}}).exports,n),n.exports),I=(i,n)=\u003e{for(var t in n)c(i,t,{get:n[t],enumerable:!0})},r=(i,n,t,s)=\u003e{if(n\u0026\u0026typeof n==\"object\"||typeof n==\"function\")for(let h of p(n))!u.call(i,h)\u0026\u0026h!==t\u0026\u0026c(i,h,{get:()=\u003en[h],enumerable:!(s=g(n,h))||s.enumerable});return i};var f=(i,n,t)=\u003e(t=i!=null?o(x(i)):{},r(n||!i||!i.__esModule?c(t,\"default\",{value:i,enumerable:!0}):t,i)),y=i=\u003er(c({},\"__esModule\",{value:!0}),i);var d=m((G,a)=\u003e{a.exports=_jsx_runtime});var _={};I(_,{default:()=\u003eE,frontmatter:()=\u003ew});var e=f(d()),w={title:\"\\u9879\\u76EE\\u5C0F\\u7ED3\\uFF1A\\u57FA\\u4E8E Canvas \\u7684\\u6D77\\u62A5\\u7F16\\u8F91\\u5C0F\\u7A0B\\u5E8F\",date:\"May 6, 2022\",desc:\"\\u4E4B\\u524D\\u63A5\\u4E86\\u4E2A\\u9879\\u76EE\\uFF0C\\u4E00\\u4E2A\\u5B66\\u751F\\u7684\\u6BD5\\u4E1A\\u8BBE\\u8BA1\\uFF0C\\u9700\\u8981\\u505A\\u4E00\\u4E2A\\u7B80\\u5355\\u7684\\u6D77\\u62A5\\u7F16\\u8F91\\u5C0F\\u7A0B\\u5E8F\\u3002\\u6D77\\u62A5\\u7F16\\u8F91\\u90A3\\u90E8\\u5206\\uFF0C\\u9700\\u6C42\\u662F\\u8981\\u652F\\u6301\\u6DFB\\u52A0\\u80CC\\u666F\\u3001\\u56FE\\u7247\\u7D20\\u6750\\u3001\\u6587\\u5B57\\u7B49\\uFF0C\\u53EF\\u4EE5\\u62D6\\u52A8\\u3001\\u7F29\\u653E\\u3002\\u5176\\u5B9E GitHub \\u4E0A\\u6709\\u627E\\u5230\\u7C7B\\u4F3C\\u7684\\uFF0C\\u4F46\\u4E3A\\u4E86\\u5B66\\u4E60\\uFF0C\\u8FD8\\u662F\\u81EA\\u5DF1\\u4ECE\\u96F6\\u5F00\\u59CB\\u5199\\u8D77\\u3002\\u9879\\u76EE\\u662F\\u57FA\\u4E8E Canvas \\u5B9E\\u73B0\\u7684\\uFF0C\\u4E2D\\u95F4\\u4E5F\\u8E29\\u4E86\\u4E0D\\u5C11\\u5751\\uFF0C\\u8BB0\\u5F55\\u5728\\u8FD9\\u91CC\\u3002\",type:\"horse-sense\"};function l(i){let n=Object.assign({p:\"p\",h2:\"h2\",h3:\"h3\",code:\"code\",pre:\"pre\",img:\"img\",ul:\"ul\",li:\"li\"},i.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:\"\\u4E4B\\u524D\\u63A5\\u4E86\\u4E2A\\u9879\\u76EE\\uFF0C\\u4E00\\u4E2A\\u5B66\\u751F\\u7684\\u6BD5\\u4E1A\\u8BBE\\u8BA1\\uFF0C\\u9700\\u8981\\u505A\\u4E00\\u4E2A\\u7B80\\u5355\\u7684\\u6D77\\u62A5\\u7F16\\u8F91\\u5C0F\\u7A0B\\u5E8F\\u3002\\u6D77\\u62A5\\u7F16\\u8F91\\u90A3\\u90E8\\u5206\\uFF0C\\u9700\\u6C42\\u662F\\u8981\\u652F\\u6301\\u6DFB\\u52A0\\u80CC\\u666F\\u3001\\u56FE\\u7247\\u7D20\\u6750\\u3001\\u6587\\u5B57\\u7B49\\uFF0C\\u53EF\\u4EE5\\u62D6\\u52A8\\u3001\\u7F29\\u653E\\u3002\\u5176\\u5B9E GitHub \\u4E0A\\u6709\\u627E\\u5230\\u7C7B\\u4F3C\\u7684\\uFF0C\\u4F46\\u4E3A\\u4E86\\u5B66\\u4E60\\uFF0C\\u8FD8\\u662F\\u81EA\\u5DF1\\u4ECE\\u96F6\\u5F00\\u59CB\\u5199\\u8D77\\u3002\\u9879\\u76EE\\u662F\\u57FA\\u4E8E Canvas \\u5B9E\\u73B0\\u7684\\uFF0C\\u4E2D\\u95F4\\u4E5F\\u8E29\\u4E86\\u4E0D\\u5C11\\u5751\\uFF0C\\u8BB0\\u5F55\\u5728\\u8FD9\\u91CC\\u3002\"}),`\n`,(0,e.jsx)(n.h2,{children:\"Canvas \\u7684\\u5C3A\\u5BF8\\u95EE\\u9898\"}),`\n`,(0,e.jsx)(n.h3,{children:\"\\u5BBD\\u9AD8\"}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"\u003ccanvas\u003e\"}),\" \\u81EA\\u8EAB\\u6709 \",(0,e.jsx)(n.code,{children:\"width\"}),\" \\u4E0E \",(0,e.jsx)(n.code,{children:\"height\"}),\" \\u5C5E\\u6027\\uFF0C\\u8868\\u793A\\u5176\\u5BBD\\u5EA6\\uFF0C\\u9ED8\\u8BA4\\u60C5\\u51B5\\u4E0B\\u4E3A \",(0,e.jsx)(n.code,{children:\"300px * 150px\"}),\"\\u3002\\u6B64\\u5916\\uFF0C\\u901A\\u8FC7 CSS \\u4E5F\\u53EF\\u4EE5\\u8BBE\\u7F6E \",(0,e.jsx)(n.code,{children:\"\u003ccanvas\u003e\"}),\" \\u7684\\u5BBD\\u9AD8\\uFF0C\\u4F46\\u8FD9\\u4E24\\u8005\\u7684\\u610F\\u4E49\\u662F\\u4E0D\\u4E00\\u6837\\u7684\\u3002\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"CSS \\u63A7\\u5236\\u7684\\u662F \",(0,e.jsx)(n.code,{children:\"\u003ccanvas\u003e\"}),\" \\u5728\\u9875\\u9762\\u4E2D\\u663E\\u793A\\u7684\\u5B9E\\u9645\\u5927\\u5C0F\\uFF0C\\u800C \",(0,e.jsx)(n.code,{children:\"\u003ccanvas\u003e\"}),\" \\u81EA\\u8EAB\\u7684\\u5BBD\\u9AD8\\u5219\\u662F\\u7528\\u6765\\u63A7\\u5236\\u201C\\u753B\\u5E03\\u201D\\u7684\\u5927\\u5C0F\\u3002\\u53EF\\u4EE5\\u7528\\u4E00\\u5F20\\u653E\\u5728\\u684C\\u9762\\u4E0A\\u7684\\u53EF\\u4F38\\u7F29\\u7684\\u7EB8\\u6765\\u8868\\u793A\\u8FD9\\u4E2A\\u5173\\u7CFB\\uFF1A\",(0,e.jsx)(n.code,{children:\"\u003ccanvas\u003e\"}),\" \\u81EA\\u8EAB\\u7684\\u5BBD\\u9AD8\\u8868\\u793A\\u8FD9\\u5F20\\u7EB8\\u5728\\u672A\\u4F38\\u7F29\\u72B6\\u6001\\u4E0B\\u7684\\u5927\\u5C0F\\uFF0C\\u800C CSS \\u7684\\u5BBD\\u9AD8\\u5219\\u8868\\u793A\\u684C\\u9762\\u7684\\u5927\\u5C0F\\uFF0C\",(0,e.jsx)(n.code,{children:\"\u003ccanvas\u003e\"}),\" \\u4F1A\\u4F38\\u7F29\\u81F3\\u586B\\u6EE1\\u6574\\u4E2A\\u684C\\u9762\\u5927\\u5C0F\\u3002\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u56E0\\u6B64\\uFF0C\\u6211\\u4EEC\\u9700\\u8981\\u4FDD\\u8BC1\\u901A\\u8FC7 CSS \\u8BBE\\u7F6E\\u7684\\u5927\\u5C0F\\u4E0E \",(0,e.jsx)(n.code,{children:\"\u003ccanvas\u003e\"}),\" \\u81EA\\u8EAB\\u7684\\u5927\\u5C0F\\u4FDD\\u6301\\u76F8\\u540C\\u7684\\u6BD4\\u4F8B\\uFF0C\\u5426\\u5219\\u753B\\u51FA\\u6765\\u7684\\u56FE\\u50CF\\u4F1A\\u88AB\\u62C9\\u4F38\\u53D8\\u5F62\\u3002\"]}),`\n`,(0,e.jsx)(n.h3,{children:\"\\u7F29\\u653E\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u73B0\\u5728\\u624B\\u673A\\u5C4F\\u5E55\\u7684\\u5206\\u8FA8\\u7387\\u8D8A\\u6765\\u8D8A\\u9AD8\\uFF0C\",(0,e.jsx)(n.code,{children:\"1px\"}),\" \\u5B9E\\u9645\\u4E0A\\u662F\\u7531\\u4E0D\\u53EA 1 \\u4E2A\\u7269\\u7406\\u50CF\\u7D20\\u6765\\u8FDB\\u884C\\u663E\\u793A\\uFF0C\\u8FD9\\u4E2A\\u6BD4\\u4F8B\\u53EB DPR\\uFF08Device Pixel Ratio\\uFF09\\u3002\\u6BD4\\u5982 iPhone 12\\uFF0C\\u5C4F\\u5E55\\u7684 CSS \\u5BBD\\u5EA6\\u4E3A 375px\\uFF0C\\u5176 DPR \\u4E3A 3\\uFF0C\\u5373\\u4E00\\u4E2A CSS \\u50CF\\u7D20\\u7531 3 \\u4E2A\\u7269\\u7406\\u50CF\\u7D20\\u6765\\u8868\\u793A\\u3002\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u5982\\u679C\\u6211\\u4EEC\\u628A \",(0,e.jsx)(n.code,{children:\"\u003ccanvas\u003e\"}),\" \\u7684\\u5BBD\\u9AD8\\u5747\\u8BBE\\u7F6E\\u4E3A \",(0,e.jsx)(n.code,{children:\"375px\"}),\"\\uFF0C\\u90A3\\u4E48\\u5B9E\\u9645\\u4E0A\\u6BCF\\u4E2A\\u50CF\\u7D20\\u70B9\\u6240\\u5BF9\\u5E94\\u7684\\u5C06\\u662F 9 \\u4E2A\\u7269\\u7406\\u50CF\\u7D20\\uFF0C\\u76F8\\u5F53\\u4E8E\\u88AB\\u62C9\\u4F38\\u4E86 9 \\u500D\\uFF0C\\u663E\\u793A\\u4E0A\\u4F1A\\u5F88\\u201C\\u6A21\\u7CCA\\u201D\\u3002\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u6240\\u4EE5\\uFF0C\\u5BF9\\u4E8E\\u9AD8\\u5206\\u8FA8\\u7387\\u624B\\u673A\\u6765\\u8BF4\\uFF0C\\u6700\\u597D\\u662F\\u5C06 \",(0,e.jsx)(n.code,{children:\"\u003ccanvas\u003e\"}),\" \\u201C\\u653E\\u5927\\u201D\\uFF0C\\u4F7F\\u4E4B\\u5927\\u5C0F\\u4E0E\\u5C4F\\u5E55\\u7684\\u5B9E\\u9645\\u5206\\u8FA8\\u7387\\u5BF9\\u5E94\\uFF0C\\u624D\\u80FD\\u663E\\u793A\\u51FA\\u201C\\u9AD8\\u6E05\\u201D\\u7684\\u6548\\u679C\\u3002\"]}),`\n`,(0,e.jsx)(n.p,{children:\"\\u5728\\u5C0F\\u7A0B\\u5E8F\\u4E2D\\uFF0C\\u53EF\\u4EE5\\u901A\\u8FC7\\u4EE5\\u4E0B\\u65B9\\u6CD5\\u6765\\u8BBE\\u7F6E\\uFF1A\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`const sysInfo = wx.getSystemInfoSync();\n// \\u7F29\\u653E canvas\\uFF0C\\u4FDD\\u6301\\u4E0E\\u7269\\u7406\\u50CF\\u7D20\\u4E00\\u81F4\\uFF0C\\u4FDD\\u8BC1\\u56FE\\u7247\\u7684\\u9AD8\\u6E05\nconst dpr = sysInfo.pixelRatio;\nthis.canvas.width = width * dpr;\nthis.canvas.height = height * dpr;\n// \\u8BBE\\u7F6E\\u7F29\\u653E\\u56E0\\u5B50\\uFF0C\\u5C4F\\u5E55\\u50CF\\u7D20\\u8F6C\\u4E3A\\u7269\\u7406\\u50CF\\u7D20\nthis.ctx.scale(dpr, dpr);\n`})}),`\n`,(0,e.jsx)(n.h2,{children:\"\\u753B\\u5E03\\u4E0A\\u7684\\u201C\\u5143\\u7D20\\u201D\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u6211\\u4EEC\\u7528\\u4E00\\u4E2A\\u7C7B\\uFF0C\",(0,e.jsx)(n.code,{children:\"Graph\"}),\"\\uFF0C\\u6765\\u8868\\u793A\\u5C06\\u8981\\u6DFB\\u52A0\\u5230\\u753B\\u5E03\\u4E0A\\u7684\\u5143\\u7D20\\uFF0C\\u53EF\\u4EE5\\u662F\\u56FE\\u7247\\u6216\\u6587\\u5B57\\uFF0C\\u5B83\\u6709\\u4EE5\\u4E0B\\u5C5E\\u6027\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`// \\u5750\\u6807\\u5C5E\\u6027\nthis.x = x;\nthis.y = y;\n// \\u5143\\u7D20\\u7684\\u7C7B\\u578B\\uFF0C'text'\\uFF0C'image'\nthis.type = type;\n// \\u6587\\u672C\\u5185\\u5BB9\nthis.text = text;\n// \\u5B57\\u4F53\\u5927\\u5C0F\nthis.fontSize = fontSize;\n// \\u56FE\\u7247\nthis.image = image;\n// canvas context\nthis.ctx = ctx;\n// \\u6807\\u8BB0\\u662F\\u5426\\u9009\\u4E2D\nthis.selected = true;\n// \\u5143\\u7D20\\u7684\\u64CD\\u4F5C\nthis.action = false;\n`})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u53E6\\u5916\\uFF0C\\u5143\\u7D20\\u7684\\u5BBD\\u9AD8\\uFF0C\\u5219\\u6839\\u636E\\u7C7B\\u578B\\u7684\\u4E0D\\u540C\\uFF0C\\u52A8\\u6001\\u8BA1\\u7B97\\u5F97\\u5230\\u3002\\u5BF9\\u4E8E\\u56FE\\u7247\\u7C7B\\u578B\\u7684\\u5143\\u7D20\\uFF0C\\u5728\\u6DFB\\u52A0\\u65F6\\u9700\\u8981\\u8FDB\\u884C\\u7F29\\u653E\\uFF0C\\u4EE5\\u4FDD\\u8BC1\\u65B0\\u6DFB\\u52A0\\u7684\\u56FE\\u7247\\u521D\\u59CB\\u7684\\u5927\\u5C0F\\u7EDF\\u4E00\\u3002\\u56E0\\u4E3A\\u56FE\\u7247\\u7684\\u6BD4\\u4F8B\\u4E0D\\u5B9A\\uFF0C\\u6211\\u4EEC\\u7EDF\\u4E00\\u9650\\u5236\\u56FE\\u7247\\u957F\\u8FB9\\u7684\\u957F\\u5EA6\\uFF0C\\u5C06\\u56FE\\u7247\\u6309\\u6BD4\\u4F8B\\u8FDB\\u884C\\u7F29\\u653E\\uFF0C\\u8BA1\\u7B97\\u5176\\u5BBD\\u9AD8\\uFF1A\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`// \\u521D\\u59CB\\u5316\\u56FE\\u7247\\uFF0C\\u6309\\u6BD4\\u4F8B\\u7F29\\u653E\nif (type === \"image\") {\n  const { width, height } = image;\n  const ratio = width / height;\n  // \\u957F\\u8FB9\\u6309\\u6BD4\\u4F8B\\u7F29\\u653E\\u9ED8\\u8BA4\\u5927\\u5C0F\\uFF0C\\u4E14\\u4E0D\\u80FD\\u5C0F\\u4E8E\\u6700\\u5C0F\\u5BBD\\u5EA6\n  if (width \u003e= height) {\n    const newHeight = DEFAULT_IMAGE_SIZE / ratio;\n    if (newHeight \u003c MIN_IMAGE_SIZE) {\n      this.height = MIN_IMAGE_SIZE;\n      this.width = MIN_IMAGE_SIZE * ratio;\n    } else {\n      this.width = DEFAULT_IMAGE_SIZE;\n      this.height = newHeight;\n    }\n  } else {\n    const newWidth = DEFAULT_IMAGE_SIZE * ratio;\n    if (newWidth \u003c MIN_IMAGE_SIZE) {\n      this.width = MIN_IMAGE_SIZE;\n      this.height = MIN_IMAGE_SIZE / ratio;\n    } else {\n      this.height = DEFAULT_IMAGE_SIZE;\n      this.width = DEFAULT_IMAGE_SIZE * ratio;\n    }\n  }\n  this.centerX = this.x + this.width / 2;\n  this.centerY = this.y + this.height / 2;\n}\n`})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u5BF9\\u4E8E\\u6587\\u5B57\\u7C7B\\u578B\\u7684\\u5143\\u7D20\\uFF0C\\u5219\\u5728\\u6BCF\\u6B21\\u7ED8\\u5236\\u7684\\u65F6\\u5019\\uFF0C\\u6839\\u636E\\u5F53\\u524D\\u7684\\u5B57\\u53F7\\u5927\\u5C0F\\uFF0C\\u91CD\\u65B0\\u8BA1\\u7B97\\u5176\\u5BBD\\u9AD8\\uFF1A\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`// \\u6587\\u672C\\u5143\\u7D20\\u9700\\u8981\\u6839\\u636E\\u5F53\\u524D\\u5B57\\u53F7\\uFF0C\\u91CD\\u65B0\\u8BA1\\u7B97\\u5404\\u9879\\u5C5E\\u6027\\u503C\nthis.ctx.font = \\`\\${this.fontSize}px sans-serif\\`;\nthis.ctx.textAlign = \"center\";\nthis.ctx.textBaseline = \"middle\";\nconst textWidth = this.ctx.measureText(this.text).width;\nconst textHeight = this.fontSize;\nthis.width = textWidth;\nthis.height = textHeight;\nthis.centerX = this.x + this.width / 2;\nthis.centerY = this.y + this.height / 2;\n`})}),`\n`,(0,e.jsx)(n.h2,{children:\"\\u8BA9\\u5143\\u7D20\\u201C\\u52A8\\u201D\\u8D77\\u6765\"}),`\n`,(0,e.jsx)(n.p,{children:\"\\u4E0A\\u9762\\u8BF4\\u4E86\\uFF0CCanvas \\u5C31\\u50CF\\u4E00\\u5F20\\u7EB8\\uFF0C\\u800C\\u7EB8\\u4E0A\\u753B\\u7684\\u4E1C\\u897F\\u662F\\u56FA\\u5B9A\\u7684\\uFF0C\\u600E\\u6837\\u624D\\u80FD\\u4EE4\\u5230\\u753B\\u5E03\\u4E0A\\u7684\\u5143\\u7D20\\u80FD\\u591F\\u5B9E\\u73B0\\u79FB\\u52A8\\u3001\\u7F29\\u653E\\u3001\\u9009\\u4E2D\\u7B49\\u64CD\\u4F5C\\u5462\\uFF1F\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/images/canvas-poster-sketchpad/frame.jpg\",alt:\"\\u5E27\"})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u5176\\u5B9E\\uFF0C\\u7535\\u5F71\\u7684\\u753B\\u9762\\u4E5F\\u662F\\u201C\\u9759\\u6001\\u201D\\u7684\\uFF0C\\u53EA\\u662F\\u901A\\u8FC7\\u5FEB\\u901F\\u7684\\u5207\\u6362\\u4E0D\\u540C\\u7684\\u9759\\u6001\\u753B\\u9762\\uFF0C\\u4ECE\\u800C\\u4EA7\\u751F\\u201C\\u52A8\\u201D\\u8D77\\u6765\\u7684\\u9519\\u89C9\\u3002\\u6BD4\\u65B9\\u8BF4\\u4E00\\u53EA\\u8C79\\u5B50\\uFF0C\\u5982\\u679C\\u6211\\u4EEC\\u6309\\u6BCF\\u79D2 30 \\u5E27\\u7684\\u901F\\u7387\\uFF0C\\u5728\\u6BCF\\u4E00\\u5E27\\u4E2D\\uFF0C\\u7A0D\\u5FAE\\u6539\\u53D8\\u8C79\\u7684\\u4F4D\\u7F6E\\uFF0C\\u4F7F\\u5176\\u5F80\\u53F3\\u79FB\\u52A8 1 \\u4E2A\\u50CF\\u7D20\\uFF0C\\u90A3\\u4E48\\u5F53\\u8FD9\\u4E9B\\u9759\\u6001\\u7684\\u5E27\\u8FDE\\u7EED\\u8FDB\\u884C\\u5207\\u6362\\u7684\\u65F6\\u5019\\uFF0C\\u8FD9\\u53EA\\u8C79\\u5B50\\u770B\\u4E0A\\u53BB\\u5C31\\u662F\\u5728\\u5F80\\u53F3\\u79FB\\u52A8\\u4E86\\u3002\"}),`\n`,(0,e.jsx)(n.p,{children:\"\\u8BA9 Canvas \\u4E0A\\u7684\\u5143\\u7D20\\u52A8\\u8D77\\u6765\\uFF0C\\u539F\\u7406\\u4E5F\\u662F\\u4E00\\u6837\\u3002\\u6211\\u4EEC\\u5229\\u7528\\u4E00\\u4E2A\\u6570\\u7EC4\\u6765\\u8BB0\\u5F55\\u6240\\u6709\\u6DFB\\u52A0\\u5230\\u753B\\u5E03\\u4E2D\\u7684\\u5143\\u7D20\\uFF0C\\u5F53\\u6709\\u65B0\\u5143\\u7D20\\u88AB\\u6DFB\\u52A0\\u8FDB\\u6765\\u65F6\\uFF0C\\u6216\\u8005\\u8FD9\\u4E9B\\u5143\\u7D20\\u7684\\u67D0\\u4E9B\\u5C5E\\u6027\\u4EA7\\u751F\\u53D8\\u5316\\u65F6\\uFF08\\u6BD4\\u5982\\u5750\\u6807\\u79FB\\u52A8\\u5927\\u5C0F\\u6539\\u53D8\\u7B49\\uFF09\\uFF0C\\u5C31\\u904D\\u5386\\u4E00\\u904D\\u6570\\u7EC4\\uFF0C\\u628A\\u6BCF\\u4E2A\\u5143\\u7D20\\u91CD\\u65B0\\u6309\\u987A\\u5E8F\\u7ED8\\u5236\\u51FA\\u6765\\u3002\\u8FD9\\u6837\\u4E00\\u6765\\uFF0CCanvas \\u770B\\u4E0A\\u53BB\\uFF0C\\u5C31\\u662F\\u201C\\u52A8\\u201D\\u7684\\u4E86\\u3002\"}),`\n`,(0,e.jsx)(n.h3,{children:\"\\u6DFB\\u52A0\\u5143\\u7D20\"}),`\n`,(0,e.jsx)(n.p,{children:\"\\u76D1\\u542C\\u5143\\u7D20\\u7684\\u6539\\u53D8\\uFF0C\\u5C06\\u65B0\\u5143\\u7D20\\u63A8\\u5165\\u7528\\u4E8E\\u8BB0\\u5F55\\u6240\\u6709\\u5143\\u7D20\\u7684\\u6570\\u7EC4\\u4E2D\\uFF0C\\u5E76\\u89E6\\u53D1\\u91CD\\u7ED8\\uFF0C\\u4EE3\\u7801\\u5982\\u4E0B\\uFF1A\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`observers: {\n  // \\u76D1\\u542C\\u662F\\u5426\\u6709\\u65B0\\u7684\\u5143\\u7D20\\u6DFB\\u52A0\\u8FDB\\u6765\n  graph(config) {\n    if (!config) return\n    // \\u6DFB\\u52A0\\u65B0\\u5143\\u7D20\\u524D\\uFF0C\\u5148\\u91CD\\u7F6E\\u6240\\u6709\\u5DF2\\u5B58\\u5728\\u5143\\u7D20\\u7684\\u9009\\u4E2D\\u72B6\\u6001\n    this.graphData.forEach(graph =\u003e graph.selected = false)\n    // \\u65B0\\u589E\\u5143\\u7D20\n    if (config.type === 'image') {\n      const image = this.canvas.createImage()\n      image.onload = () =\u003e {\n        const graph = new Graph({...config, image}, this.ctx)\n        this.graphData.push(graph)\n        this.render()\n      }\n      image.src = config.url\n    } else {\n      const graph = new Graph(config, this.ctx)\n      this.graphData.push(graph)\n      this.render()\n    }\n  },\n  // \\u76D1\\u542C\\u80CC\\u666F\\u662F\\u5426\\u6709\\u6539\\u53D8\n  background(url) {\n    if (!url) return\n    const image = this.canvas.createImage()\n    image.onload = () =\u003e {\n      this.backgroundImage = image\n      this.render()\n    }\n    image.src = url\n  }\n}\n`})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u5F53\\u76D1\\u542C\\u5230\\u6709\\u53D8\\u5316\\u65F6\\uFF0C\\u8C03\\u7528\\u7684\\u7ED8\\u5236\\u51FD\\u6570\\u4EE3\\u7801\\u5982\\u4E0B\\uFF1A\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`render() {\n  // \\u6E05\\u7A7A\\u753B\\u5E03\n  this.ctx.clearRect(\n    0,\n    0,\n    this.canvasSize.width,\n    this.canvasSize.height\n  )\n  // \\u7ED8\\u5236\\u80CC\\u666F\n  if (this.backgroundImage) {\n    this.scaleToFill(this.backgroundImage)\n  }\n  // \\u7ED8\\u5236\\u6BCF\\u4E2A\\u5143\\u7D20\n  this.graphData.forEach(graph =\u003e graph.draw(this.icons))\n}\n`})}),`\n`,(0,e.jsx)(n.h3,{children:\"\\u9009\\u4E2D\\u5143\\u7D20\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u8981\\u5224\\u65AD\\u662F\\u5426\\u70B9\\u51FB\\u5728\\u4E86\\u67D0\\u4E2A\\u5143\\u7D20\\u4E0A\\uFF0C\\u5B9E\\u9645\\u4E0A\\u662F\\u8981\\u5224\\u65AD\\u70B9\\u51FB\\u4F4D\\u7F6E\\u7684\\u5750\\u6807\\uFF0C\\u662F\\u5426\\u843D\\u5728\\u7531\\u5143\\u7D20\\u56DB\\u4E2A\\u89D2\\u56F4\\u6210\\u7684\\u77E9\\u5F62\\u5185\\u3002\\u5047\\u8BBE\\u5DE6\\u4E0A\\u89D2\\u4E3A\\u539F\\u70B9 \",(0,e.jsx)(n.code,{children:\"(x, y)\"}),\"\\uFF0C\\u5BBD\\u9AD8\\u5206\\u522B\\u4E3A \",(0,e.jsx)(n.code,{children:\"width\"}),\"\\u3001\",(0,e.jsx)(n.code,{children:\"height\"}),\"\\uFF0C\\u90A3\\u4E48\\u56DB\\u4E2A\\u89D2\\u7684\\u5750\\u6807\\u5206\\u522B\\u53EF\\u4EE5\\u8868\\u793A\\u4E3A\\uFF1A\"]}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsxs)(n.li,{children:[\"\\u5DE6\\u4E0A\\uFF1A\",(0,e.jsx)(n.code,{children:\"(x, y)\"})]}),`\n`,(0,e.jsxs)(n.li,{children:[\"\\u53F3\\u4E0A\\uFF1A\",(0,e.jsx)(n.code,{children:\"(x + width, y)\"})]}),`\n`,(0,e.jsxs)(n.li,{children:[\"\\u53F3\\u4E0B\\uFF1A\",(0,e.jsx)(n.code,{children:\"(x + width, y + height)\"})]}),`\n`,(0,e.jsxs)(n.li,{children:[\"\\u5DE6\\u4E0B\\uFF1A\",(0,e.jsx)(n.code,{children:\"(x, y + height)\"})]}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"\\u5C01\\u88C5\\u6210\\u65B9\\u6CD5\\u4E3A\\uFF1A\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`calculateCorners(x, y, width, height) {\n  return [\n    { x: x, y: y },\n    { x: x + width, y: y },\n    { x: x + width, y: y + height },\n    { x: x , y: y + height }\n  ]\n}\n`})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u6211\\u4EEC\\u628A\\u8FD9\\u56DB\\u4E2A\\u89D2\\u7684\\u5750\\u6807\\u653E\\u5230\\u4E00\\u4E2A\\u6570\\u7EC4\\u4E2D\\u4FDD\\u5B58\\uFF0C\\u90A3\\u4E48\\u5224\\u65AD\\u662F\\u5426\\u5728\\u533A\\u57DF\\u5185\\u548C\\u9009\\u4E2D\\u72B6\\u6001\\u7684\\u65B9\\u6CD5\\u5206\\u522B\\u4E3A\\uFF1A\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`isInside(points, target) {\n  const { x, y } = target\n  return points[0].x \u003c= x \u0026\u0026 x \u003c= points[1].x \u0026\u0026 points[0].y \u003c= y \u0026\u0026 y \u003c= points[3].y\n}\n\nisSelected(x, y) {\n  this.corners = this.calculateCorners(this.x, this.y, this.width, this.height)\n  return this.isInside(this.corners, { x, y })\n}\n`})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u7136\\u800C\\uFF0C\\u5143\\u7D20\\u662F\\u53EF\\u4EE5\\u53E0\\u52A0\\u7684\\uFF0C\\u540C\\u4E00\\u4E2A\\u4F4D\\u7F6E\\uFF0C\\u6709\\u53EF\\u80FD\\u5B58\\u5728\\u591A\\u4E2A\\u5143\\u7D20\\u3002\\u6211\\u4EEC\\u60F3\\u8981\\u7684\\u6548\\u679C\\u662F\\uFF0C\\u70B9\\u51FB\\u65F6\\u9009\\u4E2D\\u6700\\u4E0A\\u5C42\\u7684\\u90A3\\u4E2A\\u5143\\u7D20\\u3002\\u56E0\\u6B64\\uFF0C\\u5728\\u5224\\u65AD\\u662F\\u5426\\u9009\\u4E2D\\u65F6\\uFF0C\\u901A\\u8FC7\\u904D\\u5386\\u6240\\u6709\\u5DF2\\u6DFB\\u52A0\\u7684\\u5143\\u7D20\\uFF0C\\u5E76\\u627E\\u5230\\u6700\\u540E\\u6DFB\\u52A0\\u7684\\u90A3\\u4E2A\\u5373\\u53EF\\u3002\"}),`\n`,(0,e.jsx)(n.h3,{children:\"\\u5143\\u7D20\\u7684\\u64CD\\u4F5C\"}),`\n`,(0,e.jsx)(n.p,{children:\"\\u5BF9\\u4E00\\u4E2A\\u5143\\u7D20\\u7684\\u64CD\\u4F5C\\u6709\\u9009\\u4E2D\\u3001\\u79FB\\u52A8\\u3001\\u7F29\\u653E\\u3001\\u5220\\u9664\\u7B49\\u3002\\u9664\\u9009\\u4E2D\\u5916\\uFF0C\\u8FD9\\u4E9B\\u64CD\\u4F5C\\u7684\\u524D\\u63D0\\u662F\\uFF0C\\u5143\\u7D20\\u5FC5\\u987B\\u4E3A\\u9009\\u4E2D\\u72B6\\u6001\\u3002\\u56E0\\u6B64\\u53EF\\u4EE5\\u5F52\\u7EB3\\u5143\\u7D20\\u7684\\u64CD\\u4F5C\\u5B9A\\u4E49\\u4E3A\\uFF1A\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"\\u9009\\u4E2D\\uFF1A\\u4ECE\\u672A\\u9009\\u4E2D\\u5230\\u9009\\u4E2D\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u79FB\\u52A8\\uFF1A\\u9009\\u4E2D\\u72B6\\u6001\\u4E0B\\uFF0C\\u70B9\\u51FB\\u4F4D\\u7F6E\\u5728\\u5143\\u7D20\\u5185\\uFF0C\\u4E14\\u4E0D\\u5728\\u64CD\\u4F5C\\u6309\\u94AE\\u4E0A\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u7F29\\u653E\\uFF1A\\u9009\\u4E2D\\u72B6\\u6001\\u4E0B\\uFF0C\\u70B9\\u51FB\\u4F4D\\u7F6E\\u5728\\u7F29\\u653E\\u6309\\u94AE\\u4E0A\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u5220\\u9664\\uFF1A\\u9009\\u4E2D\\u72B6\\u6001\\u4E0B\\uFF0C\\u70B9\\u51FB\\u4F4D\\u7F6E\\u5728\\u5220\\u9664\\u6309\\u94AE\\u4E0A\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"\\u70B9\\u51FB\\u65F6\\uFF0C\\u9700\\u8981\\u5BF9\\u4E0A\\u8FF0\\u72B6\\u6001\\u8FDB\\u884C\\u5224\\u65AD\\uFF0C\\u4EE5\\u786E\\u5B9A\\u5143\\u7D20\\u5F53\\u524D\\u7684\\u64CD\\u4F5C\\uFF1A\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`touchStart(e) {\n  const {x, y} = e.touches[0]\n  // \\u8BB0\\u5F55\\u9009\\u4E2D\\u7684\\u5143\\u7D20\\uFF0C\\u540C\\u4E00\\u4F4D\\u7F6E\\u53EF\\u80FD\\u9009\\u4E2D\\u591A\\u4E2A\n  this.selectedGraphs = []\n  // \\u8BB0\\u5F55\\u70B9\\u51FB\\u5F00\\u59CB\\u4F4D\\u7F6E\\u7684\\u5750\\u6807\\uFF0C\\u7528\\u4E8E\\u8BA1\\u7B97\\u5B9E\\u9645\\u7684\\u4F4D\\u79FB\\u91CF\n  this.touchStartPoint = {x, y}\n  let lastDeleteIndex\n  this.graphData.forEach((graph, index) =\u003e {\n    // \\u904D\\u5386\\u6240\\u6709\\u5DF2\\u5B58\\u5728\\u5143\\u7D20\\uFF0C\\u5224\\u65AD\\u70B9\\u51FB\\u4F4D\\u7F6E\\u662F\\u5426\\u5728\\u5143\\u7D20\\u5185\\uFF0C\\u5E76\\u66F4\\u65B0\\u9009\\u4E2D\\u72B6\\u6001\n    const isSelected = graph.isSelected(x, y)\n    const action = graph.getSelectedAction(x, y)\n    graph.action = action\n    // \\u672A\\u9009\\u4E2D =\u003e \\u9009\\u4E2D\n    if (isSelected \u0026\u0026 !graph.selected) {\n      graph.selected = true\n      graph.action = false\n      this.selectedGraphs.push(graph)\n      return\n    }\n    // \\u5DF2\\u9009\\u4E2D\n    if (graph.selected) {\n      // \\u5DF2\\u9009\\u4E2D\\uFF0C\\u79FB\\u52A8\n      if (isSelected \u0026\u0026 !action) {\n        graph.selected = true\n        this.selectedGraphs.push(graph)\n        return\n      }\n      // \\u5DF2\\u9009\\u4E2D\\uFF0C\\u6709\\u64CD\\u4F5C\\uFF08\\u5220\\u9664\\u6216\\u7F29\\u653E\\uFF09\n      if (action) {\n        graph.selected = true\n        this.selectedGraphs.push(graph)\n        if (action === 'delete') {\n          lastDeleteIndex = index\n        }\n        return\n      }\n    }\n    graph.selected = false\n  })\n  const lastIndex = this.selectedGraphs.length - 1\n  if (lastIndex \u003e= 0) {\n    // \\u5FAA\\u73AF\\uFF0C\\u91CD\\u7F6E\\u975E\\u6700\\u9876\\u5143\\u7D20\\u72B6\\u6001\n    let index = 0\n    while (index \u003c lastIndex) {\n      this.selectedGraphs[index].selected = false\n      this.selectedGraphs[index].action = false\n      index++\n    }\n    // \\u5220\\u9664\\u5143\\u7D20\n    const selected = this.selectedGraphs[lastIndex]\n    if (selected.action === 'delete' \u0026\u0026 lastDeleteIndex \u003e= 0) {\n      this.graphData.splice(lastDeleteIndex, 1)\n    }\n    // \\u8BB0\\u5F55\\u70B9\\u51FB\\u5F00\\u59CB\\u65F6\\u88AB\\u9009\\u4E2D\\u5143\\u7D20\\u7684\\u4F4D\\u7F6E\\uFF0C\\u7528\\u4E8E\\u8BA1\\u7B97\\u5B9E\\u9645\\u7684\\u4F4D\\u79FB\\u91CF\n    this.activeGraphOrigin = Object.assign({}, selected)\n  }\n  this.render()\n}\n`})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u5176\\u4E2D\\uFF0C\\u5220\\u9664\\u548C\\u79FB\\u52A8\\u7684\\u64CD\\u4F5C\\u90FD\\u6BD4\\u8F83\\u7B80\\u5355\\u3002\\u5220\\u9664\\u67D0\\u4E2A\\u5143\\u7D20\\uFF0C\\u53EA\\u9700\\u8981\\u5C06\\u8BE5\\u5143\\u7D20\\u4ECE\\u5143\\u7D20\\u5217\\u8868\\u4E2D\\u5220\\u9664\\uFF0C\\u5E76\\u91CD\\u65B0\\u7ED8\\u5236\\u5373\\u53EF\\u3002\\u800C\\u79FB\\u52A8\\u67D0\\u4E2A\\u5143\\u7D20\\uFF0C\\u5219\\u9700\\u8981\\u5C06\\u5F53\\u524D\\u624B\\u6307\\u79FB\\u52A8\\u7684\\u4F4D\\u7F6E\\u5750\\u6807\\uFF0C\\u5BF9\\u6BD4\\u539F\\u59CB\\u5750\\u6807\\uFF0C\\u8BA1\\u7B97\\u51FA\\u4F4D\\u79FB\\u91CF\\uFF0C\\u66F4\\u65B0\\u5143\\u7D20\\u7684\\u5750\\u6807\\u5C5E\\u6027\\uFF0C\\u5E76\\u91CD\\u65B0\\u7ED8\\u5236\\u5373\\u53EF\\u3002\"}),`\n`,(0,e.jsx)(n.h3,{children:\"\\u5143\\u7D20\\u7684\\u7F29\\u653E\"}),`\n`,(0,e.jsx)(n.p,{children:\"\\u7A0D\\u5FAE\\u590D\\u6742\\u70B9\\u7684\\uFF0C\\u662F\\u5143\\u7D20\\u7684\\u7F29\\u653E\\u64CD\\u4F5C\\u3002\\u8FD9\\u91CC\\u7684\\u7F29\\u653E\\u6548\\u679C\\u5E76\\u4E0D\\u662F\\u81EA\\u7531\\u62C9\\u4F38\\uFF0C\\u800C\\u662F\\u4FDD\\u6301\\u5143\\u7D20\\u7684\\u539F\\u59CB\\u6BD4\\u4F8B\\u4E0B\\u8FDB\\u884C\\u62C9\\u4F38\\u3002\\u7531\\u4E8E\\u6BD4\\u4F8B\\u59CB\\u7EC8\\u4FDD\\u6301\\uFF0C\\u5143\\u7D20\\u76F8\\u5F53\\u4E8E\\u53EA\\u80FD\\u5728\\u5176\\u5BF9\\u89D2\\u7EBF\\u4E0A\\u8FDB\\u884C\\u7F29\\u653E\\u3002\\u5F53\\u6211\\u4EEC\\u624B\\u6307\\u70B9\\u51FB\\u53F3\\u4E0B\\u89D2\\u7684\\u7F29\\u653E\\u6309\\u94AE\\u5E76\\u79FB\\u52A8\\u5230\\u65B0\\u7684\\u4F4D\\u7F6E\\u65F6\\uFF0C\\u5B9E\\u9645\\u7684\\u62C9\\u4F38\\u7684\\u8DDD\\u79BB\\u4E3A\\u79FB\\u52A8\\u7EC8\\u70B9\\u5728\\u5143\\u7D20\\u5BF9\\u89D2\\u7EBF\\u4E0A\\u7684\\u4F4D\\u79FB\\u3002\\u53EF\\u4EE5\\u753B\\u4E00\\u6761\\u5782\\u76F4\\u4E8E\\u5BF9\\u89D2\\u7EBF\\u5E76\\u7ECF\\u8FC7\\u79FB\\u52A8\\u7EC8\\u70B9\\u7684\\u76F4\\u7EBF\\uFF0C\\u5176\\u4E0E\\u5143\\u7D20\\u5BF9\\u89D2\\u7EBF\\u7684\\u4EA4\\u70B9\\u5373\\u4E3A\\u5143\\u7D20\\u6700\\u7EC8\\u7F29\\u653E\\u7684\\u4F4D\\u7F6E\\u3002\\u901A\\u8FC7\\u5BF9\\u6BD4\\u6700\\u7EC8\\u70B9\\u4F4D\\u7F6E\\u4E0E\\u539F\\u59CB\\u4F4D\\u7F6E\\u7684\\u6BD4\\u4F8B\\uFF0C\\u5F97\\u5230\\u5B9E\\u9645\\u7F29\\u653E\\u7684\\u6BD4\\u4F8B\\u3002\\u5982\\u56FE\\uFF1A\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/images/canvas-poster-sketchpad/scale.png\",alt:\"\\u5750\\u6807\\u56FE\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u5047\\u8BBE\\u5BF9\\u89D2\\u7EBF\\u7684\\u659C\\u7387\\u4E3A \",(0,e.jsx)(n.code,{children:\"k\"}),\"\\uFF0C\\u5143\\u7D20\\u7684\\u539F\\u59CB\\u4F4D\\u7F6E\\u4E3A \",(0,e.jsx)(n.code,{children:\"origin\"}),\"\\uFF0C\\u79FB\\u52A8\\u7EC8\\u70B9\\u5750\\u6807\\u4E3A \",(0,e.jsx)(n.code,{children:\"(x, y)\"}),\"\\u3002\\u901A\\u8FC7\\u6362\\u7B97\\u53EF\\u4EE5\\u5F97\\u5230\\uFF0C\\u4EA4\\u70B9\\u7684 x \\u5750\\u6807\\u4E3A \",(0,e.jsx)(n.code,{children:\"(k * (x + origin.x) + y - origin.y) / (2 * k)\"}),\"\\uFF0C\\u901A\\u8FC7\\u4E0B\\u9762\\u7684\\u65B9\\u6CD5\\uFF0C\\u53EF\\u4EE5\\u66F4\\u65B0\\u5143\\u7D20\\u7684\\u5750\\u6807\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`/**\n * \\u6309\\u6BD4\\u4F8B\\u7F29\\u653E\n * @param {\\u624B\\u6307\\u6240\\u5728\\u4F4D\\u7F6E x \\u5750\\u6807} x\n * @param {\\u624B\\u6307\\u6240\\u5728\\u4F4D\\u7F6E y \\u5750\\u6807} y\n * @param {\\u5143\\u7D20\\u7684\\u539F\\u59CB\\u4F4D\\u7F6E} origin\n */\nscale(x, y, origin) {\n  // \\u539F\\u59CB\\u5143\\u7D20\\u5BF9\\u89D2\\u7EBF\\u7684\\u659C\\u7387\n  const k = this.height / this.width\n  // \\u7ECF\\u8FC7\\u5F53\\u524D\\u4F4D\\u7F6E\\u4E0E\\u5143\\u7D20\\u5BF9\\u89D2\\u7EBF\\u5782\\u76F4\\u7EBF\\u4EA4\\u70B9\\u7684 x \\u5750\\u6807\n  const ix = (k * (x + origin.x) + y - origin.y) / (2 * k)\n  // \\u901A\\u8FC7\\u4EA4\\u70B9\\u5750\\u6807\\u7B97\\u51FA\\u7F29\\u653E\\u6BD4\\u4F8B\n  const scaleRatio = (ix - origin.x) / origin.width\n\n  // \\u6839\\u636E\\u7F29\\u653E\\u6BD4\\u4F8B\\u4E0E\\u5143\\u7D20\\u7C7B\\u578B\\uFF0C\\u8BA1\\u7B97\\u51FA\\u65B0\\u7684\\u5143\\u7D20\\u5C5E\\u6027\n  if (this.type === 'text') {\n    const newFontsize = origin.fontSize * scaleRatio\n    if (newFontsize \u003c MIN_FONTSIZE) return\n    this.fontSize = newFontsize\n  } else {\n    const newWidth = origin.width * scaleRatio\n    const newHeight = origin.height * scaleRatio\n    if (Math.min(newWidth, newHeight) \u003c MIN_IMAGE_SIZE) return\n    this.width = newWidth\n    this.height = newHeight\n  }\n}\n`})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u5176\\u5B9E\\u8FD8\\u5DEE\\u201C\\u5143\\u7D20\\u7684\\u65CB\\u8F6C\\u201D\\u529F\\u80FD\\uFF0C\\u4E0D\\u8FC7\\u7531\\u4E8E\\u5BA2\\u6237\\u6CA1\\u6709\\u8981\\u6C42\\uFF0C\\u9879\\u76EE\\u65F6\\u95F4\\u4E5F\\u6BD4\\u8F83\\u8D76\\uFF0C\\u5C31\\u6CA1\\u6709\\u5B9E\\u73B0\\u8FD9\\u4E00\\u5757\\u3002\\u7B49\\u4E4B\\u540E\\u6709\\u65F6\\u95F4\\uFF0C\\u518D\\u628A\\u8FD9\\u4E00\\u90E8\\u5206\\u5B8C\\u5584\\u4E86\\u3002\"})]})}function S(i={}){let{wrapper:n}=i.components||{};return n?(0,e.jsx)(n,Object.assign({},i,{children:(0,e.jsx)(l,i)})):l(i)}var E=S;return y(_);})();\n;return Component;"},"__N_SSG":true},"page":"/post/[id]","query":{"id":"canvas-poster-sketchpad"},"buildId":"5gWJ-3w7KsPABD87B5u4P","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>