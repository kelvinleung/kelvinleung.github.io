<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="description" content="Kelvin&#x27;s blog"/><link rel="icon" href="/images/favicon.ico"/><title>Axios 源码阅读笔记之——徒手撕 Ajax（二）</title><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/beb59a9e1165a44b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/beb59a9e1165a44b.css" data-n-g=""/><link rel="preload" href="/_next/static/css/5efe62c786a6b4f4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5efe62c786a6b4f4.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-81f4fb35f4507347.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7000df9582a09740.js" defer=""></script><script src="/_next/static/chunks/323-451496564d94cd92.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bid%5D-b4b49da35f214cd7.js" defer=""></script><script src="/_next/static/i85zbTreoVlPV-vsvfmmV/_buildManifest.js" defer=""></script><script src="/_next/static/i85zbTreoVlPV-vsvfmmV/_ssgManifest.js" defer=""></script><script src="/_next/static/i85zbTreoVlPV-vsvfmmV/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="container"><nav class="navbar"><div class="navbar-content"><div class="navbar-menu-container"><ul class="navbar-menu"><li><a href="/">首页</a></li><li><a href="/posts/horse-sense">秘籍</a></li><li><a href="/posts/gibberish">八股</a></li><li><a href="/posts/xray">庖丁</a></li><li><a href="/posts/copycat">画瓢</a></li></ul></div></div></nav><main class="main"><main><article class="post-container"><div class="post-title-container"><h1 class="post-title">Axios 源码阅读笔记之——徒手撕 Ajax（二）</h1><p class="post-date">JAN 14, 2022</p></div><p><a href="/post/recreate-axios-from-scratch-i">上一次</a>我们已经封装了一个“简陋版”的 Axios，实现了配置化，多种方式调用，Promise 化等功能。除此以外，Axios 还有两个很重要的功能：</p>
<ul>
<li>拦截器</li>
<li>取消请求</li>
</ul>
<p>这一次我们先来实现一个拦截器的功能。</p>
<h2>单个请求拦截器</h2>
<p>我们知道，Ajax 请求可以粗略地分为三个阶段：</p>
<ol>
<li>请求前，处理配置等</li>
<li>请求中，等待服务器响应</li>
<li>响应，得到结果或异常</li>
</ol>
<p>拦截器其实就是作用在请求前、后（响应）这两个阶段的“钩子”，允许我们对请求的配置、请求的响应、异常等进行处理。先拿请求的拦截器来举例，比方说我们现在有个需求，希望在请求前，能够先对请求的数据进行某种特定的编码，那么这段逻辑我们可以添加在<code>request()</code>函数中。但是这样一来，逻辑就被写死，每次修改都需要改动<code>request()</code>函数的代码，不符合“开放封闭”的原则。</p>
<p>因此，我们得把拦截器抽取出来，放在另一个地方，暴露一个方法用于设置拦截器，然后在请求前调用进行处理，再将处理后的结果用于请求。根据这个思路，可以像下面这样实现：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Axios</span><span class="token punctuation">(</span><span class="token parameter">instanceConfig</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token comment">// 默认的配置</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> instanceConfig</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">  </span><span class="token comment">// 拦截器，在请求前调用</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptor</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setRequestInterceptor</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptor</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> interceptor</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">request</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">configOrUrl</span><span class="token parameter punctuation">,</span><span class="token parameter"> config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">  </span><span class="token comment">/**</span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token comment">   * 省略</span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token comment">   */</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">  </span><span class="token comment">// 先调用拦截器进行处理</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> newConfig </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">requestInterceptor</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">dispatchRequest</span><span class="token punctuation">(</span><span class="token plain">newConfig</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain"></span><span class="token comment">// 假设函数 encode() 返回特殊编码后的数据</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain"></span><span class="token comment">// 设置拦截器</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method function property-access">setRequestInterceptor</span><span class="token punctuation">(</span><span class="token plain">encode</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<h2>多个请求拦截器</h2>
<p>看上去还不错，那么假如我们的需求不只是编码，还希望在编码后对数据进行压缩呢？简单，把<code>interceptor</code>属性换成数组，然后在请求前遍历一下，像这样：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Axios</span><span class="token punctuation">(</span><span class="token parameter">instanceConfig</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> instanceConfig</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">  </span><span class="token comment">// 拦截器，改成数组</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setRequestInterceptor</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">  </span><span class="token comment">// 按顺序压进数组中</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">interceptor</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">request</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">configOrUrl</span><span class="token parameter punctuation">,</span><span class="token parameter"> config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">  </span><span class="token comment">/**</span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token comment">   * 省略</span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token comment">   */</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">  </span><span class="token comment">// 遍历所有拦截器</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> interceptor </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">    config </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">interceptor</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">dispatchRequest</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain"></span><span class="token comment">// 假设函数 encode() 返回特殊编码后的数据</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">26</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">27</span><span class="token plain"></span><span class="token comment">// 设置拦截器</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">28</span><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method function property-access">setRequestInterceptor</span><span class="token punctuation">(</span><span class="token plain">encode</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<h2>响应拦截器</h2>
<p>对于响应拦截器，也是同样的道理，增加一个<code>responseInterceptors</code>属性用于保存响应拦截器，再增加一个<code>setRe sponseInterceptor()</code>方法来设置响应拦截器。</p>
<p>与请求拦截器所不同的是，响应拦截器的调用的时机应该放在请求之后，也就是<code>dispatchRequest()</code>方法之后执行。<code>dispatchRequest()</code>方法返回的是一个 Promise，因此响应拦截器要在<code>dispatchRequest().then()</code>中去遍历执行。简化的代码框架如下：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Axios</span><span class="token punctuation">(</span><span class="token parameter">instanceConfig</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> instanceConfig</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">responseInterceptors</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setRequestInterceptor</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">interceptor</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setResponseInterceptor</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">responseInterceptors</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">interceptor</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">request</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">configOrUrl</span><span class="token parameter punctuation">,</span><span class="token parameter"> config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">  </span><span class="token comment">/**</span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token comment">   * 省略</span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token comment">   */</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> interceptor </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">    config </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">interceptor</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> res</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain">  </span><span class="token function">dispatchRequest</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">responseInterceptors</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">26</span><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> interceptor </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">responseInterceptors</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">27</span><span class="token plain">      res </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">interceptor</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">28</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">29</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">30</span><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> res</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">31</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">32</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">33</span><span class="token plain"></span><span class="token comment">// 假设函数 encode() 返回特殊编码后的数据</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">34</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">35</span><span class="token plain"></span><span class="token comment">// 假设函数 decode() 返回特殊解码后的数据</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">36</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">37</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">38</span><span class="token plain"></span><span class="token comment">// 设置拦截器</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">39</span><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method function property-access">setRequestInterceptor</span><span class="token punctuation">(</span><span class="token plain">encode</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">40</span><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method function property-access">setResponseInterceptor</span><span class="token punctuation">(</span><span class="token plain">decode</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<h2>Promise 链</h2>
<p>嗯，上面的代码看上去貌似就不太优雅……请求拦截器和响应拦截器被分成了两块，但它们又有着相似的逻辑。同样是把某个东西加工后返回，然后交给下一个按顺序遍历执行，这种“链式调用”的场景，你会想到什么？没错，就是<code>Promise</code>。</p>
<p>通过 Promise，我们可以将这些处理的逻辑串连起来。并且使用 Promise 还有个好处就是异常的处理，我们可以把拦截器拆成一对，分别处理成功和失败的情况：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">encode</span><span class="token punctuation">,</span><span class="token plain"> onError1</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">zip</span><span class="token punctuation">,</span><span class="token plain"> onError2</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">request</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">unzip</span><span class="token punctuation">,</span><span class="token plain"> onError3</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">decode</span><span class="token punctuation">,</span><span class="token plain"> onError4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p>通过下面的图，我们可以更清晰地看到整个请求的链路：</p>
<p><img src="/images/recreate-axios-from-scratch/chain.png" alt="chain"/></p>
<p>利用 Promise，我们能够让拦截器处理异步的操作，同时还能够处理每个节点的异常。更妙的是，我们将请求拦截器、请求方法、响应拦截器一块放到一个数组中，通过遍历，每次取出一对方法，便能很优雅地利用 Promise 的<code>then()</code>方法来串连起它们。对于请求方法的那一对，我们用<code>undefined</code>来占位，则请求的异常将穿透给其下一对，即响应拦截器来处理。</p>
<p><img src="/images/recreate-axios-from-scratch/chain-array.png" alt="chain-array"/></p>
<h2>小结</h2>
<p>综上所述，我们将拦截器相关的方法抽取成一个类<code>InterceptorManager</code>，按新的思路调整后的简化代码如下：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">InterceptorManager</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handlers</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">  </span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">fulfilled</span><span class="token parameter punctuation">,</span><span class="token parameter"> rejected</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handlers</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> fulfilled</span><span class="token punctuation">,</span><span class="token plain"> rejected </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">    </span><span class="token comment">// 下标作为 id，用于 eject</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handlers</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">  </span><span class="token function">eject</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handlers</span><span class="token punctuation">[</span><span class="token plain">id</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handlers</span><span class="token punctuation">[</span><span class="token plain">id</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">  </span><span class="token comment">// null 时不处理</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">  </span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handlers</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">interceptor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain">        </span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token plain">interceptor</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">26</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">27</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">28</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Axios</span><span class="token punctuation">(</span><span class="token parameter">instanceConfig</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">29</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> instanceConfig</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">30</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">interceptors</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">31</span><span class="token plain">    </span><span class="token literal-property property">request</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">InterceptorManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">32</span><span class="token plain">    </span><span class="token literal-property property">response</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">InterceptorManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">33</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">34</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">35</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">36</span><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">request</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">configOrUrl</span><span class="token parameter punctuation">,</span><span class="token parameter"> config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">37</span><span class="token plain">  </span><span class="token comment">/**</span></span><span class="token-line"><span class="code-block-line-number">38</span><span class="token comment">   * 省略</span></span><span class="token-line"><span class="code-block-line-number">39</span><span class="token comment">   */</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">40</span><span class="token plain">  </span><span class="token comment">// 拼接成 [请求拦截器, 请求, 响应拦截器] 请求链</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">41</span><span class="token plain">  </span><span class="token comment">// undefined 的作用是“占位”，保证两两一组</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">42</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> chain </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">dispatchRequest</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">43</span><span class="token plain">  </span><span class="token comment">// 请求拦截器“链”，加到头部</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">44</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">interceptors</span><span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> fulfilled</span><span class="token parameter punctuation">,</span><span class="token parameter"> rejected </span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">45</span><span class="token plain">    chain</span><span class="token punctuation">.</span><span class="token method function property-access">unshift</span><span class="token punctuation">(</span><span class="token plain">fulfilled</span><span class="token punctuation">,</span><span class="token plain"> rejected</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">46</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">47</span><span class="token plain">  </span><span class="token comment">// 响应拦截器“链”，加到尾部</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">48</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">interceptors</span><span class="token punctuation">.</span><span class="token property-access">response</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> fulfilled</span><span class="token parameter punctuation">,</span><span class="token parameter"> rejected </span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">49</span><span class="token plain">    chain</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">fulfilled</span><span class="token punctuation">,</span><span class="token plain"> rejected</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">50</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">51</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">52</span><span class="token plain">  </span><span class="token comment">// 启动链条</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">53</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> promise </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">54</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">55</span><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">chain</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">56</span><span class="token plain">    </span><span class="token comment">// 遍历请求链，两两一组链式调用</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">57</span><span class="token plain">    promise </span><span class="token operator">=</span><span class="token plain"> promise</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">chain</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> chain</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">58</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">59</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">60</span><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> promise</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">61</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p>到此为止，我们就完成了简单拦截器的功能，使用方式也很简单，我们只需设置一下拦截器，然后正常发起请求即可：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token comment">// 添加请求拦截器</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token property-access">interceptors</span><span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">    </span><span class="token comment">// 请求前处理的逻辑放在这里</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> config</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">    </span><span class="token comment">// 异常处理的逻辑放在这里</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">reject</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain"></span><span class="token comment">// 添加响应拦截器</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token property-access">interceptors</span><span class="token punctuation">.</span><span class="token property-access">response</span><span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">    </span><span class="token comment">// 对响应结果的处理逻辑放在这里</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> response</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">    </span><span class="token comment">// 异常处理的逻辑放在这里</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">reject</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p>完整代码可以在<a href="https://github.com/kelvinleung/re-create.js/tree/main/axios">这里查看</a>。接下来我们还要手撕<strong>取消请求</strong>，详见第三部分。</p></article></main></main><footer><div>Build with ♥ @GZ</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"meta":{"title":"Axios 源码阅读笔记之——徒手撕 Ajax（二）","date":"JAN 14, 2022","desc":"上一次我们已经封装了一个“简陋版”的 Axios，实现了配置化，多种方式调用，Promise 化等功能。除此以外，Axios 还有两个很重要的功能：拦截器、取消请求。这一次我们先来实现一个拦截器的功能。","type":"xray"},"code":"var Component=(()=\u003e{var d=Object.create;var o=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var a=Object.getOwnPropertyNames;var u=Object.getPrototypeOf,f=Object.prototype.hasOwnProperty;var g=(r,t)=\u003e()=\u003e(t||r((t={exports:{}}).exports,t),t.exports),m=(r,t)=\u003e{for(var i in t)o(r,i,{get:t[i],enumerable:!0})},c=(r,t,i,e)=\u003e{if(t\u0026\u0026typeof t==\"object\"||typeof t==\"function\")for(let s of a(t))!f.call(r,s)\u0026\u0026s!==i\u0026\u0026o(r,s,{get:()=\u003et[s],enumerable:!(e=p(t,s))||e.enumerable});return r};var x=(r,t,i)=\u003e(i=r!=null?d(u(r)):{},c(t||!r||!r.__esModule?o(i,\"default\",{value:r,enumerable:!0}):i,r)),q=r=\u003ec(o({},\"__esModule\",{value:!0}),r);var l=g((P,h)=\u003e{h.exports=_jsx_runtime});var R={};m(R,{default:()=\u003eA,frontmatter:()=\u003eI});var n=x(l()),I={title:\"Axios \\u6E90\\u7801\\u9605\\u8BFB\\u7B14\\u8BB0\\u4E4B\\u2014\\u2014\\u5F92\\u624B\\u6495 Ajax\\uFF08\\u4E8C\\uFF09\",date:\"JAN 14, 2022\",desc:\"\\u4E0A\\u4E00\\u6B21\\u6211\\u4EEC\\u5DF2\\u7ECF\\u5C01\\u88C5\\u4E86\\u4E00\\u4E2A\\u201C\\u7B80\\u964B\\u7248\\u201D\\u7684 Axios\\uFF0C\\u5B9E\\u73B0\\u4E86\\u914D\\u7F6E\\u5316\\uFF0C\\u591A\\u79CD\\u65B9\\u5F0F\\u8C03\\u7528\\uFF0CPromise \\u5316\\u7B49\\u529F\\u80FD\\u3002\\u9664\\u6B64\\u4EE5\\u5916\\uFF0CAxios \\u8FD8\\u6709\\u4E24\\u4E2A\\u5F88\\u91CD\\u8981\\u7684\\u529F\\u80FD\\uFF1A\\u62E6\\u622A\\u5668\\u3001\\u53D6\\u6D88\\u8BF7\\u6C42\\u3002\\u8FD9\\u4E00\\u6B21\\u6211\\u4EEC\\u5148\\u6765\\u5B9E\\u73B0\\u4E00\\u4E2A\\u62E6\\u622A\\u5668\\u7684\\u529F\\u80FD\\u3002\",type:\"xray\"};function j(r={}){let{wrapper:t}=r.components||{};return t?(0,n.jsx)(t,Object.assign({},r,{children:(0,n.jsx)(i,{})})):i();function i(){let e=Object.assign({p:\"p\",a:\"a\",ul:\"ul\",li:\"li\",h2:\"h2\",ol:\"ol\",code:\"code\",pre:\"pre\",img:\"img\",strong:\"strong\"},r.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.a,{href:\"/post/recreate-axios-from-scratch-i\",children:\"\\u4E0A\\u4E00\\u6B21\"}),\"\\u6211\\u4EEC\\u5DF2\\u7ECF\\u5C01\\u88C5\\u4E86\\u4E00\\u4E2A\\u201C\\u7B80\\u964B\\u7248\\u201D\\u7684 Axios\\uFF0C\\u5B9E\\u73B0\\u4E86\\u914D\\u7F6E\\u5316\\uFF0C\\u591A\\u79CD\\u65B9\\u5F0F\\u8C03\\u7528\\uFF0CPromise \\u5316\\u7B49\\u529F\\u80FD\\u3002\\u9664\\u6B64\\u4EE5\\u5916\\uFF0CAxios \\u8FD8\\u6709\\u4E24\\u4E2A\\u5F88\\u91CD\\u8981\\u7684\\u529F\\u80FD\\uFF1A\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"\\u62E6\\u622A\\u5668\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u53D6\\u6D88\\u8BF7\\u6C42\"}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u8FD9\\u4E00\\u6B21\\u6211\\u4EEC\\u5148\\u6765\\u5B9E\\u73B0\\u4E00\\u4E2A\\u62E6\\u622A\\u5668\\u7684\\u529F\\u80FD\\u3002\"}),`\n`,(0,n.jsx)(e.h2,{children:\"\\u5355\\u4E2A\\u8BF7\\u6C42\\u62E6\\u622A\\u5668\"}),`\n`,(0,n.jsx)(e.p,{children:\"\\u6211\\u4EEC\\u77E5\\u9053\\uFF0CAjax \\u8BF7\\u6C42\\u53EF\\u4EE5\\u7C97\\u7565\\u5730\\u5206\\u4E3A\\u4E09\\u4E2A\\u9636\\u6BB5\\uFF1A\"}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsx)(e.li,{children:\"\\u8BF7\\u6C42\\u524D\\uFF0C\\u5904\\u7406\\u914D\\u7F6E\\u7B49\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u8BF7\\u6C42\\u4E2D\\uFF0C\\u7B49\\u5F85\\u670D\\u52A1\\u5668\\u54CD\\u5E94\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u54CD\\u5E94\\uFF0C\\u5F97\\u5230\\u7ED3\\u679C\\u6216\\u5F02\\u5E38\"}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u62E6\\u622A\\u5668\\u5176\\u5B9E\\u5C31\\u662F\\u4F5C\\u7528\\u5728\\u8BF7\\u6C42\\u524D\\u3001\\u540E\\uFF08\\u54CD\\u5E94\\uFF09\\u8FD9\\u4E24\\u4E2A\\u9636\\u6BB5\\u7684\\u201C\\u94A9\\u5B50\\u201D\\uFF0C\\u5141\\u8BB8\\u6211\\u4EEC\\u5BF9\\u8BF7\\u6C42\\u7684\\u914D\\u7F6E\\u3001\\u8BF7\\u6C42\\u7684\\u54CD\\u5E94\\u3001\\u5F02\\u5E38\\u7B49\\u8FDB\\u884C\\u5904\\u7406\\u3002\\u5148\\u62FF\\u8BF7\\u6C42\\u7684\\u62E6\\u622A\\u5668\\u6765\\u4E3E\\u4F8B\\uFF0C\\u6BD4\\u65B9\\u8BF4\\u6211\\u4EEC\\u73B0\\u5728\\u6709\\u4E2A\\u9700\\u6C42\\uFF0C\\u5E0C\\u671B\\u5728\\u8BF7\\u6C42\\u524D\\uFF0C\\u80FD\\u591F\\u5148\\u5BF9\\u8BF7\\u6C42\\u7684\\u6570\\u636E\\u8FDB\\u884C\\u67D0\\u79CD\\u7279\\u5B9A\\u7684\\u7F16\\u7801\\uFF0C\\u90A3\\u4E48\\u8FD9\\u6BB5\\u903B\\u8F91\\u6211\\u4EEC\\u53EF\\u4EE5\\u6DFB\\u52A0\\u5728\",(0,n.jsx)(e.code,{children:\"request()\"}),\"\\u51FD\\u6570\\u4E2D\\u3002\\u4F46\\u662F\\u8FD9\\u6837\\u4E00\\u6765\\uFF0C\\u903B\\u8F91\\u5C31\\u88AB\\u5199\\u6B7B\\uFF0C\\u6BCF\\u6B21\\u4FEE\\u6539\\u90FD\\u9700\\u8981\\u6539\\u52A8\",(0,n.jsx)(e.code,{children:\"request()\"}),\"\\u51FD\\u6570\\u7684\\u4EE3\\u7801\\uFF0C\\u4E0D\\u7B26\\u5408\\u201C\\u5F00\\u653E\\u5C01\\u95ED\\u201D\\u7684\\u539F\\u5219\\u3002\"]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u56E0\\u6B64\\uFF0C\\u6211\\u4EEC\\u5F97\\u628A\\u62E6\\u622A\\u5668\\u62BD\\u53D6\\u51FA\\u6765\\uFF0C\\u653E\\u5728\\u53E6\\u4E00\\u4E2A\\u5730\\u65B9\\uFF0C\\u66B4\\u9732\\u4E00\\u4E2A\\u65B9\\u6CD5\\u7528\\u4E8E\\u8BBE\\u7F6E\\u62E6\\u622A\\u5668\\uFF0C\\u7136\\u540E\\u5728\\u8BF7\\u6C42\\u524D\\u8C03\\u7528\\u8FDB\\u884C\\u5904\\u7406\\uFF0C\\u518D\\u5C06\\u5904\\u7406\\u540E\\u7684\\u7ED3\\u679C\\u7528\\u4E8E\\u8BF7\\u6C42\\u3002\\u6839\\u636E\\u8FD9\\u4E2A\\u601D\\u8DEF\\uFF0C\\u53EF\\u4EE5\\u50CF\\u4E0B\\u9762\\u8FD9\\u6837\\u5B9E\\u73B0\\uFF1A\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`function Axios(instanceConfig) {\n  // \\u9ED8\\u8BA4\\u7684\\u914D\\u7F6E\n  this.defaults = instanceConfig;\n  // \\u62E6\\u622A\\u5668\\uFF0C\\u5728\\u8BF7\\u6C42\\u524D\\u8C03\\u7528\n  this.requestInterceptor = null;\n}\n\nAxios.prototype.setRequestInterceptor = function (interceptor) {\n  this.requestInterceptor = interceptor;\n};\n\nAxios.prototype.request = function request(configOrUrl, config) {\n  /**\n   * \\u7701\\u7565\n   */\n  // \\u5148\\u8C03\\u7528\\u62E6\\u622A\\u5668\\u8FDB\\u884C\\u5904\\u7406\n  const newConfig = this.requestInterceptor(config);\n  return dispatchRequest(newConfig);\n};\n\n// \\u5047\\u8BBE\\u51FD\\u6570 encode() \\u8FD4\\u56DE\\u7279\\u6B8A\\u7F16\\u7801\\u540E\\u7684\\u6570\\u636E\nfunction encode(config) {}\n\n// \\u8BBE\\u7F6E\\u62E6\\u622A\\u5668\naxios.setRequestInterceptor(encode);\n`})}),`\n`,(0,n.jsx)(e.h2,{children:\"\\u591A\\u4E2A\\u8BF7\\u6C42\\u62E6\\u622A\\u5668\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u770B\\u4E0A\\u53BB\\u8FD8\\u4E0D\\u9519\\uFF0C\\u90A3\\u4E48\\u5047\\u5982\\u6211\\u4EEC\\u7684\\u9700\\u6C42\\u4E0D\\u53EA\\u662F\\u7F16\\u7801\\uFF0C\\u8FD8\\u5E0C\\u671B\\u5728\\u7F16\\u7801\\u540E\\u5BF9\\u6570\\u636E\\u8FDB\\u884C\\u538B\\u7F29\\u5462\\uFF1F\\u7B80\\u5355\\uFF0C\\u628A\",(0,n.jsx)(e.code,{children:\"interceptor\"}),\"\\u5C5E\\u6027\\u6362\\u6210\\u6570\\u7EC4\\uFF0C\\u7136\\u540E\\u5728\\u8BF7\\u6C42\\u524D\\u904D\\u5386\\u4E00\\u4E0B\\uFF0C\\u50CF\\u8FD9\\u6837\\uFF1A\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`function Axios(instanceConfig) {\n  this.defaults = instanceConfig;\n  // \\u62E6\\u622A\\u5668\\uFF0C\\u6539\\u6210\\u6570\\u7EC4\n  this.requestInterceptors = [];\n}\n\nAxios.prototype.setRequestInterceptor = function (interceptor) {\n  // \\u6309\\u987A\\u5E8F\\u538B\\u8FDB\\u6570\\u7EC4\\u4E2D\n  this.requestInterceptors.push(interceptor);\n};\n\nAxios.prototype.request = function request(configOrUrl, config) {\n  /**\n   * \\u7701\\u7565\n   */\n  // \\u904D\\u5386\\u6240\\u6709\\u62E6\\u622A\\u5668\n  while (this.requestInterceptors.length) {\n    const interceptor = this.requestInterceptors.shift();\n    config = interceptor(config);\n  }\n  return dispatchRequest(config);\n};\n\n// \\u5047\\u8BBE\\u51FD\\u6570 encode() \\u8FD4\\u56DE\\u7279\\u6B8A\\u7F16\\u7801\\u540E\\u7684\\u6570\\u636E\nfunction encode(config) {}\n\n// \\u8BBE\\u7F6E\\u62E6\\u622A\\u5668\naxios.setRequestInterceptor(encode);\n`})}),`\n`,(0,n.jsx)(e.h2,{children:\"\\u54CD\\u5E94\\u62E6\\u622A\\u5668\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u5BF9\\u4E8E\\u54CD\\u5E94\\u62E6\\u622A\\u5668\\uFF0C\\u4E5F\\u662F\\u540C\\u6837\\u7684\\u9053\\u7406\\uFF0C\\u589E\\u52A0\\u4E00\\u4E2A\",(0,n.jsx)(e.code,{children:\"responseInterceptors\"}),\"\\u5C5E\\u6027\\u7528\\u4E8E\\u4FDD\\u5B58\\u54CD\\u5E94\\u62E6\\u622A\\u5668\\uFF0C\\u518D\\u589E\\u52A0\\u4E00\\u4E2A\",(0,n.jsx)(e.code,{children:\"setRe sponseInterceptor()\"}),\"\\u65B9\\u6CD5\\u6765\\u8BBE\\u7F6E\\u54CD\\u5E94\\u62E6\\u622A\\u5668\\u3002\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u4E0E\\u8BF7\\u6C42\\u62E6\\u622A\\u5668\\u6240\\u4E0D\\u540C\\u7684\\u662F\\uFF0C\\u54CD\\u5E94\\u62E6\\u622A\\u5668\\u7684\\u8C03\\u7528\\u7684\\u65F6\\u673A\\u5E94\\u8BE5\\u653E\\u5728\\u8BF7\\u6C42\\u4E4B\\u540E\\uFF0C\\u4E5F\\u5C31\\u662F\",(0,n.jsx)(e.code,{children:\"dispatchRequest()\"}),\"\\u65B9\\u6CD5\\u4E4B\\u540E\\u6267\\u884C\\u3002\",(0,n.jsx)(e.code,{children:\"dispatchRequest()\"}),\"\\u65B9\\u6CD5\\u8FD4\\u56DE\\u7684\\u662F\\u4E00\\u4E2A Promise\\uFF0C\\u56E0\\u6B64\\u54CD\\u5E94\\u62E6\\u622A\\u5668\\u8981\\u5728\",(0,n.jsx)(e.code,{children:\"dispatchRequest().then()\"}),\"\\u4E2D\\u53BB\\u904D\\u5386\\u6267\\u884C\\u3002\\u7B80\\u5316\\u7684\\u4EE3\\u7801\\u6846\\u67B6\\u5982\\u4E0B\\uFF1A\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`function Axios(instanceConfig) {\n  this.defaults = instanceConfig;\n  this.requestInterceptors = [];\n  this.responseInterceptors = [];\n}\n\nAxios.prototype.setRequestInterceptor = function (interceptor) {\n  this.requestInterceptors.push(interceptor);\n};\n\nAxios.prototype.setResponseInterceptor = function (interceptor) {\n  this.responseInterceptors.push(interceptor);\n};\n\nAxios.prototype.request = function request(configOrUrl, config) {\n  /**\n   * \\u7701\\u7565\n   */\n  while (this.requestInterceptors.length) {\n    const interceptor = this.requestInterceptors.shift();\n    config = interceptor(config);\n  }\n  let res;\n  dispatchRequest(config).then((res) =\u003e {\n    while (this.responseInterceptors.length) {\n      const interceptor = this.responseInterceptors.shift();\n      res = interceptor(res);\n    }\n  });\n  return res;\n};\n\n// \\u5047\\u8BBE\\u51FD\\u6570 encode() \\u8FD4\\u56DE\\u7279\\u6B8A\\u7F16\\u7801\\u540E\\u7684\\u6570\\u636E\nfunction encode(config) {}\n// \\u5047\\u8BBE\\u51FD\\u6570 decode() \\u8FD4\\u56DE\\u7279\\u6B8A\\u89E3\\u7801\\u540E\\u7684\\u6570\\u636E\nfunction decode(res) {}\n\n// \\u8BBE\\u7F6E\\u62E6\\u622A\\u5668\naxios.setRequestInterceptor(encode);\naxios.setResponseInterceptor(decode);\n`})}),`\n`,(0,n.jsx)(e.h2,{children:\"Promise \\u94FE\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u55EF\\uFF0C\\u4E0A\\u9762\\u7684\\u4EE3\\u7801\\u770B\\u4E0A\\u53BB\\u8C8C\\u4F3C\\u5C31\\u4E0D\\u592A\\u4F18\\u96C5\\u2026\\u2026\\u8BF7\\u6C42\\u62E6\\u622A\\u5668\\u548C\\u54CD\\u5E94\\u62E6\\u622A\\u5668\\u88AB\\u5206\\u6210\\u4E86\\u4E24\\u5757\\uFF0C\\u4F46\\u5B83\\u4EEC\\u53C8\\u6709\\u7740\\u76F8\\u4F3C\\u7684\\u903B\\u8F91\\u3002\\u540C\\u6837\\u662F\\u628A\\u67D0\\u4E2A\\u4E1C\\u897F\\u52A0\\u5DE5\\u540E\\u8FD4\\u56DE\\uFF0C\\u7136\\u540E\\u4EA4\\u7ED9\\u4E0B\\u4E00\\u4E2A\\u6309\\u987A\\u5E8F\\u904D\\u5386\\u6267\\u884C\\uFF0C\\u8FD9\\u79CD\\u201C\\u94FE\\u5F0F\\u8C03\\u7528\\u201D\\u7684\\u573A\\u666F\\uFF0C\\u4F60\\u4F1A\\u60F3\\u5230\\u4EC0\\u4E48\\uFF1F\\u6CA1\\u9519\\uFF0C\\u5C31\\u662F\",(0,n.jsx)(e.code,{children:\"Promise\"}),\"\\u3002\"]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u901A\\u8FC7 Promise\\uFF0C\\u6211\\u4EEC\\u53EF\\u4EE5\\u5C06\\u8FD9\\u4E9B\\u5904\\u7406\\u7684\\u903B\\u8F91\\u4E32\\u8FDE\\u8D77\\u6765\\u3002\\u5E76\\u4E14\\u4F7F\\u7528 Promise \\u8FD8\\u6709\\u4E2A\\u597D\\u5904\\u5C31\\u662F\\u5F02\\u5E38\\u7684\\u5904\\u7406\\uFF0C\\u6211\\u4EEC\\u53EF\\u4EE5\\u628A\\u62E6\\u622A\\u5668\\u62C6\\u6210\\u4E00\\u5BF9\\uFF0C\\u5206\\u522B\\u5904\\u7406\\u6210\\u529F\\u548C\\u5931\\u8D25\\u7684\\u60C5\\u51B5\\uFF1A\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`Promise.resolve(config)\n  .then(encode, onError1)\n  .then(zip, onError2)\n  .request(config)\n  .then(unzip, onError3)\n  .then(decode, onError4);\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"\\u901A\\u8FC7\\u4E0B\\u9762\\u7684\\u56FE\\uFF0C\\u6211\\u4EEC\\u53EF\\u4EE5\\u66F4\\u6E05\\u6670\\u5730\\u770B\\u5230\\u6574\\u4E2A\\u8BF7\\u6C42\\u7684\\u94FE\\u8DEF\\uFF1A\"}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/images/recreate-axios-from-scratch/chain.png\",alt:\"chain\"})}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u5229\\u7528 Promise\\uFF0C\\u6211\\u4EEC\\u80FD\\u591F\\u8BA9\\u62E6\\u622A\\u5668\\u5904\\u7406\\u5F02\\u6B65\\u7684\\u64CD\\u4F5C\\uFF0C\\u540C\\u65F6\\u8FD8\\u80FD\\u591F\\u5904\\u7406\\u6BCF\\u4E2A\\u8282\\u70B9\\u7684\\u5F02\\u5E38\\u3002\\u66F4\\u5999\\u7684\\u662F\\uFF0C\\u6211\\u4EEC\\u5C06\\u8BF7\\u6C42\\u62E6\\u622A\\u5668\\u3001\\u8BF7\\u6C42\\u65B9\\u6CD5\\u3001\\u54CD\\u5E94\\u62E6\\u622A\\u5668\\u4E00\\u5757\\u653E\\u5230\\u4E00\\u4E2A\\u6570\\u7EC4\\u4E2D\\uFF0C\\u901A\\u8FC7\\u904D\\u5386\\uFF0C\\u6BCF\\u6B21\\u53D6\\u51FA\\u4E00\\u5BF9\\u65B9\\u6CD5\\uFF0C\\u4FBF\\u80FD\\u5F88\\u4F18\\u96C5\\u5730\\u5229\\u7528 Promise \\u7684\",(0,n.jsx)(e.code,{children:\"then()\"}),\"\\u65B9\\u6CD5\\u6765\\u4E32\\u8FDE\\u8D77\\u5B83\\u4EEC\\u3002\\u5BF9\\u4E8E\\u8BF7\\u6C42\\u65B9\\u6CD5\\u7684\\u90A3\\u4E00\\u5BF9\\uFF0C\\u6211\\u4EEC\\u7528\",(0,n.jsx)(e.code,{children:\"undefined\"}),\"\\u6765\\u5360\\u4F4D\\uFF0C\\u5219\\u8BF7\\u6C42\\u7684\\u5F02\\u5E38\\u5C06\\u7A7F\\u900F\\u7ED9\\u5176\\u4E0B\\u4E00\\u5BF9\\uFF0C\\u5373\\u54CD\\u5E94\\u62E6\\u622A\\u5668\\u6765\\u5904\\u7406\\u3002\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{src:\"/images/recreate-axios-from-scratch/chain-array.png\",alt:\"chain-array\"})}),`\n`,(0,n.jsx)(e.h2,{children:\"\\u5C0F\\u7ED3\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u7EFC\\u4E0A\\u6240\\u8FF0\\uFF0C\\u6211\\u4EEC\\u5C06\\u62E6\\u622A\\u5668\\u76F8\\u5173\\u7684\\u65B9\\u6CD5\\u62BD\\u53D6\\u6210\\u4E00\\u4E2A\\u7C7B\",(0,n.jsx)(e.code,{children:\"InterceptorManager\"}),\"\\uFF0C\\u6309\\u65B0\\u7684\\u601D\\u8DEF\\u8C03\\u6574\\u540E\\u7684\\u7B80\\u5316\\u4EE3\\u7801\\u5982\\u4E0B\\uFF1A\"]}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`class InterceptorManager {\n  constructor() {\n    this.handlers = [];\n  }\n\n  use(fulfilled, rejected) {\n    this.handlers.push({ fulfilled, rejected });\n    // \\u4E0B\\u6807\\u4F5C\\u4E3A id\\uFF0C\\u7528\\u4E8E eject\n    return this.handlers.length - 1;\n  }\n\n  eject(id) {\n    if (this.handlers[id]) {\n      this.handlers[id] = null;\n    }\n  }\n\n  // null \\u65F6\\u4E0D\\u5904\\u7406\n  forEach(fn) {\n    this.handlers.forEach((interceptor) =\u003e {\n      if (interceptor) {\n        fn(interceptor);\n      }\n    });\n  }\n}\n\nfunction Axios(instanceConfig) {\n  this.defaults = instanceConfig;\n  this.interceptors = {\n    request: new InterceptorManager(),\n    response: new InterceptorManager(),\n  };\n}\n\nAxios.prototype.request = function request(configOrUrl, config) {\n  /**\n   * \\u7701\\u7565\n   */\n  // \\u62FC\\u63A5\\u6210 [\\u8BF7\\u6C42\\u62E6\\u622A\\u5668, \\u8BF7\\u6C42, \\u54CD\\u5E94\\u62E6\\u622A\\u5668] \\u8BF7\\u6C42\\u94FE\n  // undefined \\u7684\\u4F5C\\u7528\\u662F\\u201C\\u5360\\u4F4D\\u201D\\uFF0C\\u4FDD\\u8BC1\\u4E24\\u4E24\\u4E00\\u7EC4\n  const chain = [dispatchRequest, undefined];\n  // \\u8BF7\\u6C42\\u62E6\\u622A\\u5668\\u201C\\u94FE\\u201D\\uFF0C\\u52A0\\u5230\\u5934\\u90E8\n  this.interceptors.request.forEach(({ fulfilled, rejected }) =\u003e {\n    chain.unshift(fulfilled, rejected);\n  });\n  // \\u54CD\\u5E94\\u62E6\\u622A\\u5668\\u201C\\u94FE\\u201D\\uFF0C\\u52A0\\u5230\\u5C3E\\u90E8\n  this.interceptors.response.forEach(({ fulfilled, rejected }) =\u003e {\n    chain.push(fulfilled, rejected);\n  });\n\n  // \\u542F\\u52A8\\u94FE\\u6761\n  let promise = Promise.resolve(config);\n\n  while (chain.length) {\n    // \\u904D\\u5386\\u8BF7\\u6C42\\u94FE\\uFF0C\\u4E24\\u4E24\\u4E00\\u7EC4\\u94FE\\u5F0F\\u8C03\\u7528\n    promise = promise.then(chain.shift(), chain.shift());\n  }\n\n  return promise;\n};\n`})}),`\n`,(0,n.jsx)(e.p,{children:\"\\u5230\\u6B64\\u4E3A\\u6B62\\uFF0C\\u6211\\u4EEC\\u5C31\\u5B8C\\u6210\\u4E86\\u7B80\\u5355\\u62E6\\u622A\\u5668\\u7684\\u529F\\u80FD\\uFF0C\\u4F7F\\u7528\\u65B9\\u5F0F\\u4E5F\\u5F88\\u7B80\\u5355\\uFF0C\\u6211\\u4EEC\\u53EA\\u9700\\u8BBE\\u7F6E\\u4E00\\u4E0B\\u62E6\\u622A\\u5668\\uFF0C\\u7136\\u540E\\u6B63\\u5E38\\u53D1\\u8D77\\u8BF7\\u6C42\\u5373\\u53EF\\uFF1A\"}),`\n`,(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:\"language-js\",children:`// \\u6DFB\\u52A0\\u8BF7\\u6C42\\u62E6\\u622A\\u5668\naxios.interceptors.request.use(\n  function (config) {\n    // \\u8BF7\\u6C42\\u524D\\u5904\\u7406\\u7684\\u903B\\u8F91\\u653E\\u5728\\u8FD9\\u91CC\n    return config;\n  },\n  function (error) {\n    // \\u5F02\\u5E38\\u5904\\u7406\\u7684\\u903B\\u8F91\\u653E\\u5728\\u8FD9\\u91CC\n    return Promise.reject(error);\n  }\n);\n\n// \\u6DFB\\u52A0\\u54CD\\u5E94\\u62E6\\u622A\\u5668\naxios.interceptors.response.use(\n  function (response) {\n    // \\u5BF9\\u54CD\\u5E94\\u7ED3\\u679C\\u7684\\u5904\\u7406\\u903B\\u8F91\\u653E\\u5728\\u8FD9\\u91CC\n    return response;\n  },\n  function (error) {\n    // \\u5F02\\u5E38\\u5904\\u7406\\u7684\\u903B\\u8F91\\u653E\\u5728\\u8FD9\\u91CC\n    return Promise.reject(error);\n  }\n);\n`})}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u5B8C\\u6574\\u4EE3\\u7801\\u53EF\\u4EE5\\u5728\",(0,n.jsx)(e.a,{href:\"https://github.com/kelvinleung/re-create.js/tree/main/axios\",children:\"\\u8FD9\\u91CC\\u67E5\\u770B\"}),\"\\u3002\\u63A5\\u4E0B\\u6765\\u6211\\u4EEC\\u8FD8\\u8981\\u624B\\u6495\",(0,n.jsx)(e.strong,{children:\"\\u53D6\\u6D88\\u8BF7\\u6C42\"}),\"\\uFF0C\\u8BE6\\u89C1\\u7B2C\\u4E09\\u90E8\\u5206\\u3002\"]})]})}}var A=j;return q(R);})();\n;return Component;"},"__N_SSG":true},"page":"/post/[id]","query":{"id":"recreate-axios-from-scratch-ii"},"buildId":"i85zbTreoVlPV-vsvfmmV","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>