<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="description" content="Kelvin&#x27;s blog"/><link rel="icon" href="/images/favicon.ico"/><title>Axios 源码阅读笔记之——徒手撕 Ajax（二）</title><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/01795ce1e6a4f3e2.css" as="style"/><link rel="stylesheet" href="/_next/static/css/01795ce1e6a4f3e2.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-81f4fb35f4507347.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ad5706bd9f003478.js" defer=""></script><script src="/_next/static/chunks/39-6d8ec19aeb9b9a7c.js" defer=""></script><script src="/_next/static/chunks/pages/post/recreate-axios-from-scratch-ii-4f9a2f43f015a786.js" defer=""></script><script src="/_next/static/73PCgBxl8lNUjAV3YIjvL/_buildManifest.js" defer=""></script><script src="/_next/static/73PCgBxl8lNUjAV3YIjvL/_ssgManifest.js" defer=""></script><script src="/_next/static/73PCgBxl8lNUjAV3YIjvL/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="container"><nav class="navbar"><div class="navbar-content"><ul><li><a href="/">首页</a></li><li><a class="active" href="/posts">秘笈</a></li><li><a href="/">八股</a></li><li><a href="/">奇术</a></li><li><a href="/">轮子</a></li><li><a href="/">鄙人</a></li></ul></div></nav><main class="main"><main><article class="post-container"><div class="post-title-container"><h1 class="post-title">Axios 源码阅读笔记之——徒手撕 Ajax（二）</h1><p class="post-date">JAN 14, 2022</p></div><p><a href="/post/recreate-axios-from-scratch-i">上一次</a>我们已经封装了一个“简陋版”的 Axios，实现了配置化，多种方式调用，Promise 化等功能。除此以外，Axios 还有两个很重要的功能：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>拦截器</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>取消请求</div></li></ul><p>这一次我们先来实现一个拦截器的功能。</p><h2>单个请求拦截器</h2><p>我们知道，Ajax 请求可以粗略地分为三个阶段：</p><ol><li><span class="marker">1.</span><div>请求前，处理配置等</div></li><li><span class="marker">2.</span><div>请求中，等待服务器响应</div></li><li><span class="marker">3.</span><div>响应，得到结果或异常</div></li></ol><p>拦截器其实就是作用在请求前、后（响应）这两个阶段的“钩子”，允许我们对请求的配置、请求的响应、异常等进行处理。先拿请求的拦截器来举例，比方说我们现在有个需求，希望在请求前，能够先对请求的数据进行某种特定的编码，那么这段逻辑我们可以添加在<code>request()</code>函数中。但是这样一来，逻辑就被写死，每次修改都需要改动<code>request()</code>函数的代码，不符合“开放封闭”的原则。</p><p>因此，我们得把拦截器抽取出来，放在另一个地方，暴露一个方法用于设置拦截器，然后在请求前调用进行处理，再将处理后的结果用于请求。根据这个思路，可以像下面这样实现：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Axios</span><span class="token punctuation">(</span><span class="token parameter">instanceConfig</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 默认的配置</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> instanceConfig</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 拦截器，在请求前调用</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptor</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setRequestInterceptor</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptor</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> interceptor</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">request</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">configOrUrl</span><span class="token parameter punctuation">,</span><span class="token parameter"> config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">/**</span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token comment">   * 省略</span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token comment">   */</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 先调用拦截器进行处理</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> newConfig </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">requestInterceptor</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">dispatchRequest</span><span class="token punctuation">(</span><span class="token plain">newConfig</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 假设函数 encode() 返回特殊编码后的数据</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 设置拦截器</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method function property-access">setRequestInterceptor</span><span class="token punctuation">(</span><span class="token plain">encode</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><h2>多个请求拦截器</h2><p>看上去还不错，那么假如我们的需求不只是编码，还希望在编码后对数据进行压缩呢？简单，把<code>interceptor</code>属性换成数组，然后在请求前遍历一下，像这样：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Axios</span><span class="token punctuation">(</span><span class="token parameter">instanceConfig</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> instanceConfig</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 拦截器，改成数组</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setRequestInterceptor</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 按顺序压进数组中</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">interceptor</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">request</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">configOrUrl</span><span class="token parameter punctuation">,</span><span class="token parameter"> config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">/**</span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token comment">   * 省略</span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token comment">   */</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 遍历所有拦截器</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> interceptor </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">    config </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">interceptor</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">dispatchRequest</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 假设函数 encode() 返回特殊编码后的数据</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">26</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">27</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 设置拦截器</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">28</span><div class="token-line-content"><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method function property-access">setRequestInterceptor</span><span class="token punctuation">(</span><span class="token plain">encode</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><h2>响应拦截器</h2><p>对于响应拦截器，也是同样的道理，增加一个<code>responseInterceptors</code>属性用于保存响应拦截器，再增加一个<code>setRe sponseInterceptor()</code>方法来设置响应拦截器。</p><p>与请求拦截器所不同的是，响应拦截器的调用的时机应该放在请求之后，也就是<code>dispatchRequest()</code>方法之后执行。<code>dispatchRequest()</code>方法返回的是一个 Promise，因此响应拦截器要在<code>dispatchRequest().then()</code>中去遍历执行。简化的代码框架如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Axios</span><span class="token punctuation">(</span><span class="token parameter">instanceConfig</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> instanceConfig</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">responseInterceptors</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setRequestInterceptor</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">interceptor</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setResponseInterceptor</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">responseInterceptors</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">interceptor</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">request</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">configOrUrl</span><span class="token parameter punctuation">,</span><span class="token parameter"> config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">/**</span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token comment">   * 省略</span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token comment">   */</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> interceptor </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">requestInterceptors</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">    config </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">interceptor</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> res</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">dispatchRequest</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">responseInterceptors</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">26</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> interceptor </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">responseInterceptors</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">27</span><div class="token-line-content"><span class="token plain">      res </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">interceptor</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">28</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">29</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">30</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> res</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">31</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">32</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">33</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 假设函数 encode() 返回特殊编码后的数据</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">34</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">35</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 假设函数 decode() 返回特殊解码后的数据</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">36</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">37</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">38</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 设置拦截器</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">39</span><div class="token-line-content"><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method function property-access">setRequestInterceptor</span><span class="token punctuation">(</span><span class="token plain">encode</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">40</span><div class="token-line-content"><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method function property-access">setResponseInterceptor</span><span class="token punctuation">(</span><span class="token plain">decode</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><h2>Promise 链</h2><p>嗯，上面的代码看上去貌似就不太优雅……请求拦截器和响应拦截器被分成了两块，但它们又有着相似的逻辑。同样是把某个东西加工后返回，然后交给下一个按顺序遍历执行，这种“链式调用”的场景，你会想到什么？没错，就是<code>Promise</code>。</p><p>通过 Promise，我们可以将这些处理的逻辑串连起来。并且使用 Promise 还有个好处就是异常的处理，我们可以把拦截器拆成一对，分别处理成功和失败的情况：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">encode</span><span class="token punctuation">,</span><span class="token plain"> onError1</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">zip</span><span class="token punctuation">,</span><span class="token plain"> onError2</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">request</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">unzip</span><span class="token punctuation">,</span><span class="token plain"> onError3</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">decode</span><span class="token punctuation">,</span><span class="token plain"> onError4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>通过下面的图，我们可以更清晰地看到整个请求的链路：</p><p><img src="/images/recreate-axios-from-scratch/chain.png" alt="chain"/></p><p>利用 Promise，我们能够将让拦截器处理异步的操作，同时还能够处理每个节点的异常。更妙的是，我们将请求拦截器、请求方法、响应拦截器一块放到一个数组中，通过遍历，每次取出一对方法，便能很优雅地利用 Promise 的<code>then()</code>方法来串连起它们。对于请求方法的那一对，我们用<code>undefined</code>来占位，则请求的异常将穿透给其下一对，即响应拦截器来处理。</p><p><img src="/images/recreate-axios-from-scratch/chain-array.png" alt="chain-array"/></p><h2>小结</h2><p>综上所述，我们将拦截器相关的方法抽取成一个类<code>InterceptorManager</code>，按新的思路调整后的简化代码如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">InterceptorManager</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handlers</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">fulfilled</span><span class="token parameter punctuation">,</span><span class="token parameter"> rejected</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handlers</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> fulfilled</span><span class="token punctuation">,</span><span class="token plain"> rejected </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 下标作为 id，用于 eject</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handlers</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">eject</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handlers</span><span class="token punctuation">[</span><span class="token plain">id</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handlers</span><span class="token punctuation">[</span><span class="token plain">id</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// null 时不处理</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handlers</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">interceptor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">        </span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token plain">interceptor</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">26</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">27</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">28</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Axios</span><span class="token punctuation">(</span><span class="token parameter">instanceConfig</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">29</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> instanceConfig</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">30</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">interceptors</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">31</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">request</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">InterceptorManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">32</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">response</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">InterceptorManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">33</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">34</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">35</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">36</span><div class="token-line-content"><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">request</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">configOrUrl</span><span class="token parameter punctuation">,</span><span class="token parameter"> config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">37</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">/**</span></div></div><div class="token-line"><span class="line-number">38</span><div class="token-line-content"><span class="token comment">   * 省略</span></div></div><div class="token-line"><span class="line-number">39</span><div class="token-line-content"><span class="token comment">   */</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">40</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 拼接成 [请求拦截器, 请求, 响应拦截器] 请求链</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">41</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// undefined 的作用是“占位”，保证两两一组</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">42</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> chain </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">dispatchRequest</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">43</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 请求拦截器“链”，加到头部</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">44</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">interceptors</span><span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> fulfilled</span><span class="token parameter punctuation">,</span><span class="token parameter"> rejected </span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">45</span><div class="token-line-content"><span class="token plain">    chain</span><span class="token punctuation">.</span><span class="token method function property-access">unshift</span><span class="token punctuation">(</span><span class="token plain">fulfilled</span><span class="token punctuation">,</span><span class="token plain"> rejected</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">46</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">47</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 响应拦截器“链”，加到尾部</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">48</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">interceptors</span><span class="token punctuation">.</span><span class="token property-access">response</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> fulfilled</span><span class="token parameter punctuation">,</span><span class="token parameter"> rejected </span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">49</span><div class="token-line-content"><span class="token plain">    chain</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">fulfilled</span><span class="token punctuation">,</span><span class="token plain"> rejected</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">50</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">51</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">52</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 启动链条</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">53</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> promise </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">54</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">55</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">chain</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">56</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 遍历请求链，两两一组链式调用</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">57</span><div class="token-line-content"><span class="token plain">    promise </span><span class="token operator">=</span><span class="token plain"> promise</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain">chain</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> chain</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">58</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">59</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">60</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> promise</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">61</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></code></pre><p>到此为止，我们就完成了简单拦截器的功能，使用方式也很简单，我们只需设置一下拦截器，然后正常发起请求即可：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// 添加请求拦截器</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token property-access">interceptors</span><span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 请求前处理的逻辑放在这里</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> config</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 异常处理的逻辑放在这里</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">reject</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 添加响应拦截器</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token property-access">interceptors</span><span class="token punctuation">.</span><span class="token property-access">response</span><span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 对响应结果的处理逻辑放在这里</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> response</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 异常处理的逻辑放在这里</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">reject</span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>完整代码可以在<a href="https://github.com/kelvinleung/re-create.js/tree/main/axios">这里查看</a>。接下来我们还要手撕<strong>取消请求</strong>，详见第三部分。</p></article></main></main><footer><div>Build with ♥ @GZ</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/post/recreate-axios-from-scratch-ii","query":{},"buildId":"73PCgBxl8lNUjAV3YIjvL","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>