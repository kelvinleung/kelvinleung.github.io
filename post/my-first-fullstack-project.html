<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="description" content="Kelvin&#x27;s blog"/><link rel="icon" href="/images/favicon.ico"/><title>第一个全栈项目上线小结</title><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/beb59a9e1165a44b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/beb59a9e1165a44b.css" data-n-g=""/><link rel="preload" href="/_next/static/css/5efe62c786a6b4f4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5efe62c786a6b4f4.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-81f4fb35f4507347.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7000df9582a09740.js" defer=""></script><script src="/_next/static/chunks/323-451496564d94cd92.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bid%5D-b4b49da35f214cd7.js" defer=""></script><script src="/_next/static/i85zbTreoVlPV-vsvfmmV/_buildManifest.js" defer=""></script><script src="/_next/static/i85zbTreoVlPV-vsvfmmV/_ssgManifest.js" defer=""></script><script src="/_next/static/i85zbTreoVlPV-vsvfmmV/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="container"><nav class="navbar"><div class="navbar-content"><div class="navbar-menu-container"><ul class="navbar-menu"><li><a href="/">首页</a></li><li><a href="/posts/horse-sense">秘籍</a></li><li><a href="/posts/gibberish">八股</a></li><li><a href="/posts/xray">庖丁</a></li><li><a href="/posts/copycat">画瓢</a></li></ul></div></div></nav><main class="main"><main><article class="post-container"><div class="post-title-container"><h1 class="post-title">第一个全栈项目上线小结</h1><p class="post-date">DEC 22, 2021</p></div><p><img src="/images/my-first-fullstack-project/light-salt-index.png" alt="星之光盐"/></p>
<p>前前后后忙了差不多有一个月的时候，终于把我第一个独立完成的全栈项目（正式）上线了，可以戳这里看看哦：<a href="http://www.autismlightsalt.com">星之光盐</a>。过程中遇到了无数的坑，在此回顾小结一下。</p>
<p>项目背景是这样的，我老婆他们中心翻译了国外的一些资料，20 多个自闭症的干预方法，想要放到一个网站上去。刚好我也想找些项目练练手，就接了过来自己做。整个项目不复杂，就是几个静态的展示页，方便查阅这 20 多个方法，外加中心的介绍等。稍微麻烦一点的是方法页，需求是要关注服务号后才可以查看，不难，后面会有讲。</p>
<p>整个项目最初只有我一个“全干工程师”，没有原型，没有 UI，前后端一条龙，还得自己设计样式。后面找人介绍了个设计师，应该是我见过最水的一个 UI 了，出的设计稿各种不对齐，字号也不统一，切图也不会。最后我和甲方（我老婆）商量，只照着他给的样式做了个大概，很多细节我都自己调整了一遍，还得自己改图标切图，最后还被他吐槽“还原度不高”。如果真按设计稿来还原，那简直就是个灾难……</p>
<p>下面分为前后端两个部分来小结吧，毕竟是一个完整的全栈项目，先说后端部分：</p>
<h2>后端部分</h2>
<p>这次后端用的是<code>express</code>和<code>MySQL</code>，原始需求是：</p>
<ul>
<li>方法内容需要登录后才能查看</li>
<li>未关注服务号的用户扫码后关注服务号并登录</li>
<li>已关注服务号的用户扫码后登录</li>
<li>静默地为用户生成一个账号，无需设置密码</li>
<li>登录状态保持一周</li>
</ul>
<p>上述功能实现起来逻辑并不复杂，主要是和微信那边的交互第一次做，调试花了不少功夫。好在文档写得还行，基本上照着干问题不大。</p>
<p>扫码登录功能用到微信公众平台一个叫“带参数的二维码”的 API，文档对其描述为：</p>
<blockquote>
<p>为了满足用户渠道推广分析和用户帐号绑定等场景的需要，公众平台提供了生成带参数二维码的接口。使用该接口可以获得多个带不同场景值的二维码，用户扫描后，公众号可以接收到事件推送。</p>
</blockquote>
<p>根据微信公众平台的文档，用户扫描带场景值二维码时，可能推送以下两种事件：</p>
<ul>
<li>如果用户还未关注公众号，则用户可以关注公众号，关注后微信会将带场景值关注事件推送给开发者。</li>
<li>如果用户已经关注公众号，在用户扫描后会自动进入会话，微信也会将带场景值扫描事件推送给开发者。</li>
</ul>
<p>也就是说，我们可以调用微信公众平台这一接口来生成带参数（场景值）的二维码，这个参数是我们传过去的，用于唯一确定扫码的用户。用户扫码后，微信会把该事件推送到我们的服务号，并且是区分关注和未关注的（事件不同）。因此我们可以利用这个参数与事件的不同，来区分用户与用户的行为。</p>
<p><img src="/images/my-first-fullstack-project/sequence.png" alt="时序图"/></p>
<p>如图所示，整个流程是这样的：</p>
<ul>
<li>首先，用户点击登录按钮，这时前端会去请求服务器的<code>/api/get_qrcode</code>接口</li>
<li>服务端接到请求，生成唯一的 UUID，存在内存中</li>
<li>服务端用 UUID 去请求微信的<code>https://api.weixin.qq.com/cgi-bin/qrcode/create</code>接口，生成带参数的二维码</li>
<li>服务端拿到微信返回的二维码链接，连同对应的 UUID 一并返回给前端</li>
<li>前端拿到二维码链接，展示二维码给用户，同时开始轮询服务端的登录接口<code>/api/login</code></li>
<li>用户扫描二维码，微信服务器接收到用户的扫码事件</li>
<li>微信将用户的扫码事件、OpenID 与场景值（UUID）发送给服务端处理</li>
<li>服务端接收到微信的事件，查询数据库中是否已经有 OpenID 对应的账号，没有则创建</li>
<li>查询/创建完账号后，服务端查询内存中是否有对应的 UUID，没有则返回错误码给前端</li>
<li>如果服务端查询到内存中有对应的 UUID，则把账号信息返回给还在轮询的前端</li>
<li>前端获取到用户信息后，处理登录状态</li>
</ul>
<h3>登录相关的接口</h3>
<p><code>/api/login</code>接口的逻辑非常简单，代码如下：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">const</span><span class="token plain"> express </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> router </span><span class="token operator">=</span><span class="token plain"> express</span><span class="token punctuation">.</span><span class="token method function property-access maybe-class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> authManager </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils/authManager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">router</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> uid </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> req</span><span class="token punctuation">.</span><span class="token property-access">query</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> auth </span><span class="token operator">=</span><span class="token plain"> authManager</span><span class="token punctuation">.</span><span class="token method function property-access">getAuth</span><span class="token punctuation">(</span><span class="token plain">uid</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">auth</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">    res</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">code</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">user</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token plain">auth </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">    </span><span class="token comment">// 返回错误码给前端继续轮询</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p>其中的<code>authManager</code>是一个单例，用来管理登录相关的逻辑，主要方法如下：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">MAX_LOAD</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// “扫码”队列，限制最大等待人数</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">AuthManager</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">    </span><span class="token comment">// 用 Map 来模拟队列</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">  </span><span class="token comment">// 获取单例</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">  </span><span class="token keyword">static</span><span class="token plain"> </span><span class="token function">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">instance</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">instance</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">AuthManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">instance</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">  </span><span class="token comment">// 以 uid 为 key，保存用户信息在队列中，略</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">  </span><span class="token function">setAuth</span><span class="token punctuation">(</span><span class="token parameter">uid</span><span class="token parameter punctuation">,</span><span class="token parameter"> user</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">  </span><span class="token comment">// 以 uid 为 key 获取用户信息，略</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">  </span><span class="token function">getAuth</span><span class="token punctuation">(</span><span class="token parameter">uid</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">  </span><span class="token comment">// 判断队列是否已满，满则尝试清除过期的请求</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">  </span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">size</span><span class="token plain"> </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token constant">MAX_LOAD</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain">      </span><span class="token punctuation">[</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter punctuation">[</span><span class="token parameter">key</span><span class="token parameter punctuation">,</span><span class="token parameter"> value</span><span class="token parameter punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> value</span><span class="token punctuation">.</span><span class="token property-access">createTime</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">60</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token method function property-access">delete</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">26</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">27</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">28</span><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">size</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token constant">MAX_LOAD</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">29</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">30</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span></div></pre></div>
<p>考虑到扫码与登录轮询间存在时间差，而登录信息即使丢失，也不会产生严重问题（最多造成前端轮询超时，可以重来），就把它直接存在内存中。这里用一个<code>Map</code>来模拟队列，且设置了最大容量，防止太多人同时扫码挤爆内存。<code>isAvailable()</code>方法用于判断队列是否已满，满则遍历清除过期的请求。<code>uid</code>则作为唯一的标识链接着用户、微信与业务逻辑三者。</p>
<p><code>/api/get_qrcode</code>接口的核心逻辑如下：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token comment">// 省略部分导入</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">v4</span><span class="token operator">:</span><span class="token plain"> uuidv4 </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;uuid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">TICKET_URL</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;https://api.weixin.qq.com/cgi-bin/qrcode/create&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name">QR_URL</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">ticket</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">ticket</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> tokenManager </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils/tokenManager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> authManager </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils/authManager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">QR_EXPIRE_TIME</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">604800</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">router</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">&quot;/get_qrcode&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">authManager</span><span class="token punctuation">.</span><span class="token method function property-access">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token comment">// 省略队列满时的错误处理</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> token </span><span class="token operator">=</span><span class="token plain"> tokenManager</span><span class="token punctuation">.</span><span class="token method function property-access">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> uid </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">uuidv4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">  </span><span class="token keyword control-flow">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">token</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">      </span><span class="token comment">// 省略 token 为空时的错误处理</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> response </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow">await</span><span class="token plain"> axios</span><span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">      </span><span class="token constant">TICKET_URL</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain">        </span><span class="token literal-property property">expire_seconds</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">QR_EXPIRE_TIME</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain">        </span><span class="token literal-property property">action_name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;QR_STR_SCENE&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain">        </span><span class="token literal-property property">action_info</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain">          </span><span class="token literal-property property">scene</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">26</span><span class="token plain">            </span><span class="token literal-property property">scene_str</span><span class="token operator">:</span><span class="token plain"> uid</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">27</span><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">28</span><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">29</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">30</span><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">params</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">access_token</span><span class="token operator">:</span><span class="token plain"> token </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">31</span><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">32</span><span class="token plain">    </span><span class="token comment">// 省略处理返回错误码的部分</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">33</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> ticket</span><span class="token punctuation">,</span><span class="token plain"> expire_seconds </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> response</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">34</span><span class="token plain">    res</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">35</span><span class="token plain">      </span><span class="token literal-property property">code</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">36</span><span class="token plain">      uid</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">37</span><span class="token plain">      </span><span class="token literal-property property">imgUrl</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">QR_URL</span><span class="token punctuation">(</span><span class="token plain">ticket</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">38</span><span class="token plain">      </span><span class="token literal-property property">createTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">39</span><span class="token plain">      </span><span class="token literal-property property">expireTime</span><span class="token operator">:</span><span class="token plain"> expire_seconds</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">40</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">41</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">42</span><span class="token plain">    </span><span class="token comment">// 省略错误处理的部分</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">43</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">44</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p><code>/api/get_qrcode</code>接口的核心逻辑就是生成 UUID，然后调用微信生成带参数二维码的接口，然后返回获取到的二维码链接，比较简单，详情可以查看<a href="https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Generating_a_Parametric_QR_Code.html">微信的文档</a>了解更多。其中的<code>tokenManager</code>是用来获取微信的<code>access_token</code>，调用公众号的接口时都要带上。<code>tokenManager</code>会定时刷新 token，用文件的形式保存在本地，具体逻辑比较简单在此略过，详情可以查看<a href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html">微信的文档</a>了解更多。</p>
<h3>处理微信消息的相关接口</h3>
<p>这次后端部分最核心的应该就是处理微信消息的接口了。接入微信公众平台后，原本在公众号后台配置的菜单和关键词等都失效了，要手工去操作实现。所有微信用户发的消息、扫码、关注、点击菜单等行为都会被转到该接口来处理。需要注意的是，这些消息需要在 5 秒内回复，微信会重试 3 次，如果不能马上处理完，可以直接回复空串。微信能接受的回复只有<code>&quot;success&quot;</code>与<code>&quot;&quot;</code>（字节长度为 0 的空字符串），当时我回复了<code>&quot;ok&quot;</code>，结果一直提示“该公众号暂时无法提供服务，请稍后再试”，debug 了好久才发现问题。</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">const</span><span class="token plain"> express </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> router </span><span class="token operator">=</span><span class="token plain"> express</span><span class="token punctuation">.</span><span class="token method function property-access maybe-class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">XMLJS</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;xml2js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> parser </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">XMLJS</span><span class="token class-name punctuation">.</span><span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">WechatHandler</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils/wechatHandler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">router</span><span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">  req</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">    parser</span><span class="token punctuation">.</span><span class="token method function property-access">parseString</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token parameter punctuation">,</span><span class="token parameter"> result</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">        </span><span class="token comment">// 省略错误的处理</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> body </span><span class="token operator">=</span><span class="token plain"> result</span><span class="token punctuation">.</span><span class="token property-access">xml</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> handler </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">WechatHandler</span><span class="token punctuation">(</span><span class="token plain">body</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">      handler</span><span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> res</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token plain">message</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p>由于微信发过来的消息是 XML 格式的，这里用了<code>xml2js</code>这个包来处理，XML 的各字段定义可以看微信的文档：<a href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_standard_messages.html">普通消息</a>，<a href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_event_pushes.html">事件推送</a>。解开 XML 后，将事件交给<code>WechatHandler</code>来统一处理，核心代码如下：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">DEFAULT_REPLY_MSG</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 默认的回复内容，空串</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain"></span><span class="token comment">// 需要处理的事件</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">IMPLEMENTED_EVENTS</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&quot;subscribe&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;unsubscribe&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;SCAN&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;CLICK&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain"></span><span class="token comment">// 策略对象，省略具体实现</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Handle</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">  </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> key</span><span class="token parameter punctuation">,</span><span class="token parameter"> openId</span><span class="token parameter punctuation">,</span><span class="token parameter"> devId </span><span class="token parameter punctuation">}</span><span class="token parameter punctuation">,</span><span class="token parameter"> reply</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">  </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> openId </span><span class="token parameter punctuation">}</span><span class="token parameter punctuation">,</span><span class="token parameter"> reply</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">  </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token constant">SCAN</span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> </span><span class="token parameter literal-property property">key</span><span class="token parameter operator">:</span><span class="token parameter"> uid</span><span class="token parameter punctuation">,</span><span class="token parameter"> openId </span><span class="token parameter punctuation">}</span><span class="token parameter punctuation">,</span><span class="token parameter"> reply</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">  </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token constant">CLICK</span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> key</span><span class="token parameter punctuation">,</span><span class="token parameter"> openId</span><span class="token parameter punctuation">,</span><span class="token parameter"> devId </span><span class="token parameter punctuation">}</span><span class="token parameter punctuation">,</span><span class="token parameter"> reply</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">WechatHandler</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">ToUserName</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">FromUserName</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">MsgType</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">Event</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">EventKey</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> body</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">MsgType</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">openId</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">FromUserName</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">devId</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ToUserName</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">event</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Event</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token maybe-class-name">Event</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">EventKey</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token maybe-class-name">EventKey</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">  </span><span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">reply</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> config </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain">      </span><span class="token literal-property property">openId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">openId</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain">      </span><span class="token literal-property property">devId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">devId</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain">      </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">26</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">27</span><span class="token plain">    </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">28</span><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&quot;event&quot;</span><span class="token operator">:</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">29</span><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token constant">IMPLEMENTED_EVENTS</span><span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">event</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">30</span><span class="token plain">          </span><span class="token maybe-class-name">Handle</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">event</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">,</span><span class="token plain"> reply</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">31</span><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">32</span><span class="token plain">          </span><span class="token function">reply</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_REPLY_MSG</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">33</span><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">34</span><span class="token plain">        </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">35</span><span class="token plain">      </span><span class="token keyword module">default</span><span class="token operator">:</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">36</span><span class="token plain">        </span><span class="token function">reply</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_REPLY_MSG</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">37</span><span class="token plain">        </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">38</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">39</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">40</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span></div></pre></div>
<p><code>WechatHandler</code>的主要作用是从 XML 对象中解出各个字段，再根据事件的类型作不同的处理。这里还用到了策略模式，来处理不同的<code>&quot;event&quot;</code>类型事件。不同的事件定义可以查看<a href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_event_pushes.html">微信文档</a>，需要注意的是“扫码”这一操作，根据用户是否已关注公号，区分为<code>&quot;SCAN&quot;</code>与<code>&quot;subscribe&quot;</code>两个事件，逻辑的处理稍有不同。</p>
<p>以上就是后端部分的小结，下面来说说前端。</p>
<h2>前端部分</h2>
<p>前端这次还是用 React 来写，由于有 20 几篇静态的内容页，样式基本一致，所以决定继续用<code>next.js</code>加 MDX 来做。内容由 Word 文档转为 MDX，然后样式部分用<code>SASS</code>来写，但由于时间比较赶，所以写得很乱，开发过程中遇到过很多次 specificity 冲突导致样式覆盖或不生效的问题。这部分打算后面有时间了重构一下，不然以后要改很难维护。</p>
<h3>无限翻页</h3>
<p>这次首页有一个翻页组件的需求，用来展示所有方法的列表，支持无限翻页。由于是边学习边做的项目，所以这块没有直接用现成的轮子，而是自己实现了一个简单的翻页组件。</p>
<p>方法一共有 27 个，按 3 x 3 每页，一共需要 3 页。无限翻页的原理其实很简单，在前后各加上一个“伪页”。最左边是“伪 P3”，最右边是“伪 P1”。这样当从 P1 往左滑动的时候，就可以续上形成一个闭合的“环”了。而为了从这个“伪页”继续滑动，需要在滑动到两头的“伪页”时，切换回“伪页”所对应的“真页”上。这个切换的动作发生在滑动动画结束时，并且切换过程是一个没有动画的“瞬间移动”动作。页面的结构与切换如下图所示：</p>
<p><img src="/images/my-first-fullstack-project/carousel.png" alt="翻页结构"/></p>
<p>从“伪 P3”切换到“真 P3”的“瞬间移动”：</p>
<p><img src="/images/my-first-fullstack-project/carousel-switch.png" alt="翻页切换"/></p>
<p>我做了个动画来展示这一过程，当滑动到最左边一页的“伪 P3”时，“瞬间移动”到“真 P3”处，从而形成连续的“环”：</p>
<p><img src="/images/my-first-fullstack-project/carousel.gif" alt="翻页动画"/></p>
<p>下面是翻页组件<code>MethodList</code>的核心代码：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name">MethodList</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> methods </span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">,</span><span class="token plain"> setIndex</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 当前页</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">  </span><span class="token comment">/* ---- 省略部分 ---- */</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">reposition</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">    </span><span class="token comment">// 处理“瞬间移动”的逻辑</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> itemCount </span><span class="token operator">=</span><span class="token plain"> isNarrowScreen </span><span class="token operator">?</span><span class="token plain"> </span><span class="token number">6</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">9</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 每页元素的数量</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> pageCount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">ceil</span><span class="token punctuation">(</span><span class="token plain">methods</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> itemCount</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 总页数（包括“伪页”）</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">    </span><span class="token comment">// 左“伪页”</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> count </span><span class="token operator">=</span><span class="token plain"> methods</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">%</span><span class="token plain"> itemCount</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> methods</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token plain">count </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">itemCount </span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">count</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">    </span><span class="token comment">// 右“伪页”</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">===</span><span class="token plain"> pageCount </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword control-flow">return</span><span class="token plain"> methods</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> itemCount</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">    </span><span class="token comment">// “真页”</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> methods</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">      </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> itemCount</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">      </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> itemCount </span><span class="token operator">+</span><span class="token plain"> itemCount</span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain">  </span><span class="token comment">// 简化了 JSX 的结构</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token plain">div</span></span><span class="token-line"><span class="code-block-line-number">26</span><span class="token plain">      className</span><span class="token operator">=</span><span class="token string">&quot;content&quot;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">27</span><span class="token plain">      style</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">28</span><span class="token plain">        </span><span class="token literal-property property">left</span><span class="token operator">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">-</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">index </span><span class="token template-string interpolation operator">*</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation number">100</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">%</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">29</span><span class="token plain">        </span><span class="token literal-property property">width</span><span class="token operator">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">pageCount </span><span class="token template-string interpolation operator">*</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation number">100</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">%</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">30</span><span class="token plain">        </span><span class="token literal-property property">transition</span><span class="token operator">:</span><span class="token plain"> transition </span><span class="token operator">?</span><span class="token plain"> </span><span class="token string">&quot;all 1s&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">31</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">32</span><span class="token plain">      onTransitionEnd</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">reposition</span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">33</span><span class="token plain">    </span><span class="token operator">&gt;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">34</span><span class="token plain">      </span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token spread operator">...</span><span class="token known-class-name class-name">Array</span><span class="token punctuation">(</span><span class="token plain">pageCount</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">35</span><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">div key</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">i</span><span class="token punctuation">}</span><span class="token plain"> className</span><span class="token operator">=</span><span class="token string">&quot;page&quot;</span><span class="token operator">&gt;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">36</span><span class="token plain">          </span><span class="token punctuation">{</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token plain">i</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">37</span><span class="token plain">            </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Card</span><span class="token plain"> key</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">method</span><span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">}</span><span class="token plain"> method</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">method</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">38</span><span class="token plain">          </span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">39</span><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">40</span><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">41</span><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">42</span><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">43</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p><code>getMethods()</code>方法是方便获取每一页放置的方法列表，对于头尾两个“伪页”要做特殊处理。<code>reposition()</code>方法则是在<code>onTransitionEnd</code>事件触发时调用，判断当前如果是“伪页”，则触发“瞬间移动”的操作（更新<code>index</code>的值）。<code>pageCount</code>是每页元素的数量，会根据屏幕的宽窄来确定，实现响应式布局的需求，下面会有讲到<code>isNarrowScreen</code>的计算方法。页面间的切换用的是 CSS 的<code>left</code>属性，根据<code>index</code>来确定值。</p>
<p>这里有个小瑕疵还没完善，当快速点击切换页面，切换到尾端的“伪页”时，继续点击切换会没反应，因为<code>reposition</code>要等待动画完成<code>onTransitionEnd</code>时才会调用。这个小 bug 等有时间了再优化。</p>
<h3>响应式</h3>
<p><img src="/images/my-first-fullstack-project/light-salt-responsive.png" alt="响应式样式"/></p>
<p>项目要求 PC 端和手机端都可以浏览，由于都是比较简单的展示页，所以就直接做成响应式的了。用<code>@media</code>调一下布局的样式，基于<code>rem</code>去做还是比较简单的。麻烦的是首页的翻页列表，由于要求在不同分辨率下每页显示方法的数量不同，一开始是基于<code>grid</code>去做的，后来发现<code>grid</code>的兼容性不太好，测试了一些比较旧的浏览器上显示不太正常，就改回<code>flex</code>来实现了。单纯用 CSS 去布局的话比较麻烦，最后还是用 JS 来搞。</p>
<p>主要用到的是<code>window.matchMedia()</code>这个 API，传入一个 media query 的字符串，返回一个<code>MediaQueryList</code>对象，可以用这个对象来监听页面的变化，详细用法介绍可以看 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/matchMedia">MDN</a>。</p>
<p>这里有一个坑就是，在一些老的浏览器里，包括 Safari 14 及以下，添加监听的方法是<code>addListener</code>而不是<code>addEventListener</code>，要加个判断来处理一下。监听的主要代码如下：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">,</span><span class="token plain"> setIndex</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain"></span><span class="token comment">// Media Query</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">isNarrowScreen</span><span class="token punctuation">,</span><span class="token plain"> setIsNarrorScreen</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain"></span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> mql </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">matchMedia</span><span class="token punctuation">(</span><span class="token string">&quot;(max-width: 640px)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">  </span><span class="token function">setIsNarrorScreen</span><span class="token punctuation">(</span><span class="token plain">mql</span><span class="token punctuation">.</span><span class="token property-access">matches</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateIsNarrowScreen</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">    </span><span class="token function">setIsNarrorScreen</span><span class="token punctuation">(</span><span class="token plain">e</span><span class="token punctuation">.</span><span class="token property-access">matches</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">  </span><span class="token comment">// Safari 14 以前，用的是 addListener / removeListener</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> mql</span><span class="token punctuation">.</span><span class="token property-access">addEventListener</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">    mql</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;change&quot;</span><span class="token punctuation">,</span><span class="token plain"> updateIsNarrowScreen</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">    mql</span><span class="token punctuation">.</span><span class="token method function property-access">addListener</span><span class="token punctuation">(</span><span class="token plain">updateIsNarrowScreen</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> mql</span><span class="token punctuation">.</span><span class="token property-access">removeEventListener</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">      mql</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;change&quot;</span><span class="token punctuation">,</span><span class="token plain"> updateIsNarrowScreen</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">      mql</span><span class="token punctuation">.</span><span class="token method function property-access">removeListener</span><span class="token punctuation">(</span><span class="token plain">updateIsNarrowScreen</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain"></span><span class="token comment">// 屏幕改变时重置第一页</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain"></span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">setIndex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">isNarrowScreen</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p>通过监听<code>MediaQueryList</code>对象来判断屏幕的宽窄，再根据<code>isNarrowScreen</code>的值来改变每页显示方法的数量。以上代码可以封装成一个<code>useMedia</code>的 hooks 来方便复用。</p>
<p>还有一个要注意的坑是，因为<code>next.js</code>是服务端渲染与客户端渲染结合的，如果需要用到<code>window</code>对象，则需要在<code>useEffect()</code>中使用，此时才是处于客户端（浏览器环境）渲染阶段，不然会报错。</p>
<h3>定时器 =&gt; useInterval</h3>
<p>用户登录时展示二维码的界面是一个弹窗组件，组件显示时，前端会去轮询<code>/api/login</code>接口，因此需要一个定时器来实现。在 React 中使用定时器，会有各种奇奇怪怪的坑，涉及到 hooks 的原理、闭包等知识，Dan 的文章写得很详细了，这里不再赘述，有兴趣的可以看下<a href="https://overreacted.io/making-setinterval-declarative-with-react-hooks/">《Making setInterval Declarative with React Hooks》</a>。</p>
<h2>其它</h2>
<h3>Nginx 配置</h3>
<p>项目最终是部署在阿里云的服务器上，后端用<code>pm2</code>来跑，前端则打包成静态文件。一开始<code>nginx</code>的配置是纯手写的，后来发现了这个<a href="https://www.digitalocean.com/community/tools/nginx">配置神器</a>，简直不能更好用。</p>
<h3>CDN</h3>
<p>项目上线后偶有反馈访问不了的情况，按理说应该不是项目本身的 bug 造成的，猜测是网络问题。目前还在观察，如果有需要的话可能会上 CDN 来优化可访问性和提升访问速度。</p>
<h3>CI/CD</h3>
<p>现在项目发布都还是纯手动模式，打包上传然后重启服务。接下来会优化成用 GitHub Action 来做。</p></article></main></main><footer><div>Build with ♥ @GZ</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"meta":{"title":"第一个全栈项目上线小结","date":"DEC 22, 2021","desc":"前前后后忙了差不多有一个月的时候，终于把我第一个独立完成的全栈项目（正式）上线了。过程中遇到了无数的坑，在此回顾小结一下。","type":"horse-sense"},"code":"var Component=(()=\u003e{var l=Object.create;var d=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var u=Object.getPrototypeOf,g=Object.prototype.hasOwnProperty;var m=(i,r)=\u003e()=\u003e(r||i((r={exports:{}}).exports,r),r.exports),f=(i,r)=\u003e{for(var c in r)d(i,c,{get:r[c],enumerable:!0})},s=(i,r,c,n)=\u003e{if(r\u0026\u0026typeof r==\"object\"||typeof r==\"function\")for(let t of p(r))!g.call(i,t)\u0026\u0026t!==c\u0026\u0026d(i,t,{get:()=\u003er[t],enumerable:!(n=h(r,t))||n.enumerable});return i};var M=(i,r,c)=\u003e(c=i!=null?l(u(i)):{},s(r||!i||!i.__esModule?d(c,\"default\",{value:i,enumerable:!0}):c,i)),y=i=\u003es(d({},\"__esModule\",{value:!0}),i);var a=m((q,o)=\u003e{o.exports=_jsx_runtime});var I={};f(I,{default:()=\u003ex,frontmatter:()=\u003e_});var e=M(a()),_={title:\"\\u7B2C\\u4E00\\u4E2A\\u5168\\u6808\\u9879\\u76EE\\u4E0A\\u7EBF\\u5C0F\\u7ED3\",date:\"DEC 22, 2021\",desc:\"\\u524D\\u524D\\u540E\\u540E\\u5FD9\\u4E86\\u5DEE\\u4E0D\\u591A\\u6709\\u4E00\\u4E2A\\u6708\\u7684\\u65F6\\u5019\\uFF0C\\u7EC8\\u4E8E\\u628A\\u6211\\u7B2C\\u4E00\\u4E2A\\u72EC\\u7ACB\\u5B8C\\u6210\\u7684\\u5168\\u6808\\u9879\\u76EE\\uFF08\\u6B63\\u5F0F\\uFF09\\u4E0A\\u7EBF\\u4E86\\u3002\\u8FC7\\u7A0B\\u4E2D\\u9047\\u5230\\u4E86\\u65E0\\u6570\\u7684\\u5751\\uFF0C\\u5728\\u6B64\\u56DE\\u987E\\u5C0F\\u7ED3\\u4E00\\u4E0B\\u3002\",type:\"horse-sense\"};function v(i={}){let{wrapper:r}=i.components||{};return r?(0,e.jsx)(r,Object.assign({},i,{children:(0,e.jsx)(c,{})})):c();function c(){let n=Object.assign({p:\"p\",img:\"img\",a:\"a\",h2:\"h2\",code:\"code\",ul:\"ul\",li:\"li\",blockquote:\"blockquote\",h3:\"h3\",pre:\"pre\"},i.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/images/my-first-fullstack-project/light-salt-index.png\",alt:\"\\u661F\\u4E4B\\u5149\\u76D0\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u524D\\u524D\\u540E\\u540E\\u5FD9\\u4E86\\u5DEE\\u4E0D\\u591A\\u6709\\u4E00\\u4E2A\\u6708\\u7684\\u65F6\\u5019\\uFF0C\\u7EC8\\u4E8E\\u628A\\u6211\\u7B2C\\u4E00\\u4E2A\\u72EC\\u7ACB\\u5B8C\\u6210\\u7684\\u5168\\u6808\\u9879\\u76EE\\uFF08\\u6B63\\u5F0F\\uFF09\\u4E0A\\u7EBF\\u4E86\\uFF0C\\u53EF\\u4EE5\\u6233\\u8FD9\\u91CC\\u770B\\u770B\\u54E6\\uFF1A\",(0,e.jsx)(n.a,{href:\"http://www.autismlightsalt.com\",children:\"\\u661F\\u4E4B\\u5149\\u76D0\"}),\"\\u3002\\u8FC7\\u7A0B\\u4E2D\\u9047\\u5230\\u4E86\\u65E0\\u6570\\u7684\\u5751\\uFF0C\\u5728\\u6B64\\u56DE\\u987E\\u5C0F\\u7ED3\\u4E00\\u4E0B\\u3002\"]}),`\n`,(0,e.jsx)(n.p,{children:\"\\u9879\\u76EE\\u80CC\\u666F\\u662F\\u8FD9\\u6837\\u7684\\uFF0C\\u6211\\u8001\\u5A46\\u4ED6\\u4EEC\\u4E2D\\u5FC3\\u7FFB\\u8BD1\\u4E86\\u56FD\\u5916\\u7684\\u4E00\\u4E9B\\u8D44\\u6599\\uFF0C20 \\u591A\\u4E2A\\u81EA\\u95ED\\u75C7\\u7684\\u5E72\\u9884\\u65B9\\u6CD5\\uFF0C\\u60F3\\u8981\\u653E\\u5230\\u4E00\\u4E2A\\u7F51\\u7AD9\\u4E0A\\u53BB\\u3002\\u521A\\u597D\\u6211\\u4E5F\\u60F3\\u627E\\u4E9B\\u9879\\u76EE\\u7EC3\\u7EC3\\u624B\\uFF0C\\u5C31\\u63A5\\u4E86\\u8FC7\\u6765\\u81EA\\u5DF1\\u505A\\u3002\\u6574\\u4E2A\\u9879\\u76EE\\u4E0D\\u590D\\u6742\\uFF0C\\u5C31\\u662F\\u51E0\\u4E2A\\u9759\\u6001\\u7684\\u5C55\\u793A\\u9875\\uFF0C\\u65B9\\u4FBF\\u67E5\\u9605\\u8FD9 20 \\u591A\\u4E2A\\u65B9\\u6CD5\\uFF0C\\u5916\\u52A0\\u4E2D\\u5FC3\\u7684\\u4ECB\\u7ECD\\u7B49\\u3002\\u7A0D\\u5FAE\\u9EBB\\u70E6\\u4E00\\u70B9\\u7684\\u662F\\u65B9\\u6CD5\\u9875\\uFF0C\\u9700\\u6C42\\u662F\\u8981\\u5173\\u6CE8\\u670D\\u52A1\\u53F7\\u540E\\u624D\\u53EF\\u4EE5\\u67E5\\u770B\\uFF0C\\u4E0D\\u96BE\\uFF0C\\u540E\\u9762\\u4F1A\\u6709\\u8BB2\\u3002\"}),`\n`,(0,e.jsx)(n.p,{children:\"\\u6574\\u4E2A\\u9879\\u76EE\\u6700\\u521D\\u53EA\\u6709\\u6211\\u4E00\\u4E2A\\u201C\\u5168\\u5E72\\u5DE5\\u7A0B\\u5E08\\u201D\\uFF0C\\u6CA1\\u6709\\u539F\\u578B\\uFF0C\\u6CA1\\u6709 UI\\uFF0C\\u524D\\u540E\\u7AEF\\u4E00\\u6761\\u9F99\\uFF0C\\u8FD8\\u5F97\\u81EA\\u5DF1\\u8BBE\\u8BA1\\u6837\\u5F0F\\u3002\\u540E\\u9762\\u627E\\u4EBA\\u4ECB\\u7ECD\\u4E86\\u4E2A\\u8BBE\\u8BA1\\u5E08\\uFF0C\\u5E94\\u8BE5\\u662F\\u6211\\u89C1\\u8FC7\\u6700\\u6C34\\u7684\\u4E00\\u4E2A UI \\u4E86\\uFF0C\\u51FA\\u7684\\u8BBE\\u8BA1\\u7A3F\\u5404\\u79CD\\u4E0D\\u5BF9\\u9F50\\uFF0C\\u5B57\\u53F7\\u4E5F\\u4E0D\\u7EDF\\u4E00\\uFF0C\\u5207\\u56FE\\u4E5F\\u4E0D\\u4F1A\\u3002\\u6700\\u540E\\u6211\\u548C\\u7532\\u65B9\\uFF08\\u6211\\u8001\\u5A46\\uFF09\\u5546\\u91CF\\uFF0C\\u53EA\\u7167\\u7740\\u4ED6\\u7ED9\\u7684\\u6837\\u5F0F\\u505A\\u4E86\\u4E2A\\u5927\\u6982\\uFF0C\\u5F88\\u591A\\u7EC6\\u8282\\u6211\\u90FD\\u81EA\\u5DF1\\u8C03\\u6574\\u4E86\\u4E00\\u904D\\uFF0C\\u8FD8\\u5F97\\u81EA\\u5DF1\\u6539\\u56FE\\u6807\\u5207\\u56FE\\uFF0C\\u6700\\u540E\\u8FD8\\u88AB\\u4ED6\\u5410\\u69FD\\u201C\\u8FD8\\u539F\\u5EA6\\u4E0D\\u9AD8\\u201D\\u3002\\u5982\\u679C\\u771F\\u6309\\u8BBE\\u8BA1\\u7A3F\\u6765\\u8FD8\\u539F\\uFF0C\\u90A3\\u7B80\\u76F4\\u5C31\\u662F\\u4E2A\\u707E\\u96BE\\u2026\\u2026\"}),`\n`,(0,e.jsx)(n.p,{children:\"\\u4E0B\\u9762\\u5206\\u4E3A\\u524D\\u540E\\u7AEF\\u4E24\\u4E2A\\u90E8\\u5206\\u6765\\u5C0F\\u7ED3\\u5427\\uFF0C\\u6BD5\\u7ADF\\u662F\\u4E00\\u4E2A\\u5B8C\\u6574\\u7684\\u5168\\u6808\\u9879\\u76EE\\uFF0C\\u5148\\u8BF4\\u540E\\u7AEF\\u90E8\\u5206\\uFF1A\"}),`\n`,(0,e.jsx)(n.h2,{children:\"\\u540E\\u7AEF\\u90E8\\u5206\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u8FD9\\u6B21\\u540E\\u7AEF\\u7528\\u7684\\u662F\",(0,e.jsx)(n.code,{children:\"express\"}),\"\\u548C\",(0,e.jsx)(n.code,{children:\"MySQL\"}),\"\\uFF0C\\u539F\\u59CB\\u9700\\u6C42\\u662F\\uFF1A\"]}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"\\u65B9\\u6CD5\\u5185\\u5BB9\\u9700\\u8981\\u767B\\u5F55\\u540E\\u624D\\u80FD\\u67E5\\u770B\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u672A\\u5173\\u6CE8\\u670D\\u52A1\\u53F7\\u7684\\u7528\\u6237\\u626B\\u7801\\u540E\\u5173\\u6CE8\\u670D\\u52A1\\u53F7\\u5E76\\u767B\\u5F55\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u5DF2\\u5173\\u6CE8\\u670D\\u52A1\\u53F7\\u7684\\u7528\\u6237\\u626B\\u7801\\u540E\\u767B\\u5F55\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u9759\\u9ED8\\u5730\\u4E3A\\u7528\\u6237\\u751F\\u6210\\u4E00\\u4E2A\\u8D26\\u53F7\\uFF0C\\u65E0\\u9700\\u8BBE\\u7F6E\\u5BC6\\u7801\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u767B\\u5F55\\u72B6\\u6001\\u4FDD\\u6301\\u4E00\\u5468\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"\\u4E0A\\u8FF0\\u529F\\u80FD\\u5B9E\\u73B0\\u8D77\\u6765\\u903B\\u8F91\\u5E76\\u4E0D\\u590D\\u6742\\uFF0C\\u4E3B\\u8981\\u662F\\u548C\\u5FAE\\u4FE1\\u90A3\\u8FB9\\u7684\\u4EA4\\u4E92\\u7B2C\\u4E00\\u6B21\\u505A\\uFF0C\\u8C03\\u8BD5\\u82B1\\u4E86\\u4E0D\\u5C11\\u529F\\u592B\\u3002\\u597D\\u5728\\u6587\\u6863\\u5199\\u5F97\\u8FD8\\u884C\\uFF0C\\u57FA\\u672C\\u4E0A\\u7167\\u7740\\u5E72\\u95EE\\u9898\\u4E0D\\u5927\\u3002\"}),`\n`,(0,e.jsx)(n.p,{children:\"\\u626B\\u7801\\u767B\\u5F55\\u529F\\u80FD\\u7528\\u5230\\u5FAE\\u4FE1\\u516C\\u4F17\\u5E73\\u53F0\\u4E00\\u4E2A\\u53EB\\u201C\\u5E26\\u53C2\\u6570\\u7684\\u4E8C\\u7EF4\\u7801\\u201D\\u7684 API\\uFF0C\\u6587\\u6863\\u5BF9\\u5176\\u63CF\\u8FF0\\u4E3A\\uFF1A\"}),`\n`,(0,e.jsxs)(n.blockquote,{children:[`\n`,(0,e.jsx)(n.p,{children:\"\\u4E3A\\u4E86\\u6EE1\\u8DB3\\u7528\\u6237\\u6E20\\u9053\\u63A8\\u5E7F\\u5206\\u6790\\u548C\\u7528\\u6237\\u5E10\\u53F7\\u7ED1\\u5B9A\\u7B49\\u573A\\u666F\\u7684\\u9700\\u8981\\uFF0C\\u516C\\u4F17\\u5E73\\u53F0\\u63D0\\u4F9B\\u4E86\\u751F\\u6210\\u5E26\\u53C2\\u6570\\u4E8C\\u7EF4\\u7801\\u7684\\u63A5\\u53E3\\u3002\\u4F7F\\u7528\\u8BE5\\u63A5\\u53E3\\u53EF\\u4EE5\\u83B7\\u5F97\\u591A\\u4E2A\\u5E26\\u4E0D\\u540C\\u573A\\u666F\\u503C\\u7684\\u4E8C\\u7EF4\\u7801\\uFF0C\\u7528\\u6237\\u626B\\u63CF\\u540E\\uFF0C\\u516C\\u4F17\\u53F7\\u53EF\\u4EE5\\u63A5\\u6536\\u5230\\u4E8B\\u4EF6\\u63A8\\u9001\\u3002\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"\\u6839\\u636E\\u5FAE\\u4FE1\\u516C\\u4F17\\u5E73\\u53F0\\u7684\\u6587\\u6863\\uFF0C\\u7528\\u6237\\u626B\\u63CF\\u5E26\\u573A\\u666F\\u503C\\u4E8C\\u7EF4\\u7801\\u65F6\\uFF0C\\u53EF\\u80FD\\u63A8\\u9001\\u4EE5\\u4E0B\\u4E24\\u79CD\\u4E8B\\u4EF6\\uFF1A\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsx)(n.li,{children:\"\\u5982\\u679C\\u7528\\u6237\\u8FD8\\u672A\\u5173\\u6CE8\\u516C\\u4F17\\u53F7\\uFF0C\\u5219\\u7528\\u6237\\u53EF\\u4EE5\\u5173\\u6CE8\\u516C\\u4F17\\u53F7\\uFF0C\\u5173\\u6CE8\\u540E\\u5FAE\\u4FE1\\u4F1A\\u5C06\\u5E26\\u573A\\u666F\\u503C\\u5173\\u6CE8\\u4E8B\\u4EF6\\u63A8\\u9001\\u7ED9\\u5F00\\u53D1\\u8005\\u3002\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u5982\\u679C\\u7528\\u6237\\u5DF2\\u7ECF\\u5173\\u6CE8\\u516C\\u4F17\\u53F7\\uFF0C\\u5728\\u7528\\u6237\\u626B\\u63CF\\u540E\\u4F1A\\u81EA\\u52A8\\u8FDB\\u5165\\u4F1A\\u8BDD\\uFF0C\\u5FAE\\u4FE1\\u4E5F\\u4F1A\\u5C06\\u5E26\\u573A\\u666F\\u503C\\u626B\\u63CF\\u4E8B\\u4EF6\\u63A8\\u9001\\u7ED9\\u5F00\\u53D1\\u8005\\u3002\"}),`\n`]}),`\n`,(0,e.jsx)(n.p,{children:\"\\u4E5F\\u5C31\\u662F\\u8BF4\\uFF0C\\u6211\\u4EEC\\u53EF\\u4EE5\\u8C03\\u7528\\u5FAE\\u4FE1\\u516C\\u4F17\\u5E73\\u53F0\\u8FD9\\u4E00\\u63A5\\u53E3\\u6765\\u751F\\u6210\\u5E26\\u53C2\\u6570\\uFF08\\u573A\\u666F\\u503C\\uFF09\\u7684\\u4E8C\\u7EF4\\u7801\\uFF0C\\u8FD9\\u4E2A\\u53C2\\u6570\\u662F\\u6211\\u4EEC\\u4F20\\u8FC7\\u53BB\\u7684\\uFF0C\\u7528\\u4E8E\\u552F\\u4E00\\u786E\\u5B9A\\u626B\\u7801\\u7684\\u7528\\u6237\\u3002\\u7528\\u6237\\u626B\\u7801\\u540E\\uFF0C\\u5FAE\\u4FE1\\u4F1A\\u628A\\u8BE5\\u4E8B\\u4EF6\\u63A8\\u9001\\u5230\\u6211\\u4EEC\\u7684\\u670D\\u52A1\\u53F7\\uFF0C\\u5E76\\u4E14\\u662F\\u533A\\u5206\\u5173\\u6CE8\\u548C\\u672A\\u5173\\u6CE8\\u7684\\uFF08\\u4E8B\\u4EF6\\u4E0D\\u540C\\uFF09\\u3002\\u56E0\\u6B64\\u6211\\u4EEC\\u53EF\\u4EE5\\u5229\\u7528\\u8FD9\\u4E2A\\u53C2\\u6570\\u4E0E\\u4E8B\\u4EF6\\u7684\\u4E0D\\u540C\\uFF0C\\u6765\\u533A\\u5206\\u7528\\u6237\\u4E0E\\u7528\\u6237\\u7684\\u884C\\u4E3A\\u3002\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/images/my-first-fullstack-project/sequence.png\",alt:\"\\u65F6\\u5E8F\\u56FE\"})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u5982\\u56FE\\u6240\\u793A\\uFF0C\\u6574\\u4E2A\\u6D41\\u7A0B\\u662F\\u8FD9\\u6837\\u7684\\uFF1A\"}),`\n`,(0,e.jsxs)(n.ul,{children:[`\n`,(0,e.jsxs)(n.li,{children:[\"\\u9996\\u5148\\uFF0C\\u7528\\u6237\\u70B9\\u51FB\\u767B\\u5F55\\u6309\\u94AE\\uFF0C\\u8FD9\\u65F6\\u524D\\u7AEF\\u4F1A\\u53BB\\u8BF7\\u6C42\\u670D\\u52A1\\u5668\\u7684\",(0,e.jsx)(n.code,{children:\"/api/get_qrcode\"}),\"\\u63A5\\u53E3\"]}),`\n`,(0,e.jsx)(n.li,{children:\"\\u670D\\u52A1\\u7AEF\\u63A5\\u5230\\u8BF7\\u6C42\\uFF0C\\u751F\\u6210\\u552F\\u4E00\\u7684 UUID\\uFF0C\\u5B58\\u5728\\u5185\\u5B58\\u4E2D\"}),`\n`,(0,e.jsxs)(n.li,{children:[\"\\u670D\\u52A1\\u7AEF\\u7528 UUID \\u53BB\\u8BF7\\u6C42\\u5FAE\\u4FE1\\u7684\",(0,e.jsx)(n.code,{children:\"https://api.weixin.qq.com/cgi-bin/qrcode/create\"}),\"\\u63A5\\u53E3\\uFF0C\\u751F\\u6210\\u5E26\\u53C2\\u6570\\u7684\\u4E8C\\u7EF4\\u7801\"]}),`\n`,(0,e.jsx)(n.li,{children:\"\\u670D\\u52A1\\u7AEF\\u62FF\\u5230\\u5FAE\\u4FE1\\u8FD4\\u56DE\\u7684\\u4E8C\\u7EF4\\u7801\\u94FE\\u63A5\\uFF0C\\u8FDE\\u540C\\u5BF9\\u5E94\\u7684 UUID \\u4E00\\u5E76\\u8FD4\\u56DE\\u7ED9\\u524D\\u7AEF\"}),`\n`,(0,e.jsxs)(n.li,{children:[\"\\u524D\\u7AEF\\u62FF\\u5230\\u4E8C\\u7EF4\\u7801\\u94FE\\u63A5\\uFF0C\\u5C55\\u793A\\u4E8C\\u7EF4\\u7801\\u7ED9\\u7528\\u6237\\uFF0C\\u540C\\u65F6\\u5F00\\u59CB\\u8F6E\\u8BE2\\u670D\\u52A1\\u7AEF\\u7684\\u767B\\u5F55\\u63A5\\u53E3\",(0,e.jsx)(n.code,{children:\"/api/login\"})]}),`\n`,(0,e.jsx)(n.li,{children:\"\\u7528\\u6237\\u626B\\u63CF\\u4E8C\\u7EF4\\u7801\\uFF0C\\u5FAE\\u4FE1\\u670D\\u52A1\\u5668\\u63A5\\u6536\\u5230\\u7528\\u6237\\u7684\\u626B\\u7801\\u4E8B\\u4EF6\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u5FAE\\u4FE1\\u5C06\\u7528\\u6237\\u7684\\u626B\\u7801\\u4E8B\\u4EF6\\u3001OpenID \\u4E0E\\u573A\\u666F\\u503C\\uFF08UUID\\uFF09\\u53D1\\u9001\\u7ED9\\u670D\\u52A1\\u7AEF\\u5904\\u7406\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u670D\\u52A1\\u7AEF\\u63A5\\u6536\\u5230\\u5FAE\\u4FE1\\u7684\\u4E8B\\u4EF6\\uFF0C\\u67E5\\u8BE2\\u6570\\u636E\\u5E93\\u4E2D\\u662F\\u5426\\u5DF2\\u7ECF\\u6709 OpenID \\u5BF9\\u5E94\\u7684\\u8D26\\u53F7\\uFF0C\\u6CA1\\u6709\\u5219\\u521B\\u5EFA\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u67E5\\u8BE2/\\u521B\\u5EFA\\u5B8C\\u8D26\\u53F7\\u540E\\uFF0C\\u670D\\u52A1\\u7AEF\\u67E5\\u8BE2\\u5185\\u5B58\\u4E2D\\u662F\\u5426\\u6709\\u5BF9\\u5E94\\u7684 UUID\\uFF0C\\u6CA1\\u6709\\u5219\\u8FD4\\u56DE\\u9519\\u8BEF\\u7801\\u7ED9\\u524D\\u7AEF\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u5982\\u679C\\u670D\\u52A1\\u7AEF\\u67E5\\u8BE2\\u5230\\u5185\\u5B58\\u4E2D\\u6709\\u5BF9\\u5E94\\u7684 UUID\\uFF0C\\u5219\\u628A\\u8D26\\u53F7\\u4FE1\\u606F\\u8FD4\\u56DE\\u7ED9\\u8FD8\\u5728\\u8F6E\\u8BE2\\u7684\\u524D\\u7AEF\"}),`\n`,(0,e.jsx)(n.li,{children:\"\\u524D\\u7AEF\\u83B7\\u53D6\\u5230\\u7528\\u6237\\u4FE1\\u606F\\u540E\\uFF0C\\u5904\\u7406\\u767B\\u5F55\\u72B6\\u6001\"}),`\n`]}),`\n`,(0,e.jsx)(n.h3,{children:\"\\u767B\\u5F55\\u76F8\\u5173\\u7684\\u63A5\\u53E3\"}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"/api/login\"}),\"\\u63A5\\u53E3\\u7684\\u903B\\u8F91\\u975E\\u5E38\\u7B80\\u5355\\uFF0C\\u4EE3\\u7801\\u5982\\u4E0B\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`const express = require(\"express\");\nconst router = express.Router();\nconst authManager = require(\"../utils/authManager\").getManager();\n\nrouter.get(\"/login\", async (req, res) =\u003e {\n  const { uid } = req.query;\n  const auth = authManager.getAuth(uid);\n  if (auth) {\n    res.send({ code: 0, user: { ...auth } });\n  } else {\n    // \\u8FD4\\u56DE\\u9519\\u8BEF\\u7801\\u7ED9\\u524D\\u7AEF\\u7EE7\\u7EED\\u8F6E\\u8BE2\n  }\n});\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u5176\\u4E2D\\u7684\",(0,e.jsx)(n.code,{children:\"authManager\"}),\"\\u662F\\u4E00\\u4E2A\\u5355\\u4F8B\\uFF0C\\u7528\\u6765\\u7BA1\\u7406\\u767B\\u5F55\\u76F8\\u5173\\u7684\\u903B\\u8F91\\uFF0C\\u4E3B\\u8981\\u65B9\\u6CD5\\u5982\\u4E0B\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`const MAX_LOAD = 1000; // \\u201C\\u626B\\u7801\\u201D\\u961F\\u5217\\uFF0C\\u9650\\u5236\\u6700\\u5927\\u7B49\\u5F85\\u4EBA\\u6570\n\nclass AuthManager {\n  constructor() {\n    // \\u7528 Map \\u6765\\u6A21\\u62DF\\u961F\\u5217\n    this.data = new Map();\n  }\n  // \\u83B7\\u53D6\\u5355\\u4F8B\n  static getManager() {\n    if (!this.instance) {\n      this.instance = new AuthManager();\n    }\n    return this.instance;\n  }\n  // \\u4EE5 uid \\u4E3A key\\uFF0C\\u4FDD\\u5B58\\u7528\\u6237\\u4FE1\\u606F\\u5728\\u961F\\u5217\\u4E2D\\uFF0C\\u7565\n  setAuth(uid, user) {}\n  // \\u4EE5 uid \\u4E3A key \\u83B7\\u53D6\\u7528\\u6237\\u4FE1\\u606F\\uFF0C\\u7565\n  getAuth(uid) {}\n  // \\u5224\\u65AD\\u961F\\u5217\\u662F\\u5426\\u5DF2\\u6EE1\\uFF0C\\u6EE1\\u5219\\u5C1D\\u8BD5\\u6E05\\u9664\\u8FC7\\u671F\\u7684\\u8BF7\\u6C42\n  isAvailable() {\n    if (this.data.size \u003e= MAX_LOAD) {\n      [...this.data].forEach(([key, value]) =\u003e {\n        if (Date.now() - value.createTime \u003e 60 * 1000) {\n          this.data.delete(key);\n        }\n      });\n    }\n    return this.data.size \u003c MAX_LOAD;\n  }\n}\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u8003\\u8651\\u5230\\u626B\\u7801\\u4E0E\\u767B\\u5F55\\u8F6E\\u8BE2\\u95F4\\u5B58\\u5728\\u65F6\\u95F4\\u5DEE\\uFF0C\\u800C\\u767B\\u5F55\\u4FE1\\u606F\\u5373\\u4F7F\\u4E22\\u5931\\uFF0C\\u4E5F\\u4E0D\\u4F1A\\u4EA7\\u751F\\u4E25\\u91CD\\u95EE\\u9898\\uFF08\\u6700\\u591A\\u9020\\u6210\\u524D\\u7AEF\\u8F6E\\u8BE2\\u8D85\\u65F6\\uFF0C\\u53EF\\u4EE5\\u91CD\\u6765\\uFF09\\uFF0C\\u5C31\\u628A\\u5B83\\u76F4\\u63A5\\u5B58\\u5728\\u5185\\u5B58\\u4E2D\\u3002\\u8FD9\\u91CC\\u7528\\u4E00\\u4E2A\",(0,e.jsx)(n.code,{children:\"Map\"}),\"\\u6765\\u6A21\\u62DF\\u961F\\u5217\\uFF0C\\u4E14\\u8BBE\\u7F6E\\u4E86\\u6700\\u5927\\u5BB9\\u91CF\\uFF0C\\u9632\\u6B62\\u592A\\u591A\\u4EBA\\u540C\\u65F6\\u626B\\u7801\\u6324\\u7206\\u5185\\u5B58\\u3002\",(0,e.jsx)(n.code,{children:\"isAvailable()\"}),\"\\u65B9\\u6CD5\\u7528\\u4E8E\\u5224\\u65AD\\u961F\\u5217\\u662F\\u5426\\u5DF2\\u6EE1\\uFF0C\\u6EE1\\u5219\\u904D\\u5386\\u6E05\\u9664\\u8FC7\\u671F\\u7684\\u8BF7\\u6C42\\u3002\",(0,e.jsx)(n.code,{children:\"uid\"}),\"\\u5219\\u4F5C\\u4E3A\\u552F\\u4E00\\u7684\\u6807\\u8BC6\\u94FE\\u63A5\\u7740\\u7528\\u6237\\u3001\\u5FAE\\u4FE1\\u4E0E\\u4E1A\\u52A1\\u903B\\u8F91\\u4E09\\u8005\\u3002\"]}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"/api/get_qrcode\"}),\"\\u63A5\\u53E3\\u7684\\u6838\\u5FC3\\u903B\\u8F91\\u5982\\u4E0B\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`// \\u7701\\u7565\\u90E8\\u5206\\u5BFC\\u5165\nconst { v4: uuidv4 } = require(\"uuid\");\nconst TICKET_URL = \"https://api.weixin.qq.com/cgi-bin/qrcode/create\";\nconst QR_URL = (ticket) =\u003e\n  \\`https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=\\${ticket}\\`;\nconst tokenManager = require(\"../utils/tokenManager\").getManager();\nconst authManager = require(\"../utils/authManager\").getManager();\nconst QR_EXPIRE_TIME = 604800;\n\nrouter.get(\"/get_qrcode\", async (req, res) =\u003e {\n  if (!authManager.isAvailable()) {\n  } // \\u7701\\u7565\\u961F\\u5217\\u6EE1\\u65F6\\u7684\\u9519\\u8BEF\\u5904\\u7406\n  const token = tokenManager.getToken();\n  const uid = uuidv4();\n  try {\n    if (!token) {\n      // \\u7701\\u7565 token \\u4E3A\\u7A7A\\u65F6\\u7684\\u9519\\u8BEF\\u5904\\u7406\n    }\n    const response = await axios.post(\n      TICKET_URL,\n      {\n        expire_seconds: QR_EXPIRE_TIME,\n        action_name: \"QR_STR_SCENE\",\n        action_info: {\n          scene: {\n            scene_str: uid,\n          },\n        },\n      },\n      { params: { access_token: token } }\n    );\n    // \\u7701\\u7565\\u5904\\u7406\\u8FD4\\u56DE\\u9519\\u8BEF\\u7801\\u7684\\u90E8\\u5206\n    const { ticket, expire_seconds } = response.data;\n    res.send({\n      code: 0,\n      uid,\n      imgUrl: QR_URL(ticket),\n      createTime: Date.now(),\n      expireTime: expire_seconds,\n    });\n  } catch (error) {\n    // \\u7701\\u7565\\u9519\\u8BEF\\u5904\\u7406\\u7684\\u90E8\\u5206\n  }\n});\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"/api/get_qrcode\"}),\"\\u63A5\\u53E3\\u7684\\u6838\\u5FC3\\u903B\\u8F91\\u5C31\\u662F\\u751F\\u6210 UUID\\uFF0C\\u7136\\u540E\\u8C03\\u7528\\u5FAE\\u4FE1\\u751F\\u6210\\u5E26\\u53C2\\u6570\\u4E8C\\u7EF4\\u7801\\u7684\\u63A5\\u53E3\\uFF0C\\u7136\\u540E\\u8FD4\\u56DE\\u83B7\\u53D6\\u5230\\u7684\\u4E8C\\u7EF4\\u7801\\u94FE\\u63A5\\uFF0C\\u6BD4\\u8F83\\u7B80\\u5355\\uFF0C\\u8BE6\\u60C5\\u53EF\\u4EE5\\u67E5\\u770B\",(0,e.jsx)(n.a,{href:\"https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Generating_a_Parametric_QR_Code.html\",children:\"\\u5FAE\\u4FE1\\u7684\\u6587\\u6863\"}),\"\\u4E86\\u89E3\\u66F4\\u591A\\u3002\\u5176\\u4E2D\\u7684\",(0,e.jsx)(n.code,{children:\"tokenManager\"}),\"\\u662F\\u7528\\u6765\\u83B7\\u53D6\\u5FAE\\u4FE1\\u7684\",(0,e.jsx)(n.code,{children:\"access_token\"}),\"\\uFF0C\\u8C03\\u7528\\u516C\\u4F17\\u53F7\\u7684\\u63A5\\u53E3\\u65F6\\u90FD\\u8981\\u5E26\\u4E0A\\u3002\",(0,e.jsx)(n.code,{children:\"tokenManager\"}),\"\\u4F1A\\u5B9A\\u65F6\\u5237\\u65B0 token\\uFF0C\\u7528\\u6587\\u4EF6\\u7684\\u5F62\\u5F0F\\u4FDD\\u5B58\\u5728\\u672C\\u5730\\uFF0C\\u5177\\u4F53\\u903B\\u8F91\\u6BD4\\u8F83\\u7B80\\u5355\\u5728\\u6B64\\u7565\\u8FC7\\uFF0C\\u8BE6\\u60C5\\u53EF\\u4EE5\\u67E5\\u770B\",(0,e.jsx)(n.a,{href:\"https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html\",children:\"\\u5FAE\\u4FE1\\u7684\\u6587\\u6863\"}),\"\\u4E86\\u89E3\\u66F4\\u591A\\u3002\"]}),`\n`,(0,e.jsx)(n.h3,{children:\"\\u5904\\u7406\\u5FAE\\u4FE1\\u6D88\\u606F\\u7684\\u76F8\\u5173\\u63A5\\u53E3\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u8FD9\\u6B21\\u540E\\u7AEF\\u90E8\\u5206\\u6700\\u6838\\u5FC3\\u7684\\u5E94\\u8BE5\\u5C31\\u662F\\u5904\\u7406\\u5FAE\\u4FE1\\u6D88\\u606F\\u7684\\u63A5\\u53E3\\u4E86\\u3002\\u63A5\\u5165\\u5FAE\\u4FE1\\u516C\\u4F17\\u5E73\\u53F0\\u540E\\uFF0C\\u539F\\u672C\\u5728\\u516C\\u4F17\\u53F7\\u540E\\u53F0\\u914D\\u7F6E\\u7684\\u83DC\\u5355\\u548C\\u5173\\u952E\\u8BCD\\u7B49\\u90FD\\u5931\\u6548\\u4E86\\uFF0C\\u8981\\u624B\\u5DE5\\u53BB\\u64CD\\u4F5C\\u5B9E\\u73B0\\u3002\\u6240\\u6709\\u5FAE\\u4FE1\\u7528\\u6237\\u53D1\\u7684\\u6D88\\u606F\\u3001\\u626B\\u7801\\u3001\\u5173\\u6CE8\\u3001\\u70B9\\u51FB\\u83DC\\u5355\\u7B49\\u884C\\u4E3A\\u90FD\\u4F1A\\u88AB\\u8F6C\\u5230\\u8BE5\\u63A5\\u53E3\\u6765\\u5904\\u7406\\u3002\\u9700\\u8981\\u6CE8\\u610F\\u7684\\u662F\\uFF0C\\u8FD9\\u4E9B\\u6D88\\u606F\\u9700\\u8981\\u5728 5 \\u79D2\\u5185\\u56DE\\u590D\\uFF0C\\u5FAE\\u4FE1\\u4F1A\\u91CD\\u8BD5 3 \\u6B21\\uFF0C\\u5982\\u679C\\u4E0D\\u80FD\\u9A6C\\u4E0A\\u5904\\u7406\\u5B8C\\uFF0C\\u53EF\\u4EE5\\u76F4\\u63A5\\u56DE\\u590D\\u7A7A\\u4E32\\u3002\\u5FAE\\u4FE1\\u80FD\\u63A5\\u53D7\\u7684\\u56DE\\u590D\\u53EA\\u6709\",(0,e.jsx)(n.code,{children:'\"success\"'}),\"\\u4E0E\",(0,e.jsx)(n.code,{children:'\"\"'}),\"\\uFF08\\u5B57\\u8282\\u957F\\u5EA6\\u4E3A 0 \\u7684\\u7A7A\\u5B57\\u7B26\\u4E32\\uFF09\\uFF0C\\u5F53\\u65F6\\u6211\\u56DE\\u590D\\u4E86\",(0,e.jsx)(n.code,{children:'\"ok\"'}),\"\\uFF0C\\u7ED3\\u679C\\u4E00\\u76F4\\u63D0\\u793A\\u201C\\u8BE5\\u516C\\u4F17\\u53F7\\u6682\\u65F6\\u65E0\\u6CD5\\u63D0\\u4F9B\\u670D\\u52A1\\uFF0C\\u8BF7\\u7A0D\\u540E\\u518D\\u8BD5\\u201D\\uFF0Cdebug \\u4E86\\u597D\\u4E45\\u624D\\u53D1\\u73B0\\u95EE\\u9898\\u3002\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`const express = require(\"express\");\nconst router = express.Router();\nconst XMLJS = require(\"xml2js\");\nconst parser = new XMLJS.Parser();\nconst WechatHandler = require(\"../utils/wechatHandler\");\n\nrouter.post(\"/\", (req, res) =\u003e {\n  req.on(\"data\", (data) =\u003e {\n    parser.parseString(data.toString(), (err, result) =\u003e {\n      if (err) {\n        // \\u7701\\u7565\\u9519\\u8BEF\\u7684\\u5904\\u7406\n      }\n      const body = result.xml;\n      const handler = new WechatHandler(body);\n      handler.run((message) =\u003e res.send(message));\n    });\n  });\n});\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u7531\\u4E8E\\u5FAE\\u4FE1\\u53D1\\u8FC7\\u6765\\u7684\\u6D88\\u606F\\u662F XML \\u683C\\u5F0F\\u7684\\uFF0C\\u8FD9\\u91CC\\u7528\\u4E86\",(0,e.jsx)(n.code,{children:\"xml2js\"}),\"\\u8FD9\\u4E2A\\u5305\\u6765\\u5904\\u7406\\uFF0CXML \\u7684\\u5404\\u5B57\\u6BB5\\u5B9A\\u4E49\\u53EF\\u4EE5\\u770B\\u5FAE\\u4FE1\\u7684\\u6587\\u6863\\uFF1A\",(0,e.jsx)(n.a,{href:\"https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_standard_messages.html\",children:\"\\u666E\\u901A\\u6D88\\u606F\"}),\"\\uFF0C\",(0,e.jsx)(n.a,{href:\"https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_event_pushes.html\",children:\"\\u4E8B\\u4EF6\\u63A8\\u9001\"}),\"\\u3002\\u89E3\\u5F00 XML \\u540E\\uFF0C\\u5C06\\u4E8B\\u4EF6\\u4EA4\\u7ED9\",(0,e.jsx)(n.code,{children:\"WechatHandler\"}),\"\\u6765\\u7EDF\\u4E00\\u5904\\u7406\\uFF0C\\u6838\\u5FC3\\u4EE3\\u7801\\u5982\\u4E0B\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`const DEFAULT_REPLY_MSG = \"\"; // \\u9ED8\\u8BA4\\u7684\\u56DE\\u590D\\u5185\\u5BB9\\uFF0C\\u7A7A\\u4E32\n// \\u9700\\u8981\\u5904\\u7406\\u7684\\u4E8B\\u4EF6\nconst IMPLEMENTED_EVENTS = [\"subscribe\", \"unsubscribe\", \"SCAN\", \"CLICK\"];\n// \\u7B56\\u7565\\u5BF9\\u8C61\\uFF0C\\u7701\\u7565\\u5177\\u4F53\\u5B9E\\u73B0\nconst Handle = {\n  async subscribe({ key, openId, devId }, reply) {},\n  async unsubscribe({ openId }, reply) {},\n  async SCAN({ key: uid, openId }, reply) {},\n  async CLICK({ key, openId, devId }, reply) {},\n};\n\nclass WechatHandler {\n  constructor(body) {\n    const { ToUserName, FromUserName, MsgType, Event, EventKey } = body;\n    this.type = MsgType[0];\n    this.openId = FromUserName[0];\n    this.devId = ToUserName[0];\n    this.event = Event ? Event[0] : null;\n    this.key = EventKey ? EventKey[0] : null;\n  }\n  run(reply) {\n    const config = {\n      openId: this.openId,\n      devId: this.devId,\n      key: this.key,\n    };\n    switch (this.type) {\n      case \"event\":\n        if (IMPLEMENTED_EVENTS.includes(this.event)) {\n          Handle[this.event](config, reply);\n        } else {\n          reply(DEFAULT_REPLY_MSG);\n        }\n        break;\n      default:\n        reply(DEFAULT_REPLY_MSG);\n        break;\n    }\n  }\n}\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"WechatHandler\"}),\"\\u7684\\u4E3B\\u8981\\u4F5C\\u7528\\u662F\\u4ECE XML \\u5BF9\\u8C61\\u4E2D\\u89E3\\u51FA\\u5404\\u4E2A\\u5B57\\u6BB5\\uFF0C\\u518D\\u6839\\u636E\\u4E8B\\u4EF6\\u7684\\u7C7B\\u578B\\u4F5C\\u4E0D\\u540C\\u7684\\u5904\\u7406\\u3002\\u8FD9\\u91CC\\u8FD8\\u7528\\u5230\\u4E86\\u7B56\\u7565\\u6A21\\u5F0F\\uFF0C\\u6765\\u5904\\u7406\\u4E0D\\u540C\\u7684\",(0,e.jsx)(n.code,{children:'\"event\"'}),\"\\u7C7B\\u578B\\u4E8B\\u4EF6\\u3002\\u4E0D\\u540C\\u7684\\u4E8B\\u4EF6\\u5B9A\\u4E49\\u53EF\\u4EE5\\u67E5\\u770B\",(0,e.jsx)(n.a,{href:\"https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_event_pushes.html\",children:\"\\u5FAE\\u4FE1\\u6587\\u6863\"}),\"\\uFF0C\\u9700\\u8981\\u6CE8\\u610F\\u7684\\u662F\\u201C\\u626B\\u7801\\u201D\\u8FD9\\u4E00\\u64CD\\u4F5C\\uFF0C\\u6839\\u636E\\u7528\\u6237\\u662F\\u5426\\u5DF2\\u5173\\u6CE8\\u516C\\u53F7\\uFF0C\\u533A\\u5206\\u4E3A\",(0,e.jsx)(n.code,{children:'\"SCAN\"'}),\"\\u4E0E\",(0,e.jsx)(n.code,{children:'\"subscribe\"'}),\"\\u4E24\\u4E2A\\u4E8B\\u4EF6\\uFF0C\\u903B\\u8F91\\u7684\\u5904\\u7406\\u7A0D\\u6709\\u4E0D\\u540C\\u3002\"]}),`\n`,(0,e.jsx)(n.p,{children:\"\\u4EE5\\u4E0A\\u5C31\\u662F\\u540E\\u7AEF\\u90E8\\u5206\\u7684\\u5C0F\\u7ED3\\uFF0C\\u4E0B\\u9762\\u6765\\u8BF4\\u8BF4\\u524D\\u7AEF\\u3002\"}),`\n`,(0,e.jsx)(n.h2,{children:\"\\u524D\\u7AEF\\u90E8\\u5206\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u524D\\u7AEF\\u8FD9\\u6B21\\u8FD8\\u662F\\u7528 React \\u6765\\u5199\\uFF0C\\u7531\\u4E8E\\u6709 20 \\u51E0\\u7BC7\\u9759\\u6001\\u7684\\u5185\\u5BB9\\u9875\\uFF0C\\u6837\\u5F0F\\u57FA\\u672C\\u4E00\\u81F4\\uFF0C\\u6240\\u4EE5\\u51B3\\u5B9A\\u7EE7\\u7EED\\u7528\",(0,e.jsx)(n.code,{children:\"next.js\"}),\"\\u52A0 MDX \\u6765\\u505A\\u3002\\u5185\\u5BB9\\u7531 Word \\u6587\\u6863\\u8F6C\\u4E3A MDX\\uFF0C\\u7136\\u540E\\u6837\\u5F0F\\u90E8\\u5206\\u7528\",(0,e.jsx)(n.code,{children:\"SASS\"}),\"\\u6765\\u5199\\uFF0C\\u4F46\\u7531\\u4E8E\\u65F6\\u95F4\\u6BD4\\u8F83\\u8D76\\uFF0C\\u6240\\u4EE5\\u5199\\u5F97\\u5F88\\u4E71\\uFF0C\\u5F00\\u53D1\\u8FC7\\u7A0B\\u4E2D\\u9047\\u5230\\u8FC7\\u5F88\\u591A\\u6B21 specificity \\u51B2\\u7A81\\u5BFC\\u81F4\\u6837\\u5F0F\\u8986\\u76D6\\u6216\\u4E0D\\u751F\\u6548\\u7684\\u95EE\\u9898\\u3002\\u8FD9\\u90E8\\u5206\\u6253\\u7B97\\u540E\\u9762\\u6709\\u65F6\\u95F4\\u4E86\\u91CD\\u6784\\u4E00\\u4E0B\\uFF0C\\u4E0D\\u7136\\u4EE5\\u540E\\u8981\\u6539\\u5F88\\u96BE\\u7EF4\\u62A4\\u3002\"]}),`\n`,(0,e.jsx)(n.h3,{children:\"\\u65E0\\u9650\\u7FFB\\u9875\"}),`\n`,(0,e.jsx)(n.p,{children:\"\\u8FD9\\u6B21\\u9996\\u9875\\u6709\\u4E00\\u4E2A\\u7FFB\\u9875\\u7EC4\\u4EF6\\u7684\\u9700\\u6C42\\uFF0C\\u7528\\u6765\\u5C55\\u793A\\u6240\\u6709\\u65B9\\u6CD5\\u7684\\u5217\\u8868\\uFF0C\\u652F\\u6301\\u65E0\\u9650\\u7FFB\\u9875\\u3002\\u7531\\u4E8E\\u662F\\u8FB9\\u5B66\\u4E60\\u8FB9\\u505A\\u7684\\u9879\\u76EE\\uFF0C\\u6240\\u4EE5\\u8FD9\\u5757\\u6CA1\\u6709\\u76F4\\u63A5\\u7528\\u73B0\\u6210\\u7684\\u8F6E\\u5B50\\uFF0C\\u800C\\u662F\\u81EA\\u5DF1\\u5B9E\\u73B0\\u4E86\\u4E00\\u4E2A\\u7B80\\u5355\\u7684\\u7FFB\\u9875\\u7EC4\\u4EF6\\u3002\"}),`\n`,(0,e.jsx)(n.p,{children:\"\\u65B9\\u6CD5\\u4E00\\u5171\\u6709 27 \\u4E2A\\uFF0C\\u6309 3 x 3 \\u6BCF\\u9875\\uFF0C\\u4E00\\u5171\\u9700\\u8981 3 \\u9875\\u3002\\u65E0\\u9650\\u7FFB\\u9875\\u7684\\u539F\\u7406\\u5176\\u5B9E\\u5F88\\u7B80\\u5355\\uFF0C\\u5728\\u524D\\u540E\\u5404\\u52A0\\u4E0A\\u4E00\\u4E2A\\u201C\\u4F2A\\u9875\\u201D\\u3002\\u6700\\u5DE6\\u8FB9\\u662F\\u201C\\u4F2A P3\\u201D\\uFF0C\\u6700\\u53F3\\u8FB9\\u662F\\u201C\\u4F2A P1\\u201D\\u3002\\u8FD9\\u6837\\u5F53\\u4ECE P1 \\u5F80\\u5DE6\\u6ED1\\u52A8\\u7684\\u65F6\\u5019\\uFF0C\\u5C31\\u53EF\\u4EE5\\u7EED\\u4E0A\\u5F62\\u6210\\u4E00\\u4E2A\\u95ED\\u5408\\u7684\\u201C\\u73AF\\u201D\\u4E86\\u3002\\u800C\\u4E3A\\u4E86\\u4ECE\\u8FD9\\u4E2A\\u201C\\u4F2A\\u9875\\u201D\\u7EE7\\u7EED\\u6ED1\\u52A8\\uFF0C\\u9700\\u8981\\u5728\\u6ED1\\u52A8\\u5230\\u4E24\\u5934\\u7684\\u201C\\u4F2A\\u9875\\u201D\\u65F6\\uFF0C\\u5207\\u6362\\u56DE\\u201C\\u4F2A\\u9875\\u201D\\u6240\\u5BF9\\u5E94\\u7684\\u201C\\u771F\\u9875\\u201D\\u4E0A\\u3002\\u8FD9\\u4E2A\\u5207\\u6362\\u7684\\u52A8\\u4F5C\\u53D1\\u751F\\u5728\\u6ED1\\u52A8\\u52A8\\u753B\\u7ED3\\u675F\\u65F6\\uFF0C\\u5E76\\u4E14\\u5207\\u6362\\u8FC7\\u7A0B\\u662F\\u4E00\\u4E2A\\u6CA1\\u6709\\u52A8\\u753B\\u7684\\u201C\\u77AC\\u95F4\\u79FB\\u52A8\\u201D\\u52A8\\u4F5C\\u3002\\u9875\\u9762\\u7684\\u7ED3\\u6784\\u4E0E\\u5207\\u6362\\u5982\\u4E0B\\u56FE\\u6240\\u793A\\uFF1A\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/images/my-first-fullstack-project/carousel.png\",alt:\"\\u7FFB\\u9875\\u7ED3\\u6784\"})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u4ECE\\u201C\\u4F2A P3\\u201D\\u5207\\u6362\\u5230\\u201C\\u771F P3\\u201D\\u7684\\u201C\\u77AC\\u95F4\\u79FB\\u52A8\\u201D\\uFF1A\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/images/my-first-fullstack-project/carousel-switch.png\",alt:\"\\u7FFB\\u9875\\u5207\\u6362\"})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u6211\\u505A\\u4E86\\u4E2A\\u52A8\\u753B\\u6765\\u5C55\\u793A\\u8FD9\\u4E00\\u8FC7\\u7A0B\\uFF0C\\u5F53\\u6ED1\\u52A8\\u5230\\u6700\\u5DE6\\u8FB9\\u4E00\\u9875\\u7684\\u201C\\u4F2A P3\\u201D\\u65F6\\uFF0C\\u201C\\u77AC\\u95F4\\u79FB\\u52A8\\u201D\\u5230\\u201C\\u771F P3\\u201D\\u5904\\uFF0C\\u4ECE\\u800C\\u5F62\\u6210\\u8FDE\\u7EED\\u7684\\u201C\\u73AF\\u201D\\uFF1A\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/images/my-first-fullstack-project/carousel.gif\",alt:\"\\u7FFB\\u9875\\u52A8\\u753B\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u4E0B\\u9762\\u662F\\u7FFB\\u9875\\u7EC4\\u4EF6\",(0,e.jsx)(n.code,{children:\"MethodList\"}),\"\\u7684\\u6838\\u5FC3\\u4EE3\\u7801\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`const MethodList = ({ methods }) =\u003e {\n  const [index, setIndex] = useState(1); // \\u5F53\\u524D\\u9875\n  /* ---- \\u7701\\u7565\\u90E8\\u5206 ---- */\n  const reposition = () =\u003e {\n    // \\u5904\\u7406\\u201C\\u77AC\\u95F4\\u79FB\\u52A8\\u201D\\u7684\\u903B\\u8F91\n  };\n  const itemCount = isNarrowScreen ? 6 : 9; // \\u6BCF\\u9875\\u5143\\u7D20\\u7684\\u6570\\u91CF\n  const pageCount = Math.ceil(methods.length / itemCount) + 2; // \\u603B\\u9875\\u6570\\uFF08\\u5305\\u62EC\\u201C\\u4F2A\\u9875\\u201D\\uFF09\n  function getMethods(index) {\n    // \\u5DE6\\u201C\\u4F2A\\u9875\\u201D\n    if (index === 0) {\n      const count = methods.length % itemCount;\n      return methods.slice(count === 0 ? -itemCount : -count);\n    }\n    // \\u53F3\\u201C\\u4F2A\\u9875\\u201D\n    if (index === pageCount - 1) return methods.slice(0, itemCount);\n    // \\u201C\\u771F\\u9875\\u201D\n    return methods.slice(\n      (index - 1) * itemCount,\n      (index - 1) * itemCount + itemCount\n    );\n  }\n  // \\u7B80\\u5316\\u4E86 JSX \\u7684\\u7ED3\\u6784\n  return (\n    \u003cdiv\n      className=\"content\"\n      style={{\n        left: \\`-\\${index * 100}%\\`,\n        width: \\`\\${pageCount * 100}%\\`,\n        transition: transition ? \"all 1s\" : null,\n      }}\n      onTransitionEnd={reposition}\n    \u003e\n      {[...Array(pageCount).keys()].map((i) =\u003e (\n        \u003cdiv key={i} className=\"page\"\u003e\n          {getMethods(i).map((method) =\u003e (\n            \u003cCard key={method.id} method={method} /\u003e\n          ))}\n        \u003c/div\u003e\n      ))}\n    \u003c/div\u003e\n  );\n};\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"getMethods()\"}),\"\\u65B9\\u6CD5\\u662F\\u65B9\\u4FBF\\u83B7\\u53D6\\u6BCF\\u4E00\\u9875\\u653E\\u7F6E\\u7684\\u65B9\\u6CD5\\u5217\\u8868\\uFF0C\\u5BF9\\u4E8E\\u5934\\u5C3E\\u4E24\\u4E2A\\u201C\\u4F2A\\u9875\\u201D\\u8981\\u505A\\u7279\\u6B8A\\u5904\\u7406\\u3002\",(0,e.jsx)(n.code,{children:\"reposition()\"}),\"\\u65B9\\u6CD5\\u5219\\u662F\\u5728\",(0,e.jsx)(n.code,{children:\"onTransitionEnd\"}),\"\\u4E8B\\u4EF6\\u89E6\\u53D1\\u65F6\\u8C03\\u7528\\uFF0C\\u5224\\u65AD\\u5F53\\u524D\\u5982\\u679C\\u662F\\u201C\\u4F2A\\u9875\\u201D\\uFF0C\\u5219\\u89E6\\u53D1\\u201C\\u77AC\\u95F4\\u79FB\\u52A8\\u201D\\u7684\\u64CD\\u4F5C\\uFF08\\u66F4\\u65B0\",(0,e.jsx)(n.code,{children:\"index\"}),\"\\u7684\\u503C\\uFF09\\u3002\",(0,e.jsx)(n.code,{children:\"pageCount\"}),\"\\u662F\\u6BCF\\u9875\\u5143\\u7D20\\u7684\\u6570\\u91CF\\uFF0C\\u4F1A\\u6839\\u636E\\u5C4F\\u5E55\\u7684\\u5BBD\\u7A84\\u6765\\u786E\\u5B9A\\uFF0C\\u5B9E\\u73B0\\u54CD\\u5E94\\u5F0F\\u5E03\\u5C40\\u7684\\u9700\\u6C42\\uFF0C\\u4E0B\\u9762\\u4F1A\\u6709\\u8BB2\\u5230\",(0,e.jsx)(n.code,{children:\"isNarrowScreen\"}),\"\\u7684\\u8BA1\\u7B97\\u65B9\\u6CD5\\u3002\\u9875\\u9762\\u95F4\\u7684\\u5207\\u6362\\u7528\\u7684\\u662F CSS \\u7684\",(0,e.jsx)(n.code,{children:\"left\"}),\"\\u5C5E\\u6027\\uFF0C\\u6839\\u636E\",(0,e.jsx)(n.code,{children:\"index\"}),\"\\u6765\\u786E\\u5B9A\\u503C\\u3002\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u8FD9\\u91CC\\u6709\\u4E2A\\u5C0F\\u7455\\u75B5\\u8FD8\\u6CA1\\u5B8C\\u5584\\uFF0C\\u5F53\\u5FEB\\u901F\\u70B9\\u51FB\\u5207\\u6362\\u9875\\u9762\\uFF0C\\u5207\\u6362\\u5230\\u5C3E\\u7AEF\\u7684\\u201C\\u4F2A\\u9875\\u201D\\u65F6\\uFF0C\\u7EE7\\u7EED\\u70B9\\u51FB\\u5207\\u6362\\u4F1A\\u6CA1\\u53CD\\u5E94\\uFF0C\\u56E0\\u4E3A\",(0,e.jsx)(n.code,{children:\"reposition\"}),\"\\u8981\\u7B49\\u5F85\\u52A8\\u753B\\u5B8C\\u6210\",(0,e.jsx)(n.code,{children:\"onTransitionEnd\"}),\"\\u65F6\\u624D\\u4F1A\\u8C03\\u7528\\u3002\\u8FD9\\u4E2A\\u5C0F bug \\u7B49\\u6709\\u65F6\\u95F4\\u4E86\\u518D\\u4F18\\u5316\\u3002\"]}),`\n`,(0,e.jsx)(n.h3,{children:\"\\u54CD\\u5E94\\u5F0F\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.img,{src:\"/images/my-first-fullstack-project/light-salt-responsive.png\",alt:\"\\u54CD\\u5E94\\u5F0F\\u6837\\u5F0F\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u9879\\u76EE\\u8981\\u6C42 PC \\u7AEF\\u548C\\u624B\\u673A\\u7AEF\\u90FD\\u53EF\\u4EE5\\u6D4F\\u89C8\\uFF0C\\u7531\\u4E8E\\u90FD\\u662F\\u6BD4\\u8F83\\u7B80\\u5355\\u7684\\u5C55\\u793A\\u9875\\uFF0C\\u6240\\u4EE5\\u5C31\\u76F4\\u63A5\\u505A\\u6210\\u54CD\\u5E94\\u5F0F\\u7684\\u4E86\\u3002\\u7528\",(0,e.jsx)(n.code,{children:\"@media\"}),\"\\u8C03\\u4E00\\u4E0B\\u5E03\\u5C40\\u7684\\u6837\\u5F0F\\uFF0C\\u57FA\\u4E8E\",(0,e.jsx)(n.code,{children:\"rem\"}),\"\\u53BB\\u505A\\u8FD8\\u662F\\u6BD4\\u8F83\\u7B80\\u5355\\u7684\\u3002\\u9EBB\\u70E6\\u7684\\u662F\\u9996\\u9875\\u7684\\u7FFB\\u9875\\u5217\\u8868\\uFF0C\\u7531\\u4E8E\\u8981\\u6C42\\u5728\\u4E0D\\u540C\\u5206\\u8FA8\\u7387\\u4E0B\\u6BCF\\u9875\\u663E\\u793A\\u65B9\\u6CD5\\u7684\\u6570\\u91CF\\u4E0D\\u540C\\uFF0C\\u4E00\\u5F00\\u59CB\\u662F\\u57FA\\u4E8E\",(0,e.jsx)(n.code,{children:\"grid\"}),\"\\u53BB\\u505A\\u7684\\uFF0C\\u540E\\u6765\\u53D1\\u73B0\",(0,e.jsx)(n.code,{children:\"grid\"}),\"\\u7684\\u517C\\u5BB9\\u6027\\u4E0D\\u592A\\u597D\\uFF0C\\u6D4B\\u8BD5\\u4E86\\u4E00\\u4E9B\\u6BD4\\u8F83\\u65E7\\u7684\\u6D4F\\u89C8\\u5668\\u4E0A\\u663E\\u793A\\u4E0D\\u592A\\u6B63\\u5E38\\uFF0C\\u5C31\\u6539\\u56DE\",(0,e.jsx)(n.code,{children:\"flex\"}),\"\\u6765\\u5B9E\\u73B0\\u4E86\\u3002\\u5355\\u7EAF\\u7528 CSS \\u53BB\\u5E03\\u5C40\\u7684\\u8BDD\\u6BD4\\u8F83\\u9EBB\\u70E6\\uFF0C\\u6700\\u540E\\u8FD8\\u662F\\u7528 JS \\u6765\\u641E\\u3002\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u4E3B\\u8981\\u7528\\u5230\\u7684\\u662F\",(0,e.jsx)(n.code,{children:\"window.matchMedia()\"}),\"\\u8FD9\\u4E2A API\\uFF0C\\u4F20\\u5165\\u4E00\\u4E2A media query \\u7684\\u5B57\\u7B26\\u4E32\\uFF0C\\u8FD4\\u56DE\\u4E00\\u4E2A\",(0,e.jsx)(n.code,{children:\"MediaQueryList\"}),\"\\u5BF9\\u8C61\\uFF0C\\u53EF\\u4EE5\\u7528\\u8FD9\\u4E2A\\u5BF9\\u8C61\\u6765\\u76D1\\u542C\\u9875\\u9762\\u7684\\u53D8\\u5316\\uFF0C\\u8BE6\\u7EC6\\u7528\\u6CD5\\u4ECB\\u7ECD\\u53EF\\u4EE5\\u770B \",(0,e.jsx)(n.a,{href:\"https://developer.mozilla.org/en-US/docs/Web/API/Window/matchMedia\",children:\"MDN\"}),\"\\u3002\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u8FD9\\u91CC\\u6709\\u4E00\\u4E2A\\u5751\\u5C31\\u662F\\uFF0C\\u5728\\u4E00\\u4E9B\\u8001\\u7684\\u6D4F\\u89C8\\u5668\\u91CC\\uFF0C\\u5305\\u62EC Safari 14 \\u53CA\\u4EE5\\u4E0B\\uFF0C\\u6DFB\\u52A0\\u76D1\\u542C\\u7684\\u65B9\\u6CD5\\u662F\",(0,e.jsx)(n.code,{children:\"addListener\"}),\"\\u800C\\u4E0D\\u662F\",(0,e.jsx)(n.code,{children:\"addEventListener\"}),\"\\uFF0C\\u8981\\u52A0\\u4E2A\\u5224\\u65AD\\u6765\\u5904\\u7406\\u4E00\\u4E0B\\u3002\\u76D1\\u542C\\u7684\\u4E3B\\u8981\\u4EE3\\u7801\\u5982\\u4E0B\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`const [index, setIndex] = useState(1);\n// Media Query\nconst [isNarrowScreen, setIsNarrorScreen] = useState(false);\nuseEffect(() =\u003e {\n  const mql = window.matchMedia(\"(max-width: 640px)\");\n  setIsNarrorScreen(mql.matches);\n  function updateIsNarrowScreen(e) {\n    setIsNarrorScreen(e.matches);\n  }\n  // Safari 14 \\u4EE5\\u524D\\uFF0C\\u7528\\u7684\\u662F addListener / removeListener\n  if (typeof mql.addEventListener === \"function\") {\n    mql.addEventListener(\"change\", updateIsNarrowScreen);\n  } else {\n    mql.addListener(updateIsNarrowScreen);\n  }\n  return () =\u003e {\n    if (typeof mql.removeEventListener === \"function\") {\n      mql.removeEventListener(\"change\", updateIsNarrowScreen);\n    } else {\n      mql.removeListener(updateIsNarrowScreen);\n    }\n  };\n}, []);\n// \\u5C4F\\u5E55\\u6539\\u53D8\\u65F6\\u91CD\\u7F6E\\u7B2C\\u4E00\\u9875\nuseEffect(() =\u003e setIndex(1), [isNarrowScreen]);\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u901A\\u8FC7\\u76D1\\u542C\",(0,e.jsx)(n.code,{children:\"MediaQueryList\"}),\"\\u5BF9\\u8C61\\u6765\\u5224\\u65AD\\u5C4F\\u5E55\\u7684\\u5BBD\\u7A84\\uFF0C\\u518D\\u6839\\u636E\",(0,e.jsx)(n.code,{children:\"isNarrowScreen\"}),\"\\u7684\\u503C\\u6765\\u6539\\u53D8\\u6BCF\\u9875\\u663E\\u793A\\u65B9\\u6CD5\\u7684\\u6570\\u91CF\\u3002\\u4EE5\\u4E0A\\u4EE3\\u7801\\u53EF\\u4EE5\\u5C01\\u88C5\\u6210\\u4E00\\u4E2A\",(0,e.jsx)(n.code,{children:\"useMedia\"}),\"\\u7684 hooks \\u6765\\u65B9\\u4FBF\\u590D\\u7528\\u3002\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u8FD8\\u6709\\u4E00\\u4E2A\\u8981\\u6CE8\\u610F\\u7684\\u5751\\u662F\\uFF0C\\u56E0\\u4E3A\",(0,e.jsx)(n.code,{children:\"next.js\"}),\"\\u662F\\u670D\\u52A1\\u7AEF\\u6E32\\u67D3\\u4E0E\\u5BA2\\u6237\\u7AEF\\u6E32\\u67D3\\u7ED3\\u5408\\u7684\\uFF0C\\u5982\\u679C\\u9700\\u8981\\u7528\\u5230\",(0,e.jsx)(n.code,{children:\"window\"}),\"\\u5BF9\\u8C61\\uFF0C\\u5219\\u9700\\u8981\\u5728\",(0,e.jsx)(n.code,{children:\"useEffect()\"}),\"\\u4E2D\\u4F7F\\u7528\\uFF0C\\u6B64\\u65F6\\u624D\\u662F\\u5904\\u4E8E\\u5BA2\\u6237\\u7AEF\\uFF08\\u6D4F\\u89C8\\u5668\\u73AF\\u5883\\uFF09\\u6E32\\u67D3\\u9636\\u6BB5\\uFF0C\\u4E0D\\u7136\\u4F1A\\u62A5\\u9519\\u3002\"]}),`\n`,(0,e.jsx)(n.h3,{children:\"\\u5B9A\\u65F6\\u5668 =\u003e useInterval\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u7528\\u6237\\u767B\\u5F55\\u65F6\\u5C55\\u793A\\u4E8C\\u7EF4\\u7801\\u7684\\u754C\\u9762\\u662F\\u4E00\\u4E2A\\u5F39\\u7A97\\u7EC4\\u4EF6\\uFF0C\\u7EC4\\u4EF6\\u663E\\u793A\\u65F6\\uFF0C\\u524D\\u7AEF\\u4F1A\\u53BB\\u8F6E\\u8BE2\",(0,e.jsx)(n.code,{children:\"/api/login\"}),\"\\u63A5\\u53E3\\uFF0C\\u56E0\\u6B64\\u9700\\u8981\\u4E00\\u4E2A\\u5B9A\\u65F6\\u5668\\u6765\\u5B9E\\u73B0\\u3002\\u5728 React \\u4E2D\\u4F7F\\u7528\\u5B9A\\u65F6\\u5668\\uFF0C\\u4F1A\\u6709\\u5404\\u79CD\\u5947\\u5947\\u602A\\u602A\\u7684\\u5751\\uFF0C\\u6D89\\u53CA\\u5230 hooks \\u7684\\u539F\\u7406\\u3001\\u95ED\\u5305\\u7B49\\u77E5\\u8BC6\\uFF0CDan \\u7684\\u6587\\u7AE0\\u5199\\u5F97\\u5F88\\u8BE6\\u7EC6\\u4E86\\uFF0C\\u8FD9\\u91CC\\u4E0D\\u518D\\u8D58\\u8FF0\\uFF0C\\u6709\\u5174\\u8DA3\\u7684\\u53EF\\u4EE5\\u770B\\u4E0B\",(0,e.jsx)(n.a,{href:\"https://overreacted.io/making-setinterval-declarative-with-react-hooks/\",children:\"\\u300AMaking setInterval Declarative with React Hooks\\u300B\"}),\"\\u3002\"]}),`\n`,(0,e.jsx)(n.h2,{children:\"\\u5176\\u5B83\"}),`\n`,(0,e.jsx)(n.h3,{children:\"Nginx \\u914D\\u7F6E\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u9879\\u76EE\\u6700\\u7EC8\\u662F\\u90E8\\u7F72\\u5728\\u963F\\u91CC\\u4E91\\u7684\\u670D\\u52A1\\u5668\\u4E0A\\uFF0C\\u540E\\u7AEF\\u7528\",(0,e.jsx)(n.code,{children:\"pm2\"}),\"\\u6765\\u8DD1\\uFF0C\\u524D\\u7AEF\\u5219\\u6253\\u5305\\u6210\\u9759\\u6001\\u6587\\u4EF6\\u3002\\u4E00\\u5F00\\u59CB\",(0,e.jsx)(n.code,{children:\"nginx\"}),\"\\u7684\\u914D\\u7F6E\\u662F\\u7EAF\\u624B\\u5199\\u7684\\uFF0C\\u540E\\u6765\\u53D1\\u73B0\\u4E86\\u8FD9\\u4E2A\",(0,e.jsx)(n.a,{href:\"https://www.digitalocean.com/community/tools/nginx\",children:\"\\u914D\\u7F6E\\u795E\\u5668\"}),\"\\uFF0C\\u7B80\\u76F4\\u4E0D\\u80FD\\u66F4\\u597D\\u7528\\u3002\"]}),`\n`,(0,e.jsx)(n.h3,{children:\"CDN\"}),`\n`,(0,e.jsx)(n.p,{children:\"\\u9879\\u76EE\\u4E0A\\u7EBF\\u540E\\u5076\\u6709\\u53CD\\u9988\\u8BBF\\u95EE\\u4E0D\\u4E86\\u7684\\u60C5\\u51B5\\uFF0C\\u6309\\u7406\\u8BF4\\u5E94\\u8BE5\\u4E0D\\u662F\\u9879\\u76EE\\u672C\\u8EAB\\u7684 bug \\u9020\\u6210\\u7684\\uFF0C\\u731C\\u6D4B\\u662F\\u7F51\\u7EDC\\u95EE\\u9898\\u3002\\u76EE\\u524D\\u8FD8\\u5728\\u89C2\\u5BDF\\uFF0C\\u5982\\u679C\\u6709\\u9700\\u8981\\u7684\\u8BDD\\u53EF\\u80FD\\u4F1A\\u4E0A CDN \\u6765\\u4F18\\u5316\\u53EF\\u8BBF\\u95EE\\u6027\\u548C\\u63D0\\u5347\\u8BBF\\u95EE\\u901F\\u5EA6\\u3002\"}),`\n`,(0,e.jsx)(n.h3,{children:\"CI/CD\"}),`\n`,(0,e.jsx)(n.p,{children:\"\\u73B0\\u5728\\u9879\\u76EE\\u53D1\\u5E03\\u90FD\\u8FD8\\u662F\\u7EAF\\u624B\\u52A8\\u6A21\\u5F0F\\uFF0C\\u6253\\u5305\\u4E0A\\u4F20\\u7136\\u540E\\u91CD\\u542F\\u670D\\u52A1\\u3002\\u63A5\\u4E0B\\u6765\\u4F1A\\u4F18\\u5316\\u6210\\u7528 GitHub Action \\u6765\\u505A\\u3002\"})]})}}var x=v;return y(I);})();\n;return Component;"},"__N_SSG":true},"page":"/post/[id]","query":{"id":"my-first-fullstack-project"},"buildId":"i85zbTreoVlPV-vsvfmmV","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>