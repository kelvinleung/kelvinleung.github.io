<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="description" content="Kelvin&#x27;s blog"/><link rel="icon" href="/images/favicon.ico"/><title>第一个全栈项目上线小结</title><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/da306c35ecdc5418.css" as="style"/><link rel="stylesheet" href="/_next/static/css/da306c35ecdc5418.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-81f4fb35f4507347.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7b4daab53c85f4a6.js" defer=""></script><script src="/_next/static/chunks/39-1e17aeb5671a7eb7.js" defer=""></script><script src="/_next/static/chunks/pages/post/my-first-fullstack-project-46ade41c36ba3123.js" defer=""></script><script src="/_next/static/c2GhiWY6kwghUvrBPufbI/_buildManifest.js" defer=""></script><script src="/_next/static/c2GhiWY6kwghUvrBPufbI/_ssgManifest.js" defer=""></script><script src="/_next/static/c2GhiWY6kwghUvrBPufbI/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="container"><nav class="navbar"><div class="navbar-content"><div class="navbar-menu-container"><ul class="navbar-menu"><li><a class="active" href="/">首页</a></li><li><a href="/posts/horse-sense">秘籍</a></li><li><a href="/posts/gibberish">八股</a></li><li><a href="/posts/xray">庖丁</a></li><li><a href="/posts/copycat">画瓢</a></li></ul></div></div></nav><main class="main"><main><article class="post-container"><div class="post-title-container"><h1 class="post-title">第一个全栈项目上线小结</h1><p class="post-date">DEC 22, 2021</p></div><p><img src="/images/my-first-fullstack-project/light-salt-index.png" alt="星之光盐"/></p><p>前前后后忙了差不多有一个月的时候，终于把我第一个独立完成的全栈项目（正式）上线了，可以戳这里看看哦：<a href="http://www.autismlightsalt.com">星之光盐</a>。过程中遇到了无数的坑，在此回顾小结一下。</p><p>项目背景是这样的，我老婆他们中心翻译了国外的一些资料，20 多个自闭症的干预方法，想要放到一个网站上去。刚好我也想找些项目练练手，就接了过来自己做。整个项目不复杂，就是几个静态的展示页，方便查阅这 20 多个方法，外加中心的介绍等。稍微麻烦一点的是方法页，需求是要关注服务号后才可以查看，不难，后面会有讲。</p><p>整个项目最初只有我一个“全干工程师”，没有原型，没有 UI，前后端一条龙，还得自己设计样式。后面找人介绍了个设计师，应该是我见过最水的一个 UI 了，出的设计稿各种不对齐，字号也不统一，切图也不会。最后我和甲方（我老婆）商量，只照着他给的样式做了个大概，很多细节我都自己调整了一遍，还得自己改图标切图，最后还被他吐槽“还原度不高”。如果真按设计稿来还原，那简直就是个灾难……</p><p>下面分为前后端两个部分来小结吧，毕竟是一个完整的全栈项目，先说后端部分：</p><h2>后端部分</h2><p>这次后端用的是<code>express</code>和<code>MySQL</code>，原始需求是：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>方法内容需要登录后才能查看</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>未关注服务号的用户扫码后关注服务号并登录</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>已关注服务号的用户扫码后登录</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>静默地为用户生成一个账号，无需设置密码</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>登录状态保持一周</div></li></ul><p>上述功能实现起来逻辑并不复杂，主要是和微信那边的交互第一次做，调试花了不少功夫。好在文档写得还行，基本上照着干问题不大。</p><p>扫码登录功能用到微信公众平台一个叫“带参数的二维码”的 API，文档对其描述为：</p><blockquote><p>为了满足用户渠道推广分析和用户帐号绑定等场景的需要，公众平台提供了生成带参数二维码的接口。使用该接口可以获得多个带不同场景值的二维码，用户扫描后，公众号可以接收到事件推送。</p></blockquote><p>根据微信公众平台的文档，用户扫描带场景值二维码时，可能推送以下两种事件：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>如果用户还未关注公众号，则用户可以关注公众号，关注后微信会将带场景值关注事件推送给开发者。</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>如果用户已经关注公众号，在用户扫描后会自动进入会话，微信也会将带场景值扫描事件推送给开发者。</div></li></ul><p>也就是说，我们可以调用微信公众平台这一接口来生成带参数（场景值）的二维码，这个参数是我们传过去的，用于唯一确定扫码的用户。用户扫码后，微信会把该事件推送到我们的服务号，并且是区分关注和未关注的（事件不同）。因此我们可以利用这个参数与事件的不同，来区分用户与用户的行为。</p><p><img src="/images/my-first-fullstack-project/sequence.png" alt="时序图"/></p><p>如图所示，整个流程是这样的：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>首先，用户点击登录按钮，这时前端会去请求服务器的<code>/api/get_qrcode</code>接口</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>服务端接到请求，生成唯一的 UUID，存在内存中</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>服务端用 UUID 去请求微信的<code>https://api.weixin.qq.com/cgi-bin/qrcode/create</code>接口，生成带参数的二维码</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>服务端拿到微信返回的二维码链接，连同对应的 UUID 一并返回给前端</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>前端拿到二维码链接，展示二维码给用户，同时开始轮询服务端的登录接口<code>/api/login</code></div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>用户扫描二维码，微信服务器接收到用户的扫码事件</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>微信将用户的扫码事件、OpenID 与场景值（UUID）发送给服务端处理</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>服务端接收到微信的事件，查询数据库中是否已经有 OpenID 对应的账号，没有则创建</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>查询/创建完账号后，服务端查询内存中是否有对应的 UUID，没有则返回错误码给前端</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>如果服务端查询到内存中有对应的 UUID，则把账号信息返回给还在轮询的前端</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>前端获取到用户信息后，处理登录状态</div></li></ul><h3>登录相关的接口</h3><p><code>/api/login</code>接口的逻辑非常简单，代码如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">const</span><span class="token plain"> express </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> router </span><span class="token operator">=</span><span class="token plain"> express</span><span class="token punctuation">.</span><span class="token method function property-access maybe-class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> authManager </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils/authManager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">router</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> uid </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> req</span><span class="token punctuation">.</span><span class="token property-access">query</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> auth </span><span class="token operator">=</span><span class="token plain"> authManager</span><span class="token punctuation">.</span><span class="token method function property-access">getAuth</span><span class="token punctuation">(</span><span class="token plain">uid</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">auth</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">    res</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">code</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">user</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token plain">auth </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 返回错误码给前端继续轮询</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>其中的<code>authManager</code>是一个单例，用来管理登录相关的逻辑，主要方法如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">MAX_LOAD</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// “扫码”队列，限制最大等待人数</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">AuthManager</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 用 Map 来模拟队列</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 获取单例</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">static</span><span class="token plain"> </span><span class="token function">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">instance</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">instance</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">AuthManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">instance</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 以 uid 为 key，保存用户信息在队列中，略</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">setAuth</span><span class="token punctuation">(</span><span class="token parameter">uid</span><span class="token parameter punctuation">,</span><span class="token parameter"> user</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 以 uid 为 key 获取用户信息，略</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">getAuth</span><span class="token punctuation">(</span><span class="token parameter">uid</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 判断队列是否已满，满则尝试清除过期的请求</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">size</span><span class="token plain"> </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token constant">MAX_LOAD</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">[</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter punctuation">[</span><span class="token parameter">key</span><span class="token parameter punctuation">,</span><span class="token parameter"> value</span><span class="token parameter punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> value</span><span class="token punctuation">.</span><span class="token property-access">createTime</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">60</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token method function property-access">delete</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">26</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">27</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">28</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">.</span><span class="token property-access">size</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token constant">MAX_LOAD</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">29</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">30</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>考虑到扫码与登录轮询间存在时间差，而登录信息即使丢失，也不会产生严重问题（最多造成前端轮询超时，可以重来），就把它直接存在内存中。这里用一个<code>Map</code>来模拟队列，且设置了最大容量，防止太多人同时扫码挤爆内存。<code>isAvailable()</code>方法用于判断队列是否已满，满则遍历清除过期的请求。<code>uid</code>则作为唯一的标识链接着用户、微信与业务逻辑三者。</p><p><code>/api/get_qrcode</code>接口的核心逻辑如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// 省略部分导入</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">v4</span><span class="token operator">:</span><span class="token plain"> uuidv4 </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;uuid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">TICKET_URL</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;https://api.weixin.qq.com/cgi-bin/qrcode/create&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name">QR_URL</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">ticket</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">ticket</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> tokenManager </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils/tokenManager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> authManager </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils/authManager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">QR_EXPIRE_TIME</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">604800</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">router</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">&quot;/get_qrcode&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">authManager</span><span class="token punctuation">.</span><span class="token method function property-access">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token comment">// 省略队列满时的错误处理</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> token </span><span class="token operator">=</span><span class="token plain"> tokenManager</span><span class="token punctuation">.</span><span class="token method function property-access">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> uid </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">uuidv4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">token</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">      </span><span class="token comment">// 省略 token 为空时的错误处理</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> response </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow">await</span><span class="token plain"> axios</span><span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">      </span><span class="token constant">TICKET_URL</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">        </span><span class="token literal-property property">expire_seconds</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">QR_EXPIRE_TIME</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">        </span><span class="token literal-property property">action_name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;QR_STR_SCENE&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain">        </span><span class="token literal-property property">action_info</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain">          </span><span class="token literal-property property">scene</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">26</span><div class="token-line-content"><span class="token plain">            </span><span class="token literal-property property">scene_str</span><span class="token operator">:</span><span class="token plain"> uid</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">27</span><div class="token-line-content"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">28</span><div class="token-line-content"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">29</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">30</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">params</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">access_token</span><span class="token operator">:</span><span class="token plain"> token </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">31</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">32</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 省略处理返回错误码的部分</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">33</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> ticket</span><span class="token punctuation">,</span><span class="token plain"> expire_seconds </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> response</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">34</span><div class="token-line-content"><span class="token plain">    res</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">35</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">code</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">36</span><div class="token-line-content"><span class="token plain">      uid</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">37</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">imgUrl</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">QR_URL</span><span class="token punctuation">(</span><span class="token plain">ticket</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">38</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">createTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">39</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">expireTime</span><span class="token operator">:</span><span class="token plain"> expire_seconds</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">40</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">41</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">42</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 省略错误处理的部分</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">43</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">44</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p><code>/api/get_qrcode</code>接口的核心逻辑就是生成 UUID，然后调用微信生成带参数二维码的接口，然后返回获取到的二维码链接，比较简单，详情可以查看<a href="https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Generating_a_Parametric_QR_Code.html">微信的文档</a>了解更多。其中的<code>tokenManager</code>是用来获取微信的<code>access_token</code>，调用公众号的接口时都要带上。<code>tokenManager</code>会定时刷新 token，用文件的形式保存在本地，具体逻辑比较简单在此略过，详情可以查看<a href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html">微信的文档</a>了解更多。</p><h3>处理微信消息的相关接口</h3><p>这次后端部分最核心的应该就是处理微信消息的接口了。接入微信公众平台后，原本在公众号后台配置的菜单和关键词等都失效了，要手工去操作实现。所有微信用户发的消息、扫码、关注、点击菜单等行为都会被转到该接口来处理。需要注意的是，这些消息需要在 5 秒内回复，微信会重试 3 次，如果不能马上处理完，可以直接回复空串。微信能接受的回复只有<code>&quot;success&quot;</code>与<code>&quot;&quot;</code>（字节长度为 0 的空字符串），当时我回复了<code>&quot;ok&quot;</code>，结果一直提示“该公众号暂时无法提供服务，请稍后再试”，debug 了好久才发现问题。</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">const</span><span class="token plain"> express </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> router </span><span class="token operator">=</span><span class="token plain"> express</span><span class="token punctuation">.</span><span class="token method function property-access maybe-class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">XMLJS</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;xml2js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> parser </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">XMLJS</span><span class="token class-name punctuation">.</span><span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">WechatHandler</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils/wechatHandler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">router</span><span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  req</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">    parser</span><span class="token punctuation">.</span><span class="token method function property-access">parseString</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token parameter punctuation">,</span><span class="token parameter"> result</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">        </span><span class="token comment">// 省略错误的处理</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> body </span><span class="token operator">=</span><span class="token plain"> result</span><span class="token punctuation">.</span><span class="token property-access">xml</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> handler </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">WechatHandler</span><span class="token punctuation">(</span><span class="token plain">body</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">      handler</span><span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> res</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token plain">message</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>由于微信发过来的消息是 XML 格式的，这里用了<code>xml2js</code>这个包来处理，XML 的各字段定义可以看微信的文档：<a href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_standard_messages.html">普通消息</a>，<a href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_event_pushes.html">事件推送</a>。解开 XML 后，将事件交给<code>WechatHandler</code>来统一处理，核心代码如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">DEFAULT_REPLY_MSG</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 默认的回复内容，空串</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 需要处理的事件</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">IMPLEMENTED_EVENTS</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&quot;subscribe&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;unsubscribe&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;SCAN&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;CLICK&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 策略对象，省略具体实现</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Handle</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> key</span><span class="token parameter punctuation">,</span><span class="token parameter"> openId</span><span class="token parameter punctuation">,</span><span class="token parameter"> devId </span><span class="token parameter punctuation">}</span><span class="token parameter punctuation">,</span><span class="token parameter"> reply</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> openId </span><span class="token parameter punctuation">}</span><span class="token parameter punctuation">,</span><span class="token parameter"> reply</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token constant">SCAN</span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> </span><span class="token parameter literal-property property">key</span><span class="token parameter operator">:</span><span class="token parameter"> uid</span><span class="token parameter punctuation">,</span><span class="token parameter"> openId </span><span class="token parameter punctuation">}</span><span class="token parameter punctuation">,</span><span class="token parameter"> reply</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token constant">CLICK</span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> key</span><span class="token parameter punctuation">,</span><span class="token parameter"> openId</span><span class="token parameter punctuation">,</span><span class="token parameter"> devId </span><span class="token parameter punctuation">}</span><span class="token parameter punctuation">,</span><span class="token parameter"> reply</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">WechatHandler</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">ToUserName</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">FromUserName</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">MsgType</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">Event</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">EventKey</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> body</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">MsgType</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">openId</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">FromUserName</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">devId</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ToUserName</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">event</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Event</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token maybe-class-name">Event</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">EventKey</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token maybe-class-name">EventKey</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">reply</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> config </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">openId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">openId</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">devId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">devId</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">26</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">27</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">28</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&quot;event&quot;</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">29</span><div class="token-line-content"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token constant">IMPLEMENTED_EVENTS</span><span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">event</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">30</span><div class="token-line-content"><span class="token plain">          </span><span class="token maybe-class-name">Handle</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">event</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">,</span><span class="token plain"> reply</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">31</span><div class="token-line-content"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">32</span><div class="token-line-content"><span class="token plain">          </span><span class="token function">reply</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_REPLY_MSG</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">33</span><div class="token-line-content"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">34</span><div class="token-line-content"><span class="token plain">        </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">35</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword module">default</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">36</span><div class="token-line-content"><span class="token plain">        </span><span class="token function">reply</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_REPLY_MSG</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">37</span><div class="token-line-content"><span class="token plain">        </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">38</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">39</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">40</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p><code>WechatHandler</code>的主要作用是从 XML 对象中解出各个字段，再根据事件的类型作不同的处理。这里还用到了策略模式，来处理不同的<code>&quot;event&quot;</code>类型事件。不同的事件定义可以查看<a href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_event_pushes.html">微信文档</a>，需要注意的是“扫码”这一操作，根据用户是否已关注公号，区分为<code>&quot;SCAN&quot;</code>与<code>&quot;subscribe&quot;</code>两个事件，逻辑的处理稍有不同。</p><p>以上就是后端部分的小结，下面来说说前端。</p><h2>前端部分</h2><p>前端这次还是用 React 来写，由于有 20 几篇静态的内容页，样式基本一致，所以决定继续用<code>next.js</code>加 MDX 来做。内容由 Word 文档转为 MDX，然后样式部分用<code>SASS</code>来写，但由于时间比较赶，所以写得很乱，开发过程中遇到过很多次 specificity 冲突导致样式覆盖或不生效的问题。这部分打算后面有时间了重构一下，不然以后要改很难维护。</p><h3>无限翻页</h3><p>这次首页有一个翻页组件的需求，用来展示所有方法的列表，支持无限翻页。由于是边学习边做的项目，所以这块没有直接用现成的轮子，而是自己实现了一个简单的翻页组件。</p><p>方法一共有 27 个，按 3 x 3 每页，一共需要 3 页。无限翻页的原理其实很简单，在前后各加上一个“伪页”。最左边是“伪 P3”，最右边是“伪 P1”。这样当从 P1 往左滑动的时候，就可以续上形成一个闭合的“环”了。而为了从这个“伪页”继续滑动，需要在滑动到两头的“伪页”时，切换回“伪页”所对应的“真页”上。这个切换的动作发生在滑动动画结束时，并且切换过程是一个没有动画的“瞬间移动”动作。页面的结构与切换如下图所示：</p><p><img src="/images/my-first-fullstack-project/carousel.png" alt="翻页结构"/></p><p>从“伪 P3”切换到“真 P3”的“瞬间移动”：</p><p><img src="/images/my-first-fullstack-project/carousel-switch.png" alt="翻页切换"/></p><p>我做了个动画来展示这一过程，当滑动到最左边一页的“伪 P3”时，“瞬间移动”到“真 P3”处，从而形成连续的“环”：</p><p><img src="/images/my-first-fullstack-project/carousel.gif" alt="翻页动画"/></p><p>下面是翻页组件<code>MethodList</code>的核心代码：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name">MethodList</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"> methods </span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">,</span><span class="token plain"> setIndex</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 当前页</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">/* ---- 省略部分 ---- */</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">reposition</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 处理“瞬间移动”的逻辑</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> itemCount </span><span class="token operator">=</span><span class="token plain"> isNarrowScreen </span><span class="token operator">?</span><span class="token plain"> </span><span class="token number">6</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">9</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 每页元素的数量</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> pageCount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">ceil</span><span class="token punctuation">(</span><span class="token plain">methods</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> itemCount</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 总页数（包括“伪页”）</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 左“伪页”</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> count </span><span class="token operator">=</span><span class="token plain"> methods</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">%</span><span class="token plain"> itemCount</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> methods</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token plain">count </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">itemCount </span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">count</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 右“伪页”</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">===</span><span class="token plain"> pageCount </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword control-flow">return</span><span class="token plain"> methods</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> itemCount</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// “真页”</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> methods</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> itemCount</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> itemCount </span><span class="token operator">+</span><span class="token plain"> itemCount</span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 简化了 JSX 的结构</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token plain">div</span></div></div><div class="token-line"><span class="line-number">26</span><div class="token-line-content"><span class="token plain">      className</span><span class="token operator">=</span><span class="token string">&quot;content&quot;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">27</span><div class="token-line-content"><span class="token plain">      style</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">28</span><div class="token-line-content"><span class="token plain">        </span><span class="token literal-property property">left</span><span class="token operator">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">-</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">index </span><span class="token template-string interpolation operator">*</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation number">100</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">%</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">29</span><div class="token-line-content"><span class="token plain">        </span><span class="token literal-property property">width</span><span class="token operator">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">pageCount </span><span class="token template-string interpolation operator">*</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation number">100</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">%</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">30</span><div class="token-line-content"><span class="token plain">        </span><span class="token literal-property property">transition</span><span class="token operator">:</span><span class="token plain"> transition </span><span class="token operator">?</span><span class="token plain"> </span><span class="token string">&quot;all 1s&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">31</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">32</span><div class="token-line-content"><span class="token plain">      onTransitionEnd</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">reposition</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">33</span><div class="token-line-content"><span class="token plain">    </span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">34</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token spread operator">...</span><span class="token known-class-name class-name">Array</span><span class="token punctuation">(</span><span class="token plain">pageCount</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">35</span><div class="token-line-content"><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">div key</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">i</span><span class="token punctuation">}</span><span class="token plain"> className</span><span class="token operator">=</span><span class="token string">&quot;page&quot;</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">36</span><div class="token-line-content"><span class="token plain">          </span><span class="token punctuation">{</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token plain">i</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">37</span><div class="token-line-content"><span class="token plain">            </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Card</span><span class="token plain"> key</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">method</span><span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">}</span><span class="token plain"> method</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">method</span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">38</span><div class="token-line-content"><span class="token plain">          </span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">39</span><div class="token-line-content"><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">40</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">41</span><div class="token-line-content"><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">42</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">43</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></code></pre><p><code>getMethods()</code>方法是方便获取每一页放置的方法列表，对于头尾两个“伪页”要做特殊处理。<code>reposition()</code>方法则是在<code>onTransitionEnd</code>事件触发时调用，判断当前如果是“伪页”，则触发“瞬间移动”的操作（更新<code>index</code>的值）。<code>pageCount</code>是每页元素的数量，会根据屏幕的宽窄来确定，实现响应式布局的需求，下面会有讲到<code>isNarrowScreen</code>的计算方法。页面间的切换用的是 CSS 的<code>left</code>属性，根据<code>index</code>来确定值。</p><p>这里有个小瑕疵还没完善，当快速点击切换页面，切换到尾端的“伪页”时，继续点击切换会没反应，因为<code>reposition</code>要等待动画完成<code>onTransitionEnd</code>时才会调用。这个小 bug 等有时间了再优化。</p><h3>响应式</h3><p><img src="/images/my-first-fullstack-project/light-salt-responsive.png" alt="响应式样式"/></p><p>项目要求 PC 端和手机端都可以浏览，由于都是比较简单的展示页，所以就直接做成响应式的了。用<code>@media</code>调一下布局的样式，基于<code>rem</code>去做还是比较简单的。麻烦的是首页的翻页列表，由于要求在不同分辨率下每页显示方法的数量不同，一开始是基于<code>grid</code>去做的，后来发现<code>grid</code>的兼容性不太好，测试了一些比较旧的浏览器上显示不太正常，就改回<code>flex</code>来实现了。单纯用 CSS 去布局的话比较麻烦，最后还是用 JS 来搞。</p><p>主要用到的是<code>window.matchMedia()</code>这个 API，传入一个 media query 的字符串，返回一个<code>MediaQueryList</code>对象，可以用这个对象来监听页面的变化，详细用法介绍可以看 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/matchMedia">MDN</a>。</p><p>这里有一个坑就是，在一些老的浏览器里，包括 Safari 14 及以下，添加监听的方法是<code>addListener</code>而不是<code>addEventListener</code>，要加个判断来处理一下。监听的主要代码如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">,</span><span class="token plain"> setIndex</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// Media Query</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">isNarrowScreen</span><span class="token punctuation">,</span><span class="token plain"> setIsNarrorScreen</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> mql </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">matchMedia</span><span class="token punctuation">(</span><span class="token string">&quot;(max-width: 640px)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">setIsNarrorScreen</span><span class="token punctuation">(</span><span class="token plain">mql</span><span class="token punctuation">.</span><span class="token property-access">matches</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateIsNarrowScreen</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">    </span><span class="token function">setIsNarrorScreen</span><span class="token punctuation">(</span><span class="token plain">e</span><span class="token punctuation">.</span><span class="token property-access">matches</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// Safari 14 以前，用的是 addListener / removeListener</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> mql</span><span class="token punctuation">.</span><span class="token property-access">addEventListener</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">    mql</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;change&quot;</span><span class="token punctuation">,</span><span class="token plain"> updateIsNarrowScreen</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">    mql</span><span class="token punctuation">.</span><span class="token method function property-access">addListener</span><span class="token punctuation">(</span><span class="token plain">updateIsNarrowScreen</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> mql</span><span class="token punctuation">.</span><span class="token property-access">removeEventListener</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">      mql</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;change&quot;</span><span class="token punctuation">,</span><span class="token plain"> updateIsNarrowScreen</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">      mql</span><span class="token punctuation">.</span><span class="token method function property-access">removeListener</span><span class="token punctuation">(</span><span class="token plain">updateIsNarrowScreen</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 屏幕改变时重置第一页</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain"></span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token function">setIndex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">isNarrowScreen</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>通过监听<code>MediaQueryList</code>对象来判断屏幕的宽窄，再根据<code>isNarrowScreen</code>的值来改变每页显示方法的数量。以上代码可以封装成一个<code>useMedia</code>的 hooks 来方便复用。</p><p>还有一个要注意的坑是，因为<code>next.js</code>是服务端渲染与客户端渲染结合的，如果需要用到<code>window</code>对象，则需要在<code>useEffect()</code>中使用，此时才是处于客户端（浏览器环境）渲染阶段，不然会报错。</p><h3>定时器 =&gt; useInterval</h3><p>用户登录时展示二维码的界面是一个弹窗组件，组件显示时，前端会去轮询<code>/api/login</code>接口，因此需要一个定时器来实现。在 React 中使用定时器，会有各种奇奇怪怪的坑，涉及到 hooks 的原理、闭包等知识，Dan 的文章写得很详细了，这里不再赘述，有兴趣的可以看下<a href="https://overreacted.io/making-setinterval-declarative-with-react-hooks/">《Making setInterval Declarative with React Hooks》</a>。</p><h2>其它</h2><h3>Nginx 配置</h3><p>项目最终是部署在阿里云的服务器上，后端用<code>pm2</code>来跑，前端则打包成静态文件。一开始<code>nginx</code>的配置是纯手写的，后来发现了这个<a href="https://www.digitalocean.com/community/tools/nginx">配置神器</a>，简直不能更好用。</p><h3>CDN</h3><p>项目上线后偶有反馈访问不了的情况，按理说应该不是项目本身的 bug 造成的，猜测是网络问题。目前还在观察，如果有需要的话可能会上 CDN 来优化可访问性和提升访问速度。</p><h3>CI/CD</h3><p>现在项目发布都还是纯手动模式，打包上传然后重启服务。接下来会优化成用 GitHub Action 来做。</p></article></main></main><footer><div>Build with ♥ @GZ</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/post/my-first-fullstack-project","query":{},"buildId":"c2GhiWY6kwghUvrBPufbI","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>