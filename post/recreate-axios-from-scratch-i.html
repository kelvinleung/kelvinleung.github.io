<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="description" content="Kelvin&#x27;s blog"/><link rel="icon" href="/images/favicon.ico"/><title>Axios 源码阅读笔记之——徒手撕 Ajax（一）</title><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/23ea442201073304.css" as="style"/><link rel="stylesheet" href="/_next/static/css/23ea442201073304.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-deb592798b94b511.js" defer=""></script><script src="/_next/static/chunks/pages/_app-03bf36492cf6e88d.js" defer=""></script><script src="/_next/static/chunks/39-d1f565ce8c04aa94.js" defer=""></script><script src="/_next/static/chunks/pages/post/recreate-axios-from-scratch-i-d2a98459f5fb9b25.js" defer=""></script><script src="/_next/static/sVtXAP7PPm_wvq3uopyQ-/_buildManifest.js" defer=""></script><script src="/_next/static/sVtXAP7PPm_wvq3uopyQ-/_ssgManifest.js" defer=""></script><script src="/_next/static/sVtXAP7PPm_wvq3uopyQ-/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="container"><nav class="navbar"><div class="navbar-content"><ul><li><a href="/">首页</a></li><li><a class="active" href="/posts">秘笈</a></li><li><a href="/">八股</a></li><li><a href="/">奇术</a></li><li><a href="/">轮子</a></li><li><a href="/">鄙人</a></li></ul></div></nav><main class="main"><main><article class="post-container"><div class="post-title-container"><h1 class="post-title">Axios 源码阅读笔记之——徒手撕 Ajax（一）</h1><p class="post-date">DEC 30, 2021</p></div><p>花了两三天的时间，把 Axios 的源码过了一遍。不得不说，Axios 的源码确实很适合小白，逻辑不复杂，也能看到很多巧妙的地方。看一遍，然后自己把核心的逻辑实现一遍，确实能学到很多东西，在此记录一下。</p><p>说到 Axios，不得不说 Ajax，实际上 Axios 就是一个封装 Ajax 请求的库。而 Ajax 则是 Asynchronous JavaScript and XML 的缩写。这一术语最早出现在 2005 年 Jesse James Garrett 的<a href="https://web.archive.org/web/20080702075113/http://www.adaptivepath.com/ideas/essays/archives/000385.php">一篇文章</a>中。</p><p>要知道，在盘古初开的时候，使用 JS 去动态请求数据，一般只能用<code>&lt;form&gt;</code>的<code>action</code>来向指定 URL 发起请求，并且这会导致整个页面刷新，体验非常的差。后来微软为了优化 Web 版的 Outlook 体验，在 IE 中增加了<code>XMLHttpRequest</code>，令到 JS 能够异步请求数据。其它浏览器厂家纷纷跟进，分别实现了自己版本的<code>XMLHttpRequest</code>功能，随后更是被纳入了 W3C 规范中。当然，将这项技术发扬光大的是我们熟知的 Gmail 与 Google Maps，并由此打开了 Web 2.0 时代的大门。</p><p>以上这段历史感兴趣的可以看下<a href="https://thehistoryoftheweb.com/what-does-ajax-even-stand-for/">这篇文章</a>。</p><p>值得注意的是，Ajax 这一术语，并不是单单指某一项技术，而是一组技术的组合运用，MDN 中对它的定义描述为：</p><blockquote><p>Asynchronous JavaScript and XML, while not a technology in itself, is a term coined in 2005 by Jesse James Garrett, that describes a &quot;new&quot; approach to using a number of existing technologies together, including HTML or XHTML, CSS, JavaScript, DOM, XML, XSLT, and most importantly the XMLHttpRequest object. When these technologies are combined in the Ajax model, web applications are able to make quick, incremental updates to the user interface without reloading the entire browser page. This makes the application faster and more responsive to user actions.</p></blockquote><p>而在狭义的语境中，Ajax 一般指的就是“发起异步请求”。使用 JS 发起一个 Ajax 请求很简单，只是有点繁琐，代码如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">const</span><span class="token plain"> xhr </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 初始化请求</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">xhr</span><span class="token punctuation">.</span><span class="token method function property-access">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;https://www.xxx.com/api&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 设置请求头</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">xhr</span><span class="token punctuation">.</span><span class="token method function property-access">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-Requested-With&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;XMLHttpRequest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 监听请求状态</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">xhr</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onreadystatechange</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">xhr</span><span class="token punctuation">.</span><span class="token property-access">readyState</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token number">4</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">xhr</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token number">200</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> xhr</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">300</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">xhr</span><span class="token punctuation">.</span><span class="token property-access">responseText</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 发送请求</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">xhr</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>每次请求都需要如此繁琐的配置，实在没有必要。接下来我们从零开始，封装一个简单易用的 Ajax 请求库，实现简化版的 Axios。</p><h2>面向调用设计</h2><p>之前做产品的时候，当我们需要去设计一个功能时，总是会提到“以用户为中心”，“面向用户”这些术语。因为产品最终是要交付给用户使用，才会产生价值。因此要面向用户的使用场景、需求去设计。而编写一个库，同样需要面向“用户”设计，这个用户，指的是这个库的调用者。因此当我们设计 API 时，要考虑的是调用方是如何调用的。</p><p>那么作为调用者，我们希望如果调用这个简化版的 Axios 呢。当然是越简单越好，最好是能不设置的就不用设置，直接就可以发起请求。同时，能提供多种调用方式，以满足不同调用者的使用习惯。Axios 的调用方法就非常多样，例如：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// 默认情况下直接发起 GET 请求</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token function">axios</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.xxx.com/api&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 使用 get 方法发起请求</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.xxx.com/api&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 指定参数</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  method</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  url</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;https://www.xxx.com/api&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 附加指定参数</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain"></span><span class="token function">axios</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.xxx.com/api&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> method</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;get&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 还可以通过实例去调用</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> instance </span><span class="token operator">=</span><span class="token plain"> axios</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">  baseURL</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;https://www.xxx.com/api&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">  timeout</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">  headers</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;X-Custom-Header&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;foobar&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 实例方法</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain">instance</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">&quot;login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>小结一下就是：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>作为函数直接调用</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>作为对象方法调用</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>可以创建实例，通过实例方法调用</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>使用 Promise 链式调用</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>方法的参数有多种形式</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>提供缺省的默认参数</div></li></ul><h2>函数与对象</h2><p>Axios 既可以作为函数直接调用，也可以作为一个对象，通过它的方法来调用，甚至还可以调用该对象的<code>create()</code>方法，创建出实例，然后通过实例的方法来调用。那么它是怎样做到的呢？</p><p>我们知道，在 JS 中，“万物皆对象”，所以即使是函数，它实际上也是一个<code>Function</code>对象。因此<code>axios</code>的本体，是一个函数（对象），这个对象（函数）还拥有像<code>get()</code>、<code>create()</code>等方法，原理如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// axios 作为一个函数</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">axios</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;as a function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// axios 作为一个对象</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">get</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;as a method of an object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain"></span><span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// &quot;as a function&quot;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// &quot;as a method of an object&quot;</span></div></div></code></pre><p>由于<code>get()</code>方法实际上是<code>request({ method: &quot;get&quot; })</code>，因此可以用面向对象的方式来实现。简化后的代码如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Axios</span><span class="token punctuation">(</span><span class="token parameter">instanceConfig</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 默认的配置</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> instanceConfig</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 拦截器，后面有讲，先简化省略</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">interceptors</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">request</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">configOrUrl</span><span class="token parameter punctuation">,</span><span class="token parameter"> config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">/**</span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token comment">   * 对 config 进行处理，后面有讲</span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token comment">   */</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 将请求派发给对应的适配器，后面会有讲到</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">dispatchRequest</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">[</span><span class="token string">&quot;delete&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;get&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">forEachMethodWithoutData</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">  </span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">[</span><span class="token plain">method</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token parameter punctuation">,</span><span class="token parameter"> config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">request</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">      </span><span class="token function">mergeConfig</span><span class="token punctuation">(</span><span class="token plain">config </span><span class="token operator">||</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> method</span><span class="token punctuation">,</span><span class="token plain"> url</span><span class="token punctuation">,</span><span class="token plain"> data</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">config </span><span class="token operator">||</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">[</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;put&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">forEachMethodWithData</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain">  </span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">[</span><span class="token plain">method</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token parameter punctuation">,</span><span class="token parameter"> data</span><span class="token parameter punctuation">,</span><span class="token parameter"> config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">26</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">request</span><span class="token punctuation">(</span><span class="token function">mergeConfig</span><span class="token punctuation">(</span><span class="token plain">config </span><span class="token operator">||</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> method</span><span class="token punctuation">,</span><span class="token plain"> url</span><span class="token punctuation">,</span><span class="token plain"> data </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">27</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">28</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>请求函数<code>request()</code>挂载在<code>Axios</code>的原型上，函数内部调用了<code>dispatchRequest()</code>函数，作用是将请求派发给对应的适配器，后面会有讲到。<code>Axios</code>的原型上还挂载有<code>delete()</code>、<code>get()</code>、<code>post()</code>、<code>put()</code>等常用的 HTTP 请求方法，它们被分成两组，区别是请求时是否带有<code>data</code>。</p><p>通过<code>Axios</code>构造函数，我们可以生成<code>axios</code>对象（函数）：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token parameter">defaultConfig</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> context </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Axios</span><span class="token punctuation">(</span><span class="token plain">defaultConfig</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// instance 即 request</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> instance </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method function property-access">request</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token plain">context</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 将 Axios 原型上的方法加到 instance 上</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  utils</span><span class="token punctuation">.</span><span class="token method function property-access">extend</span><span class="token punctuation">(</span><span class="token plain">instance</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">,</span><span class="token plain"> context</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 将 Axios 实例上的属性加到 instance 上</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  utils</span><span class="token punctuation">.</span><span class="token method function property-access">extend</span><span class="token punctuation">(</span><span class="token plain">instance</span><span class="token punctuation">,</span><span class="token plain"> context</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// instance 即为函数，又为对象</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> instance</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 默认的参数 defaults</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> axios </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token plain">defaults</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">create</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">instanceConfig</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// mergeConfig 方法用于合并配置，后面有讲</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token function">mergeConfig</span><span class="token punctuation">(</span><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token punctuation">,</span><span class="token plain"> instanceConfig</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></code></pre><p>工具方法<code>extend(a, b)</code>的作用是将<code>b</code>对象自有的属性与方法，拷贝给<code>a</code>对象，简化版的实现如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token parameter punctuation">,</span><span class="token parameter"> b</span><span class="token parameter punctuation">,</span><span class="token parameter"> thisArg</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">const</span><span class="token plain"> key </span><span class="token keyword">in</span><span class="token plain"> b</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">b</span><span class="token punctuation">.</span><span class="token method function property-access">hasOwnProperty</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">thisArg </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token keyword">typeof</span><span class="token plain"> b</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">        a</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> b</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token plain">thisArg</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">        a</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> b</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> a</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>实际上<code>axios</code>的本体（<code>instance</code>）就是<code>Axios.prototype.request()</code>函数（对象）。它通过<code>extend()</code>方法获得了<code>Axios</code>原型上的所有方法及 Axios 实例<code>context</code>上的所有属性（即<code>defaults</code>与<code>interceptors</code>等属性）。它自身还增加了<code>create()</code>方法，该方法通过调用<code>createInstance()</code>方法，利用传入的配置参数，生成了新的<code>axios</code>对象。</p><p>因此，我们最终使用的<code>axios</code>，既是一个函数，同时也是一个带有各种别名方法的对象。<code>Axios</code>、<code>axios</code>的关系如下图：</p><p><img src="/images/recreate-axios-from-scratch/relation.png" alt="relation"/></p><h2>默认参数</h2><p>人都是懒的，为了能达到“能不配置就不配置”的目的，我们需要提供默认的参数配置项。初始化<code>axios</code>对象时传入的<code>defaults</code>对象中就包含了所有参数的默认值，如超时时间、请求头等。</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">const</span><span class="token plain"> defaults </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">/*</span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token comment">   * 省略</span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token comment">   */</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  timeout</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  headers</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">    common</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">      </span><span class="token maybe-class-name">Accept</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;application/json, text/plain, */*&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 初始化时传入默认参数</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> axios </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token plain">defaults</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>我们在发起请求时，如果不指定方法类型，默认是“GET”方法，同时，请求的参数，既可以是<code>url</code>，也可以是<code>config</code>对象，这些逻辑的处理都是在<code>Axios.prototype.request()</code>方法中实现的：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token class-name">Axios</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">request</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">configOrUrl</span><span class="token parameter punctuation">,</span><span class="token parameter"> config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 第一个参数为 string 时（url）</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> configOrUrl </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">    config </span><span class="token operator">=</span><span class="token plain"> config </span><span class="token operator">||</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">    config</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> configOrUrl</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">    config </span><span class="token operator">=</span><span class="token plain"> configOrUrl </span><span class="token operator">||</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 必须要有 url，否则报错</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">config</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Url not valid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 设置 method 的默认值</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">.</span><span class="token property-access">method</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">    config</span><span class="token punctuation">.</span><span class="token property-access">method</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> config</span><span class="token punctuation">.</span><span class="token property-access">method</span><span class="token punctuation">.</span><span class="token method function property-access">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token punctuation">.</span><span class="token property-access">method</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">    config</span><span class="token punctuation">.</span><span class="token property-access">method</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token punctuation">.</span><span class="token property-access">method</span><span class="token punctuation">.</span><span class="token method function property-access">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">    config</span><span class="token punctuation">.</span><span class="token property-access">method</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;get&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 合并配置</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain">  config </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">mergeConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token punctuation">,</span><span class="token plain"> config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">23</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 将请求派发给对应的适配器，后面会有讲到</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">24</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">dispatchRequest</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">25</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></code></pre><p>其中<code>mergeConfig(a, b)</code>方法用于合并配置，<code>b</code>中与<code>a</code>相同的配置项，会直接覆盖（<code>b</code>优先于<code>a</code>），方法的简化版实现如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">mergeConfig</span><span class="token punctuation">(</span><span class="token parameter">config1</span><span class="token parameter punctuation">,</span><span class="token parameter"> config2</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token plain">config1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token plain">config2 </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p><code>mergeConfig()</code>方法在很多地方有使用到，因此这些配置间会相互覆盖，它们间的优先级如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">/* 最低：不设置时，默认 timeout 为 0</span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token comment"> * defaults = { timeout: 0 }</span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token comment"> */</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 低</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token punctuation">.</span><span class="token property-access">timeout</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 中</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> instance </span><span class="token operator">=</span><span class="token plain"> axios</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> timeout</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2000</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 高</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">instance</span><span class="token punctuation">.</span><span class="token property-access">defaults</span><span class="token punctuation">.</span><span class="token property-access">timeout</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">3000</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 最高</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">instance</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.xxx.com/api&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> timeout</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">5000</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><h2>适配器</h2><p>Axios 既可以在浏览器环境中使用，也可以在 Node 中使用，原因是使用了适配器，当我们通过<code>dispatchRequest()</code>方法派发请求时，会先根据不同的环境，加载不同的请求方法。其中浏览器端使用的是<code>XMLHttpRequest</code>，而在 Node 中则使用的是<code>http</code>模块。</p><p>在这里，我们先不考虑 Node 环境。但考虑到练手的需要，适配器的部分还是实现了，但直接忽略掉环境判断的部分，默认使用<code>XMLHttpRequest</code>适配器，简化后的代码如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">dispatchRequest</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> adapter </span><span class="token operator">=</span><span class="token plain"> config</span><span class="token punctuation">.</span><span class="token property-access">adapter</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> defaults</span><span class="token punctuation">.</span><span class="token property-access">adapter</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">adapter</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> response</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">reject</span><span class="token punctuation">(</span><span class="token plain">reason</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>可以看到，请求从<code>request()</code>到<code>dispatchRequest()</code>，最终是由<code>adapter()</code>来发起。之所以这么绕，原因一个是为了使用拦截器，这个后面再讲；另一个则是适配不同的环境。</p><p>这里再补充一点，对于环境的判断，Axios 中是利用了 Node 中的<code>process</code>，代码可以在源码中的<code>lib/defaults.js</code>文件中找到：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">getDefaultAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> adapter</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> </span><span class="token maybe-class-name">XMLHttpRequest</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// For browsers use XHR adapter</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">    adapter </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./adapters/xhr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">typeof</span><span class="token plain"> process </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&quot;undefined&quot;</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">    </span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">process</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;[object process]&quot;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// For node use HTTP adapter</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">    adapter </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./adapters/http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> adapter</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><h2>Promisify</h2><p>上面提到，最终发起请求的，是适配器，对于浏览器环境，就是<code>xhrAdapter()</code>，其实就是使用<code>XMLHttpRequest</code>来发起请求（绕了这么久，终于绕回来了）。</p><p>原生的<code>XMLHttpRequest</code>使用回调函数来监听各种事件，容易造成回调地狱，也不利于链式调用。我们需要将其转化为更现代、更“科学”的 Promise，这个过程，叫做 Promise 化（Promisify）。Promisify 是常见的面试题，原理很简单，当成功时<code>resolve()</code>，当失败/出错时<code>reject()</code>。我们把上面原生的 xhr 请求 Promise 化，代码如下：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">xhrAdapter</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation">,</span><span class="token parameter"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> request </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">    request</span><span class="token punctuation">.</span><span class="token method function property-access">open</span><span class="token punctuation">(</span><span class="token plain">config</span><span class="token punctuation">.</span><span class="token property-access">method</span><span class="token punctuation">.</span><span class="token method function property-access">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> config</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">    request</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onreadystatechange</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">request</span><span class="token punctuation">.</span><span class="token property-access">readyState</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token number">4</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">request</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token number">200</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> request</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">300</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">        </span><span class="token comment">// 当返回码为 2xx 时即成功</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">        </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token plain">request</span><span class="token punctuation">.</span><span class="token property-access">response</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">        </span><span class="token comment">// 否则为失败</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">        </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">request</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">    request</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>到此为止，我们就完成了<code>XMLHttpRequest</code>的简单封装，实现了一个简化版的 Axios。完整代码可以在<a href="https://github.com/kelvinleung/re-create.js/tree/main/axios">这里查看</a>。</p></article></main></main><footer><div>Build with ♥ @GZ</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/post/recreate-axios-from-scratch-i","query":{},"buildId":"sVtXAP7PPm_wvq3uopyQ-","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>