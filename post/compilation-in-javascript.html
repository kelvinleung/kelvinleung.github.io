<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="description" content="Kelvin&#x27;s blog"/><link rel="icon" href="/images/favicon.ico"/><title>JavaScript 的“编译”过程都做了什么？</title><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/f7b5dcb73c615fd1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f7b5dcb73c615fd1.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-81f4fb35f4507347.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7d075d2556e27131.js" defer=""></script><script src="/_next/static/chunks/39-1e17aeb5671a7eb7.js" defer=""></script><script src="/_next/static/chunks/pages/post/compilation-in-javascript-304086fb8ed4c34f.js" defer=""></script><script src="/_next/static/H-unq2TEKWOe_LghEWEKT/_buildManifest.js" defer=""></script><script src="/_next/static/H-unq2TEKWOe_LghEWEKT/_ssgManifest.js" defer=""></script><script src="/_next/static/H-unq2TEKWOe_LghEWEKT/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="container"><nav class="navbar"><div class="navbar-content"><div class="navbar-menu-container"><ul class="navbar-menu"><li><a href="/">首页</a></li><li><a href="/posts/horse-sense">秘籍</a></li><li><a href="/posts/gibberish">八股</a></li><li><a href="/posts/xray">庖丁</a></li><li><a href="/posts/copycat">画瓢</a></li></ul></div></div></nav><main class="main"><main><article class="post-container"><div class="post-title-container"><h1 class="post-title">JavaScript 的“编译”过程都做了什么？</h1><p class="post-date">OCT 29, 2021</p></div><p>一切要从网上看到的一道面试题说起：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// 请写出下面代码的输出结果：</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token parameter punctuation">,</span><span class="token parameter"> c</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// f a() {}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">123</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 123</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">c</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// f c() {}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> d </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">678</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">d</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// undefined</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">b</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// undefined</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> </span><span class="token function-variable function">b</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">b</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// f () {}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">c</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// f c() {}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain"></span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>当时我瞄了一眼，这不很简单么，啪一下就做完了。回头一看答案，第一个<code>console.log(a)</code>居然不是<code>1</code>，什么情况？经过一番研究，查了无数资料，我终于搞明白了。原来 JS 居然也有“编译”过程，一些奇奇怪怪的事情都发生在这个阶段中。</p><p>可是，JS 明明是一门<strong>解析型语言</strong>，哪来的编译？</p><p>其实，这里所谓的“编译”，并不是“编译型语言”的那个编译，而是指在 JS 代码执行之前，JS 引擎所进行的一系列动作，像词法分析、变量初始化等。由于它们发生在代码真正“执行”之前，所以大家习惯称之为“编译”或“预编译”。了解 JS “预编译”的过程，对于理解 JS 的底层执行机制，如变量提升、<code>this</code>、闭包等，都会有很大的帮助。</p><h2>执行上下文（Execution Context，下面简称 EC）</h2><blockquote><p>An execution context is a specification device that is used to track the runtime evaluation of code by an ECMAScript implementation.</p></blockquote><p>所谓的 EC，指的是 JS 解析运行的环境，是一个抽象的概念。所有 JS 的代码，都是在 EC 中运行的。EC 有三种类型：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div><strong>全局执行上下文（Global Execution Context）</strong>：默认的 EC，所有不是写在函数里的代码，都运行在 GEC 中。GEC 会创建一个全局对象<code>window</code>（浏览器环境），并将 <code>this</code> 指向 <code>window</code>。所有 JS 程序有且只有唯一的一个 GEC。</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div><strong>函数执行上下文（Function Execution Context）</strong>：每一次函数被调用时，都会为这个函数创建一个全新的 EC。每个函数都有自己的 EC，当且仅当在被调用时才会创建，而每个程序可以有无数个函数执行上下文。</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div><strong>Eval 函数执行上下文（Eval Function Execution Context）</strong>：每段在<code>eval</code>中执行的代码，都会有它对应的执行上下文。由于<code>eval</code>尽量还是少用，可以暂时忽略它。</div></li></ul><p>每个 EC 都会有一系列的属性（或者叫状态）来记录与之关联的代码的执行进度，下面是 EC 的结构：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token maybe-class-name">ExecutionContext</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token maybe-class-name">VariableObject</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token maybe-class-name">ScopeChain</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  thisValue</span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>除了上面三个属性以外，在不同的实现里还会有其它额外的状态。在详细说明上述三个属性前，我们先来了解一下什么是执行栈。</p><h2>执行栈/调用栈（Execution Stack，下面简称 ES）</h2><p>执行上下文的创建、搁置、恢复、结束等，是通过执行栈来管理的。执行栈（有些语言也叫“调用栈”，Calling Stack）顾名思义，是一个后进先出的“栈”，用于存放所有 JS 代码执行过种中产生的执行上下文。JS 引擎在开始执行代码之前，首先会创建一个 GEC，然后把它压入执行栈中。当代码执行到有函数调用的时候，又会为该函数创建 EC 并压进 ES。之前的 EC 则会保存当前的执行状态，进入到搁置状态中。JS 引擎接着执行刚压进栈顶的 EC 所对应的函数，当该函数执行完毕后，它的 EC 从 ES 中弹出，然后将之前搁置的 EC 恢复，继续执行其对应的函数，直至所有代码执行完毕。执行完毕后，最底层的 GEC 最后弹出，整个程序执行完毕。以下面的代码为例：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// 1. 先创建一个 GEC，入栈</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;Inside first function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 3. 调用 second() 时创建一个 FEC，入栈，second-EC</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token comment">// 4. 执行 second() 结束，弹出 second-EC</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;Again inside first function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;Inside second function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain"></span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 2. 调用 first() 时创建一个 FEC，入栈，first-EC</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 5. 执行 first() 结束，弹出 first-EC</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;Inside Global Execution Context&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// 6. 代码执行完毕，弹出 GEC</span></div></div></code></pre><p>程序的执行过程为：</p><ol><li><span class="marker">1.</span><div>创建一个全局执行上下文，压入执行栈</div></li><li><span class="marker">2.</span><div>执行全局代码，到第 12 行，调用 first() 函数，为其创建函数执行上下文，first-FEC，压入执行栈</div></li><li><span class="marker">3.</span><div>执行 first() 中的代码，到第 5 行，调用 second() 函数，为其创建函数执行上下文，second-FEC，压入执行栈</div></li><li><span class="marker">4.</span><div>执行 second() 中的代码，结束后弹出 second-FEC</div></li><li><span class="marker">5.</span><div>继续执行 first() 中的代码，结束后弹出 first-FEC</div></li><li><span class="marker">6.</span><div>继续执行全局代码，结束后弹出 GEC，整个程序结束运行</div></li></ol><p>为了更直观地展示整个过程，我做了下面的动图：</p><p><img src="/images/compilation-in-javascript/excecution-stack.gif" alt="执行栈"/></p><h2>VO（Variable Object，变量对象）</h2><p>“预编译”阶段，一个很重要的任务是初始化变量。我们定义的变量，声明的函数，函数的形参等用于执行代码的数据，都存放在与对应执行上下文关联的一个叫变量对象（VO）的机制中。VO 中存储着在上下文中声明的以下内容：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>变量（<code>var</code>，VariableDeclaration）</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>函数声明（FunctionDeclaration)</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>函数的形参</div></li></ul><p>可以表示为以下的形式：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// 活跃的执行上下文</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">activeExecutionContext </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token constant">VO</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">    </span><span class="token comment">// 上下文数据（变量，函数声明，函数形参）</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></code></pre><p>当我们定义变量或声明函数时，相当于给 VO 创建新的属性，比如下面的代码：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">var</span><span class="token plain"> a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> b </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">20</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain"></span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>相对应的 VO 可以表示为：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token comment">// 全局上下文的 VO</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token constant">VO</span><span class="token punctuation">(</span><span class="token plain">globalContext</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">a</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">test</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">reference to </span><span class="token keyword">function</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token comment">// 指向函数</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token comment">// test() 函数上下文的 VO</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token constant">VO</span><span class="token punctuation">(</span><span class="token plain">test functionContext</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">x</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">30</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">b</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">20</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></code></pre><p>VO 可以看作是一个抽象的概念，它在不同的执行上下文中，有着不同的命名与初始结构。</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>在全局执行上下文中，VO 即全局对象<code>window</code>（浏览器环境），又被称为 GO（Global Object）；它在初始化的时候，定义了像<code>Math</code>、<code>String</code>、<code>Date</code>等属性</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>在函数执行上下文中，它还附加<code>arguments</code>、形参等额外的细节，又被称为 AO（Activation Object）</div></li></ul><p>了解了 VO 的概念后，就可以正式进入主题了。在旧规范中，执行上下文的创建分为两个基本阶段：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>进入执行上下文</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>执行代码</div></li></ul><h3>阶段一：进入执行上下文</h3><p>在进入执行上下文时，VO 会添加以下属性：</p><ol><li><span class="marker">1.</span><div>对于每一个形参（假设是在函数执行上下文中，此时的 VO 称为 AO），会增加一个名称和值与该形参对应的属性；如果是未传值的形参，则值为<code>undefined</code></div></li><li><span class="marker">2.</span><div>对于每个函数声明，会增加一个名称与函数名一样的属性，值为该函数对象；如果 VO 已经有同名属性，则覆盖之</div></li><li><span class="marker">3.</span><div>对于每个变量声明，会增加一个名称与该变量一样的属性，值为<code>undefined</code>；如果 VO 已经有同名属性，则保留原有的属性，忽略当前变量声明</div></li></ol><p>下面用一个例子来展示上述过程：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token parameter punctuation">,</span><span class="token parameter"> b</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> c </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> </span><span class="token function-variable function">e</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">_e</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 调用函数</span></div></div></code></pre><p>在调用函数 test() 时，传进去了参数<code>10</code>，此时在进入执行上下文阶段中，AO 可以表示为：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token constant">AO</span><span class="token punctuation">(</span><span class="token plain">test</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">a</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">b</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">c</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">d</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">reference to </span><span class="token maybe-class-name">FunctionDeclaration</span><span class="token plain"> </span><span class="token string">&quot;d&quot;</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token comment">// 指向函数 d</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">e</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></code></pre><p>有两个个地方要注意一下：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>首先，<code>d</code>的值是一个函数，因为它是一个函数声明，而<code>e</code>的值是<code>undefined</code>，因为它是一个函数表达式，<code>e</code>是一个变量</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div><code>x</code>并没有在 AO 里，因为它也是一个表达式，但并没有赋值给任何变量，不存在变量的声明</div></li></ul><h3>阶段二：执行代码</h3><p>接着上面的例子，当进入执行代码阶段的时候，<code>test()</code>函数中的代码开始执行，AO 中的属性被赋值：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token constant">AO</span><span class="token punctuation">[</span><span class="token string">&#x27;c&#x27;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token constant">AO</span><span class="token punctuation">[</span><span class="token string">&#x27;e&#x27;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">reference to </span><span class="token maybe-class-name">FunctionExpression</span><span class="token plain"> </span><span class="token string">&quot;_e&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></div></div></code></pre><p>此时，AO 可以表示为：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token constant">AO</span><span class="token punctuation">(</span><span class="token plain">test</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">a</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">b</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">c</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">d</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">reference to </span><span class="token maybe-class-name">FunctionDeclaration</span><span class="token plain"> </span><span class="token string">&quot;d&quot;</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token comment">// 指向函数 d</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">e</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">reference to </span><span class="token maybe-class-name">FunctionExpression</span><span class="token plain"> </span><span class="token string">&quot;_e&quot;</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token comment">// 指向函数 _e</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></code></pre><p>值得注意的是，<code>e</code>的值为<code>_e</code>函数体，但该函数是不可以通过<code>_e()</code>来调用的，因为它并没有在 AO 的声明。我们再通过一个例子来加深对赋值表达式以及这两个阶段的理解：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">x</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// function x() {}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">x</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 10</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">20</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">x</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 20</span></div></div></code></pre><p>类似<code>var x = 10</code>这样的赋值表达式，可以拆解成两个独立的语句来理解。首先是<code>var x</code>，定义了一个变量<code>x</code>；然后是<code>x = 10</code>，给这个变量赋上值。我们将上述示例代码的第 2 行，拆成这样的两段，整个执行上下文的创建过程，可以这样分析：</p><ol><li><span class="marker">1.</span><div>首先是第一阶段，代码执行到第 2 行的前半部分，也就是<code>var x</code>，此时<code>VO = { x: undefined }</code></div></li><li><span class="marker">2.</span><div>接着代码执行到第 5 行，是一个函数的声明，尽管 VO 中已经有了同名的<code>x</code>属性，但由于函数声明会将其覆盖，此时<code>VO = { x: &lt;reference to FunctionDeclaration &quot;d&quot;&gt; }</code></div></li><li><span class="marker">3.</span><div>第一阶段结束，进入第二阶段</div></li><li><span class="marker">4.</span><div>代码执行到第 1 行，此时<code>x</code>为函数，打印出函数体</div></li><li><span class="marker">5.</span><div>代码跳过第 2 行的前半部分（已经在第一阶段执行了），执行后半部分，<code>x = 10</code>，此时<code>VO = { x: 10 }</code></div></li><li><span class="marker">6.</span><div>代码执行到第 3 行，打印<code>x</code>的值<code>10</code></div></li><li><span class="marker">7.</span><div>代码执行到第 4 行，此时<code>VO = { x: 20 }</code></div></li><li><span class="marker">8.</span><div>代码跳过第 5 行（已经在第一阶段执行了）</div></li><li><span class="marker">9.</span><div>代码执行到第 6 行，打印<code>x</code>的值<code>20</code></div></li></ol><p>如果你能理解这个过程，那文章开头的那道题，也可以用同样的思路去理解。</p><h2>作用域链（Scope Chain）</h2><p>所谓的作用域链，是一连串 VO 所组成的“链”，它决定了某个执行上下文中，能够访问到哪些变量及函数。例如：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">var</span><span class="token plain"> a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> b </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">12</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> c </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">addANumber</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">addANumber</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> a </span><span class="token operator">+</span><span class="token plain"> num</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">c</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 30</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain"></span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>在上面的例子中，存在三个执行上下文：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>全局执行上下文，其 GO 包含变量<code>a</code>与函数<code>foo()</code></div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div><code>foo()</code>的函数执行上下文，其 AO 包含变量<code>b</code>、<code>c</code>与函数<code>addNumber()</code></div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div><code>addNumber()</code>的函数执行上下文，其 AO 包含形参<code>num</code></div></li></ul><p>其中，函数<code>addNumber()</code>可以访问到其 AO 上的形参<code>num</code>以及其外层上下文 VO 中的所有属性。比如在<code>addNumber()</code>中访问变量<code>a</code>，首先会查看当前 AO，发现当前作用域中没有该变量，于是往外层继续查找，在<code>foo()</code>的 AO 中，同样找不到变量<code>a</code>，再继续往外来到全局上下文，在 GO 中找到了<code>a</code>。通过这样的方式，形成的查找链，就是作用域链。像变量<code>a</code>这种不在当前作用域中的变量，我们称之为“自由变量”，查找自由变量的过程，就需要用到作用域链。</p><p>要注意的是，内层能访问外层，而外层没法访问内层。你无法在全局作用域中调用<code>addNumber()</code>函数，因为它定义在内层的 VO 中。</p><h2>“this”</h2><p><code>this</code>是执行上下文中的一个特殊对象，任何对象都有可能成为<code>this</code>的值。<code>this</code>的值在进入执行上下文的时候就被确定，且无法被修改，因为它并不是一个位于 VO 上定义的“变量”。要注意的是，在 ES6 之前，<code>this</code>是执行上下文的属性，而不是 VO 的属性；而在 ES6 中，<code>this</code>成为了词法环境的属性，目的是为了支持箭头函数（箭头函数的<code>this</code>继承自其外层执行上下文）。</p><p>在全局上下文中，<code>this</code>的值等于全局对象 GO：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">var</span><span class="token plain"> x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  x</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 10</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 10</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">x</span><span class="token plain"> </span><span class="token comment">// 10</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>在函数上下文中，<code>this</code>的值在每一次函数调用中都有可能不同，<code>this</code>的值通过调用表达式（调用方式）由调用方（caller）提供。下面的例子中，函数<code>foo()</code>的代码自始至终并没有改变过，但<code>this</code>的值（caller）却在每次调用中都不一样：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain"></span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// caller: 全局对象</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">foo</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method function property-access">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// caller: foo.prototype</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> bar </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">baz</span><span class="token operator">:</span><span class="token plain"> foo</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">bar</span><span class="token punctuation">.</span><span class="token method function property-access">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// caller: bar</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">bar</span><span class="token punctuation">.</span><span class="token method function property-access">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// caller: bar</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">(</span><span class="token plain">bar</span><span class="token punctuation">.</span><span class="token property-access">baz</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> bar</span><span class="token punctuation">.</span><span class="token property-access">baz</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// caller: 全局对象</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">(</span><span class="token plain">bar</span><span class="token punctuation">.</span><span class="token property-access">baz</span><span class="token punctuation">,</span><span class="token plain"> bar</span><span class="token punctuation">.</span><span class="token property-access">baz</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// caller: 全局对象</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> bar</span><span class="token punctuation">.</span><span class="token property-access">baz</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// caller: 全局对象</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">
</span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> otherFoo </span><span class="token operator">=</span><span class="token plain"> bar</span><span class="token punctuation">.</span><span class="token property-access">baz</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain"></span><span class="token function">otherFoo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// caller: 全局对象</span></div></div></code></pre><h2>新规范（ES5+）中的 EC</h2><p>在我一开始去找有关变量提升题目，或者说“预编译”的解释资料时，我发现不同版本的规范对这个过程有着不同的定义。一开始我还以为是我理解错了，很多概念、过程都对不上。后来我又查了更多资料，还看了 ES 的规范，才发现是新的规范里作了调整，不过基本上是大同小异。在网上能找到的资料中，尤其是国内的中文语境下，大多还是套用上文提到的 VO 的执行过程，基于 ES1/3，早已过时。</p><p>而在 ES5 及以后的版本中，已经不存在 VO 等一系列相关的概念了，取而代之的是一个叫词法环境（Lexical Environment）的新定义。<a href="https://262.ecma-international.org/6.0/#sec-lexical-environments">ES6 标准</a>中对词法环境的定义为：</p><blockquote><p>A Lexical Environment is a specification type used to define the association of Identifiers to specific variables and functions based upon the lexical nesting structure of ECMAScript code. A Lexical Environment consists of an Environment Record and a possibly null reference to an outer Lexical Environment.</p></blockquote><p>简单来说，词法环境就是一个包含了标识符与变量间映射关系的结构（这里的标识符指的是变量/函数名，变量指的是实际的对象以及原始值，其中对象又包括函数对象与数组对象）。以下面的代码为例：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> bar </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>变量<code>bar</code>在“词法”上位于<code>foo()</code>函数内部，而<code>foo()</code>函数在词法上又位于全局对象中，这些词法结构被记录在词法环境中。执行上下文创建的时包括以下两个组件（component）：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>词法环境（LexicalEnvironment）</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>变量环境（VariableEnvironment)</div></li></ul><p>它们都属于词法环境（Lexical Environment，上面的 LexicalEnvironment 可以看作是它的实例）。因此，执行上下文也可以用以下的伪代码表示：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token maybe-class-name">ExecutionContext</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token maybe-class-name">LexicalEnvironment</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 指向内存中的词法环境</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">  </span><span class="token maybe-class-name">VariableEnvironment</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 指向内存中的变量环境</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></code></pre><p>它们的区别在于，<code>LexicalEnvironment</code>用于存储函数声明和<code>let</code>、<code>const</code>声明的变量，而<code>VariableEnvironment</code>仅用于存储<code>var</code>变量。</p><p>词法环境（Lexical Environment），包含了以下三个组件：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>环境记录（Environment Record）</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>外部环境引用（Reference to the Outer Environment）</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div>This 绑定（This Binding）</div></li></ul><h3>环境记录（Environment Record）</h3><p>环境记录是词法环境中用来记录变量与函数声明的地方，它又分为两类：</p><ul><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div><strong>声明性环境记录（Declarative Environment Record）</strong>：存储变量和函数声明，对于函数来说，还包括了<code>arguments</code>对象</div></li><li><svg class="marker" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><div><strong>对象环境记录（Object Environment Record）</strong>：全局代码的词法环境，除了全局变量与函数声明外，还包括了由宿主环境提供的对象属性（以浏览器为例，即提供给<code>window</code>对象的各种属性）</div></li></ul><p>这些概念听上去是不是很熟悉，其实本质上就是 VO（AO/GO），变量创建赋值的机制也是一样的，分为两个阶段，这里不再赘述。</p><h3>外部环境引用（Reference to the Outer Environment）</h3><p>对于外层词法环境的引用，JS 引擎在对变量进行查找时，若不能在当前词法环境中找到该变量，则会利用这个引用，从外层的词法环境中继续查找。说白了，就是上面提到的作用域链。</p><h3>This 绑定（This Binding）</h3><p>顾名思义，就是用来记录<code>this</code>的地方，它在 ES5 的时候还是执行上下文的属性，而在 ES6 时又改为词法环境中的一个组件。</p><h3>小结</h3><p>最后，我们用一个例子来把这些新概念串起来：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token keyword">let</span><span class="token plain"> a </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">20</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> b </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">30</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> c</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token parameter punctuation">,</span><span class="token parameter"> f</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> g </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">20</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> e </span><span class="token operator">*</span><span class="token plain"> f </span><span class="token operator">*</span><span class="token plain"> g</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">c </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></code></pre><p>上述代码执行的时候，JS 引擎首先会创建一个全局的执行上下文来执行全局代码。在执行上下文的创建阶段时，全局上下文可以表示为：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token maybe-class-name">GlobalExectionContext</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">LexicalEnvironment</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">EnvironmentRecord</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">Type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;Object&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">      </span><span class="token comment">// 标识符绑定</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">a</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> uninitialized </span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 未初始化</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">b</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> uninitialized </span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">multiply</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> func </span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">outer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token keyword null nil">null</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">ThisBinding</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Global</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">VariableEnvironment</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">EnvironmentRecord</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">Type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;Object&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">      </span><span class="token comment">// 标识符绑定</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">c</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">outer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token keyword null nil">null</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">ThisBinding</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Global</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">21</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">22</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>接下来进入到全局上下文的执行阶段，变量赋值在此完成。此时的全局上下文为：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token maybe-class-name">GlobalExectionContext</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">LexicalEnvironment</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">EnvironmentRecord</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">Type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;Object&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">a</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">20</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">b</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">30</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">multiply</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> func </span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">outer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token keyword null nil">null</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">ThisBinding</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Global</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">VariableEnvironment</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">EnvironmentRecord</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">Type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;Object&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">c</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">outer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token keyword null nil">null</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">ThisBinding</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Global</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">19</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">20</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>程序继续执行到<code>multiply(20, 30)</code>时，一个新的函数执行上下文被创建来执行<code>multiply()</code>函数。此时函数上下文进入到创建阶段：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token maybe-class-name">FunctionExectionContext</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">LexicalEnvironment</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">EnvironmentRecord</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">Type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;Declarative&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">Arguments</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token number">0</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">20</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">30</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">length</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">outer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">GlobalLexicalEnvironment</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">ThisBinding</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Global</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token plain"> or </span><span class="token keyword nil">undefined</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 严格模式下为 undefined</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">VariableEnvironment</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">EnvironmentRecord</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">Type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;Declarative&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">g</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">outer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">GlobalLexicalEnvironment</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">ThisBinding</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Global</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token plain"> or </span><span class="token keyword nil">undefined</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>随后函数上下文进入到执行阶段，为变量进行赋值操作，此时上下文为：</p><pre class="prism-code language-js"><code class="prism-code language-js"><div class="token-line"><span class="line-number">1</span><div class="token-line-content"><span class="token maybe-class-name">FunctionExectionContext</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">2</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">LexicalEnvironment</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">3</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">EnvironmentRecord</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">4</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">Type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;Declarative&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">5</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">Arguments</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token number">0</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">20</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">30</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">length</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">6</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">7</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">outer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">GlobalLexicalEnvironment</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">8</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">ThisBinding</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Global</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token plain"> or </span><span class="token keyword nil">undefined</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">9</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">10</span><div class="token-line-content"><span class="token plain">  </span><span class="token literal-property property">VariableEnvironment</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">11</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">EnvironmentRecord</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">12</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">Type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;Declarative&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">13</span><div class="token-line-content"><span class="token plain">      </span><span class="token literal-property property">g</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">20</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">14</span><div class="token-line-content"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">15</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">outer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">GlobalLexicalEnvironment</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">16</span><div class="token-line-content"><span class="token plain">    </span><span class="token literal-property property">ThisBinding</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Global</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token plain"> or </span><span class="token keyword nil">undefined</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">17</span><div class="token-line-content"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class="token-line"><span class="line-number">18</span><div class="token-line-content"><span class="token plain"></span><span class="token punctuation">}</span></div></div></code></pre><p>最后，当函数执行完毕后，会接返回值存储在变量<code>c</code>中，全局上下文的词法环境得到更新，当所有全局代码完成执行后，整个程序执行结束。</p><p>你可能注意到了，由<code>let</code>和<code>const</code>声明的变量，并没有初始值，而由<code>var</code>声明的变量的初始值为<code>undefined</code>。因此你可以在<code>var</code>声明的变量之前使用该变量（尽量值为<code>undefined</code>），却不能在<code>let</code>或<code>const</code>声明的变量前使用它们（会报错）。而这，就是所谓的“变量提升”。</p><p>在执行阶段时，如果 JS 引擎没法找到<code>let</code>声明变量的赋值时，该变量则会被赋值为<code>undefined</code>。</p><h2>参考资料</h2><ol><li><span class="marker">1.</span><div><a href="https://blog.bitsrc.io/understanding-execution-context-and-execution-stack-in-javascript-1c9ea8642dd0">Understanding Execution Context and Execution Stack in Javascript</a></div></li><li><span class="marker">2.</span><div><a href="https://medium.com/@happymishra66/execution-context-in-javascript-319dd72e8e2c">Execution context, Scope chain and JavaScript internals</a></div></li><li><span class="marker">3.</span><div><a href="http://dmitrysoshnikov.com/ecmascript/javascript-the-core/">JavaScript. The Core.</a></div></li><li><span class="marker">4.</span><div><a href="http://dmitrysoshnikov.com/ecmascript/javascript-the-core-2nd-edition/">JavaScript. The Core: 2nd Edition</a></div></li><li><span class="marker">5.</span><div><a href="http://dmitrysoshnikov.com/ecmascript/chapter-2-variable-object/">ECMA-262-3 in detail. Chapter 2. Variable object.</a></div></li><li><span class="marker">6.</span><div><a href="http://dmitrysoshnikov.com/ecmascript/es5-chapter-3-2-lexical-environments-ecmascript-implementation/">ECMA-262-5 in detail. Chapter 3.2. Lexical environments: ECMAScript implementation.</a></div></li><li><span class="marker">7.</span><div><a href="https://medium.com/@klausng/javascript-scope-chain-variable-objects-and-activation-objects-4eb017256d0b">JavaScript: scope chain, variable objects and activation objects.</a></div></li><li><span class="marker">8.</span><div><a href="https://codeburst.io/js-demystified-04-execution-context-97dea52c8ac6">JS Demystified 04 — Execution Context</a></div></li><li><span class="marker">9.</span><div><a href="https://262.ecma-international.org/6.0/#sec-execution-contexts">ES6 规范-执行上下文</a></div></li></ol></article></main></main><footer><div>Build with ♥ @GZ</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/post/compilation-in-javascript","query":{},"buildId":"H-unq2TEKWOe_LghEWEKT","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>