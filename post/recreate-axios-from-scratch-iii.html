<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="description" content="Kelvin&#x27;s blog"/><link rel="icon" href="/images/favicon.ico"/><title>Axios 源码阅读笔记之——徒手撕 Ajax（三）</title><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/beb59a9e1165a44b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/beb59a9e1165a44b.css" data-n-g=""/><link rel="preload" href="/_next/static/css/5efe62c786a6b4f4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/5efe62c786a6b4f4.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-81f4fb35f4507347.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7000df9582a09740.js" defer=""></script><script src="/_next/static/chunks/323-451496564d94cd92.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bid%5D-b4b49da35f214cd7.js" defer=""></script><script src="/_next/static/i85zbTreoVlPV-vsvfmmV/_buildManifest.js" defer=""></script><script src="/_next/static/i85zbTreoVlPV-vsvfmmV/_ssgManifest.js" defer=""></script><script src="/_next/static/i85zbTreoVlPV-vsvfmmV/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="container"><nav class="navbar"><div class="navbar-content"><div class="navbar-menu-container"><ul class="navbar-menu"><li><a href="/">首页</a></li><li><a href="/posts/horse-sense">秘籍</a></li><li><a href="/posts/gibberish">八股</a></li><li><a href="/posts/xray">庖丁</a></li><li><a href="/posts/copycat">画瓢</a></li></ul></div></div></nav><main class="main"><main><article class="post-container"><div class="post-title-container"><h1 class="post-title">Axios 源码阅读笔记之——徒手撕 Ajax（三）</h1><p class="post-date">Feb 17, 2022</p></div><p>在上一年（过完年相当于去年……）的文章中，我们实现了“简陋版” Axios 的拦截器功能。这一次，我们来看看取消请求的功能该如何实现。</p>
<p>通过前面的文章我们知道，Axios 实际上是封装了 XHR 来发起 Ajax 请求的。对于原生的 XHR，我们可以通过其自带的<code>abort()</code>方法来来执行取消的操作：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">const</span><span class="token plain"> xhr </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">xhr</span><span class="token punctuation">.</span><span class="token method function property-access">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;https://www.xxx.com/api&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">xhr</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain"></span><span class="token comment">// 取消请求</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">xhr</span><span class="token punctuation">.</span><span class="token method function property-access">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p>而真正的 XHR 请求，则是被层层包裹，依次通过<code>request()</code>、<code>dispatchRequest()</code>、<code>xhrAdapter()</code>等方法，最终调用包裹在 Promise 中的<code>XMLHttpRequest()</code>方法。那么我们该怎样取消一个 Promise 呢？</p>
<h2>“取消” 一个 Promise</h2>
<p>我们知道，Promise 一共有三种状态：pending、fulfilled、rejected，后两者统称为“settled/resolved”。Promise 只能从默认的 pending 状态转为 fulfilled 或 rejected，又或者一直保持在 pending 状态中，无法被取消。虽然 Promise 无法手动取消，但我们可以通过调用<code>resolve()</code>或<code>reject()</code>方法来改变其状态，从而强行“中止”该 Promise。大致原理如下：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">let</span><span class="token plain"> cancel</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> axios </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation">,</span><span class="token parameter"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">  cancel </span><span class="token operator">=</span><span class="token plain"> reject</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 把 reject 方法暴露到外面</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">  </span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">    </span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;done&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">axios</span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">done</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 不会触发</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">  </span><span class="token punctuation">.</span><span class="token keyword control-flow">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// cancelled manually</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain"></span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token string">&quot;cancelled manually&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 相当于调用了 reject()</span><span class="token plain"></span></span></div></pre></div>
<p>虽然“中止”和“取消”不同，但这样做一样达到了提前令 Promise 停止下来的目的。我们只需要做调用调用<code>resolve()</code>（或<code>reject()</code>）方法的同时（或者之后，也就是在<code>then()</code>方法中调用），调用<code>xhr.abort()</code>方法，即可实现取消 XHR 请求的效果。</p>
<p>Axios 正是通过该原理，利用<code>CancelToken</code>来改变 Promise 状态，从而取消其内部的 XHR 请求。Axios 的这套<code>CancelToken</code>的 API 则是来自于一套被撤回的 TC39 提案，有兴趣的可以看看<a href="https://github.com/tc39/proposal-cancelable-promises">cancelable promises proposal</a>。</p>
<h2>Axios 中取消请求的用法</h2>
<p>照例，我们先来看看官方文档中 Axios 取消的用法，方法一，通过<code>CancelToken.source()</code>工厂方法：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">CancelToken</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> axios</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">CancelToken</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> source </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">CancelToken</span><span class="token punctuation">.</span><span class="token method function property-access">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">axios</span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">  </span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">&quot;/user/12345&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">    </span><span class="token literal-property property">cancelToken</span><span class="token operator">:</span><span class="token plain"> source</span><span class="token punctuation">.</span><span class="token property-access">token</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">  </span><span class="token punctuation">.</span><span class="token keyword control-flow">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">thrown</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method function property-access">isCancel</span><span class="token punctuation">(</span><span class="token plain">thrown</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&quot;Request canceled&quot;</span><span class="token punctuation">,</span><span class="token plain"> thrown</span><span class="token punctuation">.</span><span class="token property-access">message</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">      </span><span class="token comment">// handle error</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">  </span><span class="token string">&quot;/user/12345&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">    </span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;new name&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain">    </span><span class="token literal-property property">cancelToken</span><span class="token operator">:</span><span class="token plain"> source</span><span class="token punctuation">.</span><span class="token property-access">token</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">23</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">24</span><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">25</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">26</span><span class="token plain"></span><span class="token comment">// cancel the request (the message parameter is optional)</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">27</span><span class="token plain">source</span><span class="token punctuation">.</span><span class="token method function property-access">cancel</span><span class="token punctuation">(</span><span class="token string">&quot;Operation canceled by the user.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p>方法二，直接通过<code>CancelToken()</code>构造函数：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">CancelToken</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> axios</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">CancelToken</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> cancel</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">axios</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">&quot;/user/12345&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">  </span><span class="token literal-property property">cancelToken</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">CancelToken</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">    </span><span class="token comment">// An executor function receives a cancel function as a parameter</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">    cancel </span><span class="token operator">=</span><span class="token plain"> c</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain"></span><span class="token comment">// cancel the request</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain"></span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<h2>暴露“取消”方法</h2>
<p>可以看出，关键在于<code>CancelToken()</code>构造函数参数<code>executor(c)</code>中的这个<code>c</code>。实际上，通过工厂方法<code>CancelToken.source()</code>所生成的<code>source</code>中的<code>cancel()</code>方法，同样也是指向这个<code>c</code>。这个神奇的<code>c</code>，究竟是什么玩意？</p>
<p>别急，让我们先来看看 Axios 源码中的这个<code>CancelToken</code>是何方神圣：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">CancelToken</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> executor </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">    </span><span class="token keyword control-flow">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;executor must be a function.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> resolvePromise</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">promise</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">promiseExecutor</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token plain">    resolvePromise </span><span class="token operator">=</span><span class="token plain"> resolve</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> token </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">  </span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">token</span><span class="token punctuation">.</span><span class="token property-access">reason</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">    token</span><span class="token punctuation">.</span><span class="token property-access">reason</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Cancel</span><span class="token punctuation">(</span><span class="token plain">message</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">    </span><span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token plain">token</span><span class="token punctuation">.</span><span class="token property-access">reason</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span></div></pre></div>
<p>从构造函数<code>CancelToken()</code>中可以看出，它的实例中有一个名为<code>promise</code>的属性，其值是一个 Promise，它将<code>resolve()</code>方法暴露给了<code>resolvePromise</code>。而构造函数<code>CancelToken()</code>的参数<code>executor</code>，在生成实例时会调用。也就是说上面用例二中的<code>executor(c)</code>方法在生成 token 实例时会执行，实际上就是执行了：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token plain">cancel </span><span class="token operator">=</span><span class="token plain"> c</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p>这里的<code>c</code>，就是构造函数中定义的<code>cancel(message)</code>方法，就相当于：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token function-variable function">cancel</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">token</span><span class="token punctuation">.</span><span class="token property-access">reason</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">  token</span><span class="token punctuation">.</span><span class="token property-access">reason</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Cancel</span><span class="token punctuation">(</span><span class="token plain">message</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">  </span><span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token plain">token</span><span class="token punctuation">.</span><span class="token property-access">reason</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p>所以，绕了这么一大圈，<code>CancelToken</code>做的事情，就是将实例中<code>promise</code>的<code>resolve()</code>方法给暴露出去，当我们调用<code>cancel()</code>方法时，会调用<code>resolvePromise()</code>方法，最终导致实例<code>promise</code>属性的状态发生改变。</p>
<h2>“链”锁反应</h2>
<p>那么问题又来了，这个<code>promise</code>的作用又是什么，为什么要这么绕地把它的<code>resolve()</code>方法给暴露出去？说到暴露方法，是否有点熟悉？没错，这正是上面提到的 Promise 的“取消”（中止）方法，将<code>resolve()</code>方法暴露，就是为了能够在外部“取消”这个 Promise。</p>
<p>我们知道，Promise 是可以链式调用的，只需要在<code>promise</code>的<code>then()</code>方法中，调用<code>xhr.abort()</code>方法，即可实现取消功能。而在 Axios 中，就是这样实现的：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token comment">// 在 xhrAdapter.js 中</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">xhrAdapter</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> cancelToken </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> config</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation">,</span><span class="token parameter"> reject</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> request </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">6</span><span class="token plain">    </span><span class="token comment">/*</span></span><span class="token-line"><span class="code-block-line-number">7</span><span class="token comment">      省略代码</span></span><span class="token-line"><span class="code-block-line-number">8</span><span class="token comment">    */</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">9</span><span class="token plain">    request</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onreadystatechange</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">handleLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token comment">/* 省略 */</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">10</span><span class="token plain">    request</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onabort</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">handleAbort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token comment">/* 省略 */</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">11</span><span class="token plain">    request</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onerror</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">handleError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token comment">/* 省略 */</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">12</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">13</span><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">cancelToken</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">14</span><span class="token plain">      cancelToken</span><span class="token punctuation">.</span><span class="token property-access">promise</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cancel</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">15</span><span class="token plain">        </span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token plain">cancel</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">16</span><span class="token plain">        xhr</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token method function property-access">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">17</span><span class="token plain">        xhr </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">18</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">19</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">20</span><span class="token plain">    request</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">21</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">22</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span></div></pre></div>
<p><code>config</code>中的<code>cancelToken</code>属性，是一个<code>CancelToken</code>实例，在调用<code>xhrAdapter()</code>方法时，会判断是否设置了该属性，若有，则在其<code>promise</code>属性的<code>then()</code>方法中，调用包裹 XHR 请求的 Promise 的<code>reject()</code>方法，来中止该 Promise 的继续执行，同时调用<code>xhr.abort()</code>方法，取消 XHR 请求。</p>
<p>调用<code>reject(cancel)</code>方法时的<code>cancel</code>参数，是一个<code>Cancel</code>实例：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Cancel</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">message</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> message</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">4</span><span class="token plain">
</span></span><span class="token-line"><span class="code-block-line-number">5</span><span class="token plain"></span><span class="token class-name">Cancel</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">__CANCEL__</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></span></div></pre></div>
<p>我们可以通过<code>isCancel()</code>函数来判断<code>reject()</code>方法抛出的错误是否为<code>Cancel</code>实例，从而作出特殊的处理：</p>
<div class="code-block-container"><div class="code-block-head"><ul class="code-block-buttons"><li class="code-block-button red"></li><li class="code-block-button yellow"></li><li class="code-block-button green"></li></ul>code</div><pre class="prism-code language-js"><div class="code-block"><span class="token-line"><span class="code-block-line-number">1</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">isCancel</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">2</span><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token plain">value </span><span class="token operator">&amp;&amp;</span><span class="token plain"> value</span><span class="token punctuation">.</span><span class="token property-access">__CANCEL__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></span><span class="token-line"><span class="code-block-line-number">3</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></span></div></pre></div>
<p>如此，我们便实现了取消请求的功能。</p></article></main></main><footer><div>Build with ♥ @GZ</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"meta":{"title":"Axios 源码阅读笔记之——徒手撕 Ajax（三）","date":"Feb 17, 2022","desc":"在上一年（过完年相当于去年……）的文章中，我们实现了“简陋版” Axios 的拦截器功能。这一次，我们来看看取消请求的功能该如何实现。","type":"xray"},"code":"var Component=(()=\u003e{var t=Object.create;var d=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var u=Object.getOwnPropertyNames;var p=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var x=(c,r)=\u003e()=\u003e(r||c((r={exports:{}}).exports,r),r.exports),g=(c,r)=\u003e{for(var o in r)d(c,o,{get:r[o],enumerable:!0})},i=(c,r,o,n)=\u003e{if(r\u0026\u0026typeof r==\"object\"||typeof r==\"function\")for(let l of u(r))!m.call(c,l)\u0026\u0026l!==o\u0026\u0026d(c,l,{get:()=\u003er[l],enumerable:!(n=h(r,l))||n.enumerable});return c};var f=(c,r,o)=\u003e(o=c!=null?t(p(c)):{},i(r||!c||!c.__esModule?d(o,\"default\",{value:c,enumerable:!0}):o,c)),k=c=\u003ei(d({},\"__esModule\",{value:!0}),c);var a=x((A,s)=\u003e{s.exports=_jsx_runtime});var P={};g(P,{default:()=\u003eT,frontmatter:()=\u003eC});var e=f(a()),C={title:\"Axios \\u6E90\\u7801\\u9605\\u8BFB\\u7B14\\u8BB0\\u4E4B\\u2014\\u2014\\u5F92\\u624B\\u6495 Ajax\\uFF08\\u4E09\\uFF09\",date:\"Feb 17, 2022\",desc:\"\\u5728\\u4E0A\\u4E00\\u5E74\\uFF08\\u8FC7\\u5B8C\\u5E74\\u76F8\\u5F53\\u4E8E\\u53BB\\u5E74\\u2026\\u2026\\uFF09\\u7684\\u6587\\u7AE0\\u4E2D\\uFF0C\\u6211\\u4EEC\\u5B9E\\u73B0\\u4E86\\u201C\\u7B80\\u964B\\u7248\\u201D Axios \\u7684\\u62E6\\u622A\\u5668\\u529F\\u80FD\\u3002\\u8FD9\\u4E00\\u6B21\\uFF0C\\u6211\\u4EEC\\u6765\\u770B\\u770B\\u53D6\\u6D88\\u8BF7\\u6C42\\u7684\\u529F\\u80FD\\u8BE5\\u5982\\u4F55\\u5B9E\\u73B0\\u3002\",type:\"xray\"};function j(c={}){let{wrapper:r}=c.components||{};return r?(0,e.jsx)(r,Object.assign({},c,{children:(0,e.jsx)(o,{})})):o();function o(){let n=Object.assign({p:\"p\",code:\"code\",pre:\"pre\",h2:\"h2\",a:\"a\"},c.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:\"\\u5728\\u4E0A\\u4E00\\u5E74\\uFF08\\u8FC7\\u5B8C\\u5E74\\u76F8\\u5F53\\u4E8E\\u53BB\\u5E74\\u2026\\u2026\\uFF09\\u7684\\u6587\\u7AE0\\u4E2D\\uFF0C\\u6211\\u4EEC\\u5B9E\\u73B0\\u4E86\\u201C\\u7B80\\u964B\\u7248\\u201D Axios \\u7684\\u62E6\\u622A\\u5668\\u529F\\u80FD\\u3002\\u8FD9\\u4E00\\u6B21\\uFF0C\\u6211\\u4EEC\\u6765\\u770B\\u770B\\u53D6\\u6D88\\u8BF7\\u6C42\\u7684\\u529F\\u80FD\\u8BE5\\u5982\\u4F55\\u5B9E\\u73B0\\u3002\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u901A\\u8FC7\\u524D\\u9762\\u7684\\u6587\\u7AE0\\u6211\\u4EEC\\u77E5\\u9053\\uFF0CAxios \\u5B9E\\u9645\\u4E0A\\u662F\\u5C01\\u88C5\\u4E86 XHR \\u6765\\u53D1\\u8D77 Ajax \\u8BF7\\u6C42\\u7684\\u3002\\u5BF9\\u4E8E\\u539F\\u751F\\u7684 XHR\\uFF0C\\u6211\\u4EEC\\u53EF\\u4EE5\\u901A\\u8FC7\\u5176\\u81EA\\u5E26\\u7684\",(0,e.jsx)(n.code,{children:\"abort()\"}),\"\\u65B9\\u6CD5\\u6765\\u6765\\u6267\\u884C\\u53D6\\u6D88\\u7684\\u64CD\\u4F5C\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`const xhr = new XMLHttpRequest();\nxhr.open(\"GET\", \"https://www.xxx.com/api\");\nxhr.send();\n\n// \\u53D6\\u6D88\\u8BF7\\u6C42\nxhr.abort();\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u800C\\u771F\\u6B63\\u7684 XHR \\u8BF7\\u6C42\\uFF0C\\u5219\\u662F\\u88AB\\u5C42\\u5C42\\u5305\\u88F9\\uFF0C\\u4F9D\\u6B21\\u901A\\u8FC7\",(0,e.jsx)(n.code,{children:\"request()\"}),\"\\u3001\",(0,e.jsx)(n.code,{children:\"dispatchRequest()\"}),\"\\u3001\",(0,e.jsx)(n.code,{children:\"xhrAdapter()\"}),\"\\u7B49\\u65B9\\u6CD5\\uFF0C\\u6700\\u7EC8\\u8C03\\u7528\\u5305\\u88F9\\u5728 Promise \\u4E2D\\u7684\",(0,e.jsx)(n.code,{children:\"XMLHttpRequest()\"}),\"\\u65B9\\u6CD5\\u3002\\u90A3\\u4E48\\u6211\\u4EEC\\u8BE5\\u600E\\u6837\\u53D6\\u6D88\\u4E00\\u4E2A Promise \\u5462\\uFF1F\"]}),`\n`,(0,e.jsx)(n.h2,{children:\"\\u201C\\u53D6\\u6D88\\u201D \\u4E00\\u4E2A Promise\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u6211\\u4EEC\\u77E5\\u9053\\uFF0CPromise \\u4E00\\u5171\\u6709\\u4E09\\u79CD\\u72B6\\u6001\\uFF1Apending\\u3001fulfilled\\u3001rejected\\uFF0C\\u540E\\u4E24\\u8005\\u7EDF\\u79F0\\u4E3A\\u201Csettled/resolved\\u201D\\u3002Promise \\u53EA\\u80FD\\u4ECE\\u9ED8\\u8BA4\\u7684 pending \\u72B6\\u6001\\u8F6C\\u4E3A fulfilled \\u6216 rejected\\uFF0C\\u53C8\\u6216\\u8005\\u4E00\\u76F4\\u4FDD\\u6301\\u5728 pending \\u72B6\\u6001\\u4E2D\\uFF0C\\u65E0\\u6CD5\\u88AB\\u53D6\\u6D88\\u3002\\u867D\\u7136 Promise \\u65E0\\u6CD5\\u624B\\u52A8\\u53D6\\u6D88\\uFF0C\\u4F46\\u6211\\u4EEC\\u53EF\\u4EE5\\u901A\\u8FC7\\u8C03\\u7528\",(0,e.jsx)(n.code,{children:\"resolve()\"}),\"\\u6216\",(0,e.jsx)(n.code,{children:\"reject()\"}),\"\\u65B9\\u6CD5\\u6765\\u6539\\u53D8\\u5176\\u72B6\\u6001\\uFF0C\\u4ECE\\u800C\\u5F3A\\u884C\\u201C\\u4E2D\\u6B62\\u201D\\u8BE5 Promise\\u3002\\u5927\\u81F4\\u539F\\u7406\\u5982\\u4E0B\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`let cancel;\n\nconst axios = new Promise((resolve, reject) =\u003e {\n  cancel = reject; // \\u628A reject \\u65B9\\u6CD5\\u66B4\\u9732\\u5230\\u5916\\u9762\n  setTimeout(() =\u003e {\n    resolve(\"done\");\n  }, 3000);\n});\n\naxios\n  .then((done) =\u003e {\n    console.log(done); // \\u4E0D\\u4F1A\\u89E6\\u53D1\n  })\n  .catch((err) =\u003e {\n    console.error(err); // cancelled manually\n  });\n\ncancel(\"cancelled manually\"); // \\u76F8\\u5F53\\u4E8E\\u8C03\\u7528\\u4E86 reject()\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u867D\\u7136\\u201C\\u4E2D\\u6B62\\u201D\\u548C\\u201C\\u53D6\\u6D88\\u201D\\u4E0D\\u540C\\uFF0C\\u4F46\\u8FD9\\u6837\\u505A\\u4E00\\u6837\\u8FBE\\u5230\\u4E86\\u63D0\\u524D\\u4EE4 Promise \\u505C\\u6B62\\u4E0B\\u6765\\u7684\\u76EE\\u7684\\u3002\\u6211\\u4EEC\\u53EA\\u9700\\u8981\\u505A\\u8C03\\u7528\\u8C03\\u7528\",(0,e.jsx)(n.code,{children:\"resolve()\"}),\"\\uFF08\\u6216\",(0,e.jsx)(n.code,{children:\"reject()\"}),\"\\uFF09\\u65B9\\u6CD5\\u7684\\u540C\\u65F6\\uFF08\\u6216\\u8005\\u4E4B\\u540E\\uFF0C\\u4E5F\\u5C31\\u662F\\u5728\",(0,e.jsx)(n.code,{children:\"then()\"}),\"\\u65B9\\u6CD5\\u4E2D\\u8C03\\u7528\\uFF09\\uFF0C\\u8C03\\u7528\",(0,e.jsx)(n.code,{children:\"xhr.abort()\"}),\"\\u65B9\\u6CD5\\uFF0C\\u5373\\u53EF\\u5B9E\\u73B0\\u53D6\\u6D88 XHR \\u8BF7\\u6C42\\u7684\\u6548\\u679C\\u3002\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"Axios \\u6B63\\u662F\\u901A\\u8FC7\\u8BE5\\u539F\\u7406\\uFF0C\\u5229\\u7528\",(0,e.jsx)(n.code,{children:\"CancelToken\"}),\"\\u6765\\u6539\\u53D8 Promise \\u72B6\\u6001\\uFF0C\\u4ECE\\u800C\\u53D6\\u6D88\\u5176\\u5185\\u90E8\\u7684 XHR \\u8BF7\\u6C42\\u3002Axios \\u7684\\u8FD9\\u5957\",(0,e.jsx)(n.code,{children:\"CancelToken\"}),\"\\u7684 API \\u5219\\u662F\\u6765\\u81EA\\u4E8E\\u4E00\\u5957\\u88AB\\u64A4\\u56DE\\u7684 TC39 \\u63D0\\u6848\\uFF0C\\u6709\\u5174\\u8DA3\\u7684\\u53EF\\u4EE5\\u770B\\u770B\",(0,e.jsx)(n.a,{href:\"https://github.com/tc39/proposal-cancelable-promises\",children:\"cancelable promises proposal\"}),\"\\u3002\"]}),`\n`,(0,e.jsx)(n.h2,{children:\"Axios \\u4E2D\\u53D6\\u6D88\\u8BF7\\u6C42\\u7684\\u7528\\u6CD5\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u7167\\u4F8B\\uFF0C\\u6211\\u4EEC\\u5148\\u6765\\u770B\\u770B\\u5B98\\u65B9\\u6587\\u6863\\u4E2D Axios \\u53D6\\u6D88\\u7684\\u7528\\u6CD5\\uFF0C\\u65B9\\u6CD5\\u4E00\\uFF0C\\u901A\\u8FC7\",(0,e.jsx)(n.code,{children:\"CancelToken.source()\"}),\"\\u5DE5\\u5382\\u65B9\\u6CD5\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`const CancelToken = axios.CancelToken;\nconst source = CancelToken.source();\n\naxios\n  .get(\"/user/12345\", {\n    cancelToken: source.token,\n  })\n  .catch(function (thrown) {\n    if (axios.isCancel(thrown)) {\n      console.log(\"Request canceled\", thrown.message);\n    } else {\n      // handle error\n    }\n  });\n\naxios.post(\n  \"/user/12345\",\n  {\n    name: \"new name\",\n  },\n  {\n    cancelToken: source.token,\n  }\n);\n\n// cancel the request (the message parameter is optional)\nsource.cancel(\"Operation canceled by the user.\");\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u65B9\\u6CD5\\u4E8C\\uFF0C\\u76F4\\u63A5\\u901A\\u8FC7\",(0,e.jsx)(n.code,{children:\"CancelToken()\"}),\"\\u6784\\u9020\\u51FD\\u6570\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`const CancelToken = axios.CancelToken;\nlet cancel;\n\naxios.get(\"/user/12345\", {\n  cancelToken: new CancelToken(function executor(c) {\n    // An executor function receives a cancel function as a parameter\n    cancel = c;\n  }),\n});\n\n// cancel the request\ncancel();\n`})}),`\n`,(0,e.jsx)(n.h2,{children:\"\\u66B4\\u9732\\u201C\\u53D6\\u6D88\\u201D\\u65B9\\u6CD5\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u53EF\\u4EE5\\u770B\\u51FA\\uFF0C\\u5173\\u952E\\u5728\\u4E8E\",(0,e.jsx)(n.code,{children:\"CancelToken()\"}),\"\\u6784\\u9020\\u51FD\\u6570\\u53C2\\u6570\",(0,e.jsx)(n.code,{children:\"executor(c)\"}),\"\\u4E2D\\u7684\\u8FD9\\u4E2A\",(0,e.jsx)(n.code,{children:\"c\"}),\"\\u3002\\u5B9E\\u9645\\u4E0A\\uFF0C\\u901A\\u8FC7\\u5DE5\\u5382\\u65B9\\u6CD5\",(0,e.jsx)(n.code,{children:\"CancelToken.source()\"}),\"\\u6240\\u751F\\u6210\\u7684\",(0,e.jsx)(n.code,{children:\"source\"}),\"\\u4E2D\\u7684\",(0,e.jsx)(n.code,{children:\"cancel()\"}),\"\\u65B9\\u6CD5\\uFF0C\\u540C\\u6837\\u4E5F\\u662F\\u6307\\u5411\\u8FD9\\u4E2A\",(0,e.jsx)(n.code,{children:\"c\"}),\"\\u3002\\u8FD9\\u4E2A\\u795E\\u5947\\u7684\",(0,e.jsx)(n.code,{children:\"c\"}),\"\\uFF0C\\u7A76\\u7ADF\\u662F\\u4EC0\\u4E48\\u73A9\\u610F\\uFF1F\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u522B\\u6025\\uFF0C\\u8BA9\\u6211\\u4EEC\\u5148\\u6765\\u770B\\u770B Axios \\u6E90\\u7801\\u4E2D\\u7684\\u8FD9\\u4E2A\",(0,e.jsx)(n.code,{children:\"CancelToken\"}),\"\\u662F\\u4F55\\u65B9\\u795E\\u5723\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`function CancelToken(executor) {\n  if (typeof executor !== \"function\") {\n    throw new TypeError(\"executor must be a function.\");\n  }\n\n  var resolvePromise;\n  this.promise = new Promise(function promiseExecutor(resolve) {\n    resolvePromise = resolve;\n  });\n\n  var token = this;\n  executor(function cancel(message) {\n    if (token.reason) {\n      return;\n    }\n    token.reason = new Cancel(message);\n    resolvePromise(token.reason);\n  });\n}\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u4ECE\\u6784\\u9020\\u51FD\\u6570\",(0,e.jsx)(n.code,{children:\"CancelToken()\"}),\"\\u4E2D\\u53EF\\u4EE5\\u770B\\u51FA\\uFF0C\\u5B83\\u7684\\u5B9E\\u4F8B\\u4E2D\\u6709\\u4E00\\u4E2A\\u540D\\u4E3A\",(0,e.jsx)(n.code,{children:\"promise\"}),\"\\u7684\\u5C5E\\u6027\\uFF0C\\u5176\\u503C\\u662F\\u4E00\\u4E2A Promise\\uFF0C\\u5B83\\u5C06\",(0,e.jsx)(n.code,{children:\"resolve()\"}),\"\\u65B9\\u6CD5\\u66B4\\u9732\\u7ED9\\u4E86\",(0,e.jsx)(n.code,{children:\"resolvePromise\"}),\"\\u3002\\u800C\\u6784\\u9020\\u51FD\\u6570\",(0,e.jsx)(n.code,{children:\"CancelToken()\"}),\"\\u7684\\u53C2\\u6570\",(0,e.jsx)(n.code,{children:\"executor\"}),\"\\uFF0C\\u5728\\u751F\\u6210\\u5B9E\\u4F8B\\u65F6\\u4F1A\\u8C03\\u7528\\u3002\\u4E5F\\u5C31\\u662F\\u8BF4\\u4E0A\\u9762\\u7528\\u4F8B\\u4E8C\\u4E2D\\u7684\",(0,e.jsx)(n.code,{children:\"executor(c)\"}),\"\\u65B9\\u6CD5\\u5728\\u751F\\u6210 token \\u5B9E\\u4F8B\\u65F6\\u4F1A\\u6267\\u884C\\uFF0C\\u5B9E\\u9645\\u4E0A\\u5C31\\u662F\\u6267\\u884C\\u4E86\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`cancel = c;\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u8FD9\\u91CC\\u7684\",(0,e.jsx)(n.code,{children:\"c\"}),\"\\uFF0C\\u5C31\\u662F\\u6784\\u9020\\u51FD\\u6570\\u4E2D\\u5B9A\\u4E49\\u7684\",(0,e.jsx)(n.code,{children:\"cancel(message)\"}),\"\\u65B9\\u6CD5\\uFF0C\\u5C31\\u76F8\\u5F53\\u4E8E\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`cancel = function cancel(message) {\n  if (token.reason) {\n    return;\n  }\n  token.reason = new Cancel(message);\n  resolvePromise(token.reason);\n};\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u6240\\u4EE5\\uFF0C\\u7ED5\\u4E86\\u8FD9\\u4E48\\u4E00\\u5927\\u5708\\uFF0C\",(0,e.jsx)(n.code,{children:\"CancelToken\"}),\"\\u505A\\u7684\\u4E8B\\u60C5\\uFF0C\\u5C31\\u662F\\u5C06\\u5B9E\\u4F8B\\u4E2D\",(0,e.jsx)(n.code,{children:\"promise\"}),\"\\u7684\",(0,e.jsx)(n.code,{children:\"resolve()\"}),\"\\u65B9\\u6CD5\\u7ED9\\u66B4\\u9732\\u51FA\\u53BB\\uFF0C\\u5F53\\u6211\\u4EEC\\u8C03\\u7528\",(0,e.jsx)(n.code,{children:\"cancel()\"}),\"\\u65B9\\u6CD5\\u65F6\\uFF0C\\u4F1A\\u8C03\\u7528\",(0,e.jsx)(n.code,{children:\"resolvePromise()\"}),\"\\u65B9\\u6CD5\\uFF0C\\u6700\\u7EC8\\u5BFC\\u81F4\\u5B9E\\u4F8B\",(0,e.jsx)(n.code,{children:\"promise\"}),\"\\u5C5E\\u6027\\u7684\\u72B6\\u6001\\u53D1\\u751F\\u6539\\u53D8\\u3002\"]}),`\n`,(0,e.jsx)(n.h2,{children:\"\\u201C\\u94FE\\u201D\\u9501\\u53CD\\u5E94\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u90A3\\u4E48\\u95EE\\u9898\\u53C8\\u6765\\u4E86\\uFF0C\\u8FD9\\u4E2A\",(0,e.jsx)(n.code,{children:\"promise\"}),\"\\u7684\\u4F5C\\u7528\\u53C8\\u662F\\u4EC0\\u4E48\\uFF0C\\u4E3A\\u4EC0\\u4E48\\u8981\\u8FD9\\u4E48\\u7ED5\\u5730\\u628A\\u5B83\\u7684\",(0,e.jsx)(n.code,{children:\"resolve()\"}),\"\\u65B9\\u6CD5\\u7ED9\\u66B4\\u9732\\u51FA\\u53BB\\uFF1F\\u8BF4\\u5230\\u66B4\\u9732\\u65B9\\u6CD5\\uFF0C\\u662F\\u5426\\u6709\\u70B9\\u719F\\u6089\\uFF1F\\u6CA1\\u9519\\uFF0C\\u8FD9\\u6B63\\u662F\\u4E0A\\u9762\\u63D0\\u5230\\u7684 Promise \\u7684\\u201C\\u53D6\\u6D88\\u201D\\uFF08\\u4E2D\\u6B62\\uFF09\\u65B9\\u6CD5\\uFF0C\\u5C06\",(0,e.jsx)(n.code,{children:\"resolve()\"}),\"\\u65B9\\u6CD5\\u66B4\\u9732\\uFF0C\\u5C31\\u662F\\u4E3A\\u4E86\\u80FD\\u591F\\u5728\\u5916\\u90E8\\u201C\\u53D6\\u6D88\\u201D\\u8FD9\\u4E2A Promise\\u3002\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u6211\\u4EEC\\u77E5\\u9053\\uFF0CPromise \\u662F\\u53EF\\u4EE5\\u94FE\\u5F0F\\u8C03\\u7528\\u7684\\uFF0C\\u53EA\\u9700\\u8981\\u5728\",(0,e.jsx)(n.code,{children:\"promise\"}),\"\\u7684\",(0,e.jsx)(n.code,{children:\"then()\"}),\"\\u65B9\\u6CD5\\u4E2D\\uFF0C\\u8C03\\u7528\",(0,e.jsx)(n.code,{children:\"xhr.abort()\"}),\"\\u65B9\\u6CD5\\uFF0C\\u5373\\u53EF\\u5B9E\\u73B0\\u53D6\\u6D88\\u529F\\u80FD\\u3002\\u800C\\u5728 Axios \\u4E2D\\uFF0C\\u5C31\\u662F\\u8FD9\\u6837\\u5B9E\\u73B0\\u7684\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`// \\u5728 xhrAdapter.js \\u4E2D\nfunction xhrAdapter(config) {\n  const { cancelToken } = config;\n  return new Promise((resolve, reject) =\u003e {\n    const request = new XMLHttpRequest();\n    /*\n      \\u7701\\u7565\\u4EE3\\u7801\n    */\n    request.onreadystatechange = function handleLoad() { /* \\u7701\\u7565 */ }\n    request.onabort = function handleAbort() { /* \\u7701\\u7565 */ }\n    request.onerror = function handleError() { /* \\u7701\\u7565 */ }\n\n    if (cancelToken) {\n      cancelToken.promise.then((cancel) =\u003e {\n        reject(cancel);\n        xhr!.abort();\n        xhr = null;\n      });\n    }\n    request.send();\n  });\n}\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"config\"}),\"\\u4E2D\\u7684\",(0,e.jsx)(n.code,{children:\"cancelToken\"}),\"\\u5C5E\\u6027\\uFF0C\\u662F\\u4E00\\u4E2A\",(0,e.jsx)(n.code,{children:\"CancelToken\"}),\"\\u5B9E\\u4F8B\\uFF0C\\u5728\\u8C03\\u7528\",(0,e.jsx)(n.code,{children:\"xhrAdapter()\"}),\"\\u65B9\\u6CD5\\u65F6\\uFF0C\\u4F1A\\u5224\\u65AD\\u662F\\u5426\\u8BBE\\u7F6E\\u4E86\\u8BE5\\u5C5E\\u6027\\uFF0C\\u82E5\\u6709\\uFF0C\\u5219\\u5728\\u5176\",(0,e.jsx)(n.code,{children:\"promise\"}),\"\\u5C5E\\u6027\\u7684\",(0,e.jsx)(n.code,{children:\"then()\"}),\"\\u65B9\\u6CD5\\u4E2D\\uFF0C\\u8C03\\u7528\\u5305\\u88F9 XHR \\u8BF7\\u6C42\\u7684 Promise \\u7684\",(0,e.jsx)(n.code,{children:\"reject()\"}),\"\\u65B9\\u6CD5\\uFF0C\\u6765\\u4E2D\\u6B62\\u8BE5 Promise \\u7684\\u7EE7\\u7EED\\u6267\\u884C\\uFF0C\\u540C\\u65F6\\u8C03\\u7528\",(0,e.jsx)(n.code,{children:\"xhr.abort()\"}),\"\\u65B9\\u6CD5\\uFF0C\\u53D6\\u6D88 XHR \\u8BF7\\u6C42\\u3002\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u8C03\\u7528\",(0,e.jsx)(n.code,{children:\"reject(cancel)\"}),\"\\u65B9\\u6CD5\\u65F6\\u7684\",(0,e.jsx)(n.code,{children:\"cancel\"}),\"\\u53C2\\u6570\\uFF0C\\u662F\\u4E00\\u4E2A\",(0,e.jsx)(n.code,{children:\"Cancel\"}),\"\\u5B9E\\u4F8B\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`function Cancel(message) {\n  this.message = message;\n}\n\nCancel.prototype.__CANCEL__ = true;\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u6211\\u4EEC\\u53EF\\u4EE5\\u901A\\u8FC7\",(0,e.jsx)(n.code,{children:\"isCancel()\"}),\"\\u51FD\\u6570\\u6765\\u5224\\u65AD\",(0,e.jsx)(n.code,{children:\"reject()\"}),\"\\u65B9\\u6CD5\\u629B\\u51FA\\u7684\\u9519\\u8BEF\\u662F\\u5426\\u4E3A\",(0,e.jsx)(n.code,{children:\"Cancel\"}),\"\\u5B9E\\u4F8B\\uFF0C\\u4ECE\\u800C\\u4F5C\\u51FA\\u7279\\u6B8A\\u7684\\u5904\\u7406\\uFF1A\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-js\",children:`function isCancel(value) {\n  return !!(value \u0026\u0026 value.__CANCEL__);\n}\n`})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u5982\\u6B64\\uFF0C\\u6211\\u4EEC\\u4FBF\\u5B9E\\u73B0\\u4E86\\u53D6\\u6D88\\u8BF7\\u6C42\\u7684\\u529F\\u80FD\\u3002\"})]})}}var T=j;return k(P);})();\n;return Component;"},"__N_SSG":true},"page":"/post/[id]","query":{"id":"recreate-axios-from-scratch-iii"},"buildId":"i85zbTreoVlPV-vsvfmmV","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>