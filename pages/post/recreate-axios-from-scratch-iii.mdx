---
title: "Axios 源码阅读笔记之——徒手撕 Ajax（三）"
date: "Feb 17, 2022"
desc: "在上一年（过完年相当于去年……）的文章中，我们实现了“简陋版” Axios 的拦截器功能。这一次，我们来徒手看一看，取消请求该如何实现。"
---

在上一年（过完年相当于去年……）的文章中，我们实现了“简陋版” Axios 的拦截器功能。这一次，我们来徒手看一看，取消请求该如何实现。

通过前面的文章我们知道，Axios 实际上是封装了 XHR 来发起 Ajax 请求的。对于原生的 XHR，我们可以通过其自带的`abort()`方法来来执行取消的操作：

```js
const xhr = new XMLHttpRequest();
xhr.open("GET", "https://www.xxx.com/api");
xhr.send();

// 取消请求
xhr.abort();
```

而真正的 XHR 请求，则是被层层包裹，依次通过`request()`、`dispatchRequest()`、`xhrAdapter()`等方法，最终调用包裹在 Promise 中的`XMLHttpRequest()`方法。那么我们该怎样取消一个 Promise 呢？

我们知道，Promise 一共有三种状态：pending、fulfilled、rejected，后两者统称为“settled/resolved”。Promise 只能从默认的 pending 状态转为 fulfilled 或 rejected，又或者一直保持在 pending 状态中，无法被取消。虽然 Promise 无法手动取消，但我们可以通过调用`reject()`方法来强行改变其状态为 rejected，并在`reject()`方法中调用`xhr.abort()`方法，实现取消请求的效果。大致原理如下：

```js
let cancel;

const axios = new Promise((resolve, reject) => {
  cancel = reject; // 把 reject 方法暴露到外面
  setTimeout(() => {
    resolve("done");
  }, 3000);
});

axios
  .then((done) => {
    console.log(done); // 不会触发
  })
  .catch((err) => {
    console.error(err); // cancelled manually
  });

cancel("cancelled manually"); // 相当于调用了 reject()
```

Axios 正是通过该原理，利用`CancelToken`来改变 Promise 状态，从而取消其内部的 XHR 请求。Axios 的这套`CancelToken`的 API 则是来自于一套被撤回的 TC39 提案，有兴趣的可以看看[cancelable promises proposal](https://github.com/tc39/proposal-cancelable-promises)。
